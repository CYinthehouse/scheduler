<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Scheduler | KoreanLearnin</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Press Start 2P', cursive; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); min-height: 100vh; padding: 20px; color: #fff; font-size: 10px; }
        body::before { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; background: repeating-linear-gradient(0deg, rgba(0,0,0,0.1), rgba(0,0,0,0.1) 1px, transparent 1px, transparent 2px); z-index: 9999; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { margin-bottom: 20px; padding: 15px; background: rgba(0,0,0,0.5); border-radius: 10px; border: 3px solid #00ffff; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; box-shadow: 0 0 20px rgba(0,255,255,0.3); }
        .header h1 { font-size: 16px; color: #00ffff; text-shadow: 0 0 10px #00ffff; }
        .user-info { font-size: 8px; color: #39ff14; }
        .nav-tabs { display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px; border: 2px solid #ff00ff; }
        .nav-tab { padding: 12px 18px; background: rgba(255,0,255,0.2); color: #ff00ff; border: 2px solid #ff00ff; border-radius: 5px; cursor: pointer; font-family: 'Press Start 2P', cursive; font-size: 8px; transition: all 0.3s; }
        .nav-tab:hover { background: rgba(255,0,255,0.4); box-shadow: 0 0 15px rgba(255,0,255,0.5); }
        .nav-tab.active { background: #ff00ff; color: #000; box-shadow: 0 0 20px #ff00ff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background: rgba(0,0,0,0.7); padding: 20px; border-radius: 10px; border: 3px solid #00ffff; margin-bottom: 20px; box-shadow: 0 0 15px rgba(0,255,255,0.2); }
        .card h3 { font-size: 12px; margin-bottom: 15px; color: #00ffff; border-bottom: 2px solid #00ffff; padding-bottom: 10px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, rgba(255,0,255,0.3), rgba(0,255,255,0.3)); padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #fff; }
        .stat-card.green { border-color: #39ff14; }
        .stat-card.cyan { border-color: #00ffff; }
        .stat-card.pink { border-color: #ff00ff; }
        .stat-card.yellow { border-color: #ffff00; }
        .stat-card.orange { border-color: #ff6600; }
        .stat-number { font-size: 24px; margin-bottom: 10px; }
        .stat-label { font-size: 7px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-size: 9px; color: #ffff00; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #ff00ff; border-radius: 5px; font-family: 'Press Start 2P', cursive; font-size: 10px; background: rgba(0,0,0,0.5); color: #fff; }
        input:focus, select:focus { outline: none; border-color: #00ffff; box-shadow: 0 0 15px rgba(0,255,255,0.3); }
        select option { background: #1a1a2e; }
        .btn { padding: 12px 20px; border: 2px solid; border-radius: 5px; cursor: pointer; font-family: 'Press Start 2P', cursive; font-size: 8px; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); }
        .btn-primary { background: linear-gradient(135deg, #ff00ff, #cc00cc); color: #fff; border-color: #ff00ff; }
        .btn-success { background: linear-gradient(135deg, #39ff14, #2ecc40); color: #000; border-color: #39ff14; }
        .btn-info { background: linear-gradient(135deg, #00ffff, #00cccc); color: #000; border-color: #00ffff; }
        .btn-warning { background: linear-gradient(135deg, #ffff00, #cccc00); color: #000; border-color: #ffff00; }
        .btn-danger { background: linear-gradient(135deg, #ff3366, #cc0033); color: #fff; border-color: #ff3366; }
        .btn-sm { padding: 6px 12px; font-size: 7px; }
        .btn-block { width: 100%; }
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 8px; }
        th, td { padding: 10px; text-align: left; border: 1px solid #333; }
        th { background: rgba(255,0,255,0.3); color: #ff00ff; }
        tr:hover { background: rgba(0,255,255,0.1); }
        .level-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 7px; border: 2px solid; }
        .level-absolute { border-color: #ff00ff; color: #ff00ff; background: rgba(255,0,255,0.2); }
        .level-novice { border-color: #00ffff; color: #00ffff; background: rgba(0,255,255,0.2); }
        .level-beginner { border-color: #39ff14; color: #39ff14; background: rgba(57,255,20,0.2); }
        .level-advanced { border-color: #ffff00; color: #ffff00; background: rgba(255,255,0,0.2); }
        .status-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 7px; }
        .status-pending { background: rgba(255,255,0,0.2); color: #ffff00; }
        .status-assigned { background: rgba(57,255,20,0.2); color: #39ff14; }
        .status-limbo { background: rgba(255,51,102,0.2); color: #ff3366; }
        .status-proposed { background: rgba(0,255,255,0.2); color: #00ffff; }
        .availability-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .day-column { background: rgba(0,0,0,0.3); border: 2px solid #333; border-radius: 8px; padding: 15px; }
        .day-title { text-align: center; color: #39ff14; font-size: 10px; margin-bottom: 15px; }
        .time-slot { background: rgba(255,255,255,0.05); border: 2px solid #444; padding: 10px; margin-bottom: 8px; border-radius: 5px; cursor: pointer; text-align: center; font-size: 8px; position: relative; }
        .time-slot:hover { border-color: #00ffff; }
        .time-slot.selected-1 { border-color: #39ff14; background: rgba(57,255,20,0.2); }
        .time-slot.selected-2 { border-color: #ffff00; background: rgba(255,255,0,0.2); }
        .time-slot.selected-3 { border-color: #ff6600; background: rgba(255,102,0,0.2); }
        .rank-badge { position: absolute; top: -8px; right: -8px; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 8px; color: #000; }
        .time-slot.selected-1 .rank-badge { background: #39ff14; }
        .time-slot.selected-2 .rank-badge { background: #ffff00; }
        .time-slot.selected-3 .rank-badge { background: #ff6600; }
        .local-time { font-size: 7px; color: #888; margin-top: 5px; }
        .selection-legend { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 8px; }
        .legend-color { width: 20px; height: 20px; border: 2px solid; border-radius: 4px; }
        .legend-color.ideal { border-color: #39ff14; background: rgba(57,255,20,0.2); }
        .legend-color.second { border-color: #ffff00; background: rgba(255,255,0,0.2); }
        .legend-color.doable { border-color: #ff6600; background: rgba(255,102,0,0.2); }
        .class-card { background: rgba(0,0,0,0.5); border: 2px solid #00ffff; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .class-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px; }
        .class-time { color: #39ff14; font-size: 10px; }
        .class-day { color: #ffff00; font-size: 8px; }
        .student-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .student-chip { background: rgba(255,0,255,0.2); border: 1px solid #ff00ff; padding: 5px 10px; border-radius: 15px; font-size: 7px; display: flex; align-items: center; gap: 5px; }
        .rank-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .rank-dot.rank-1 { background: #39ff14; }
        .rank-dot.rank-2 { background: #ffff00; }
        .rank-dot.rank-3 { background: #ff6600; }
        .limbo-section { background: rgba(255,51,102,0.1); border: 2px dashed #ff3366; border-radius: 8px; padding: 20px; min-height: 100px; }
        .limbo-student { background: rgba(0,0,0,0.5); border: 2px solid #ff3366; border-radius: 8px; padding: 12px; margin-bottom: 10px; cursor: grab; }
        .drop-zone { border: 2px dashed #00ffff; border-radius: 8px; padding: 15px; text-align: center; margin-top: 10px; opacity: 0; transition: opacity 0.2s; font-size: 8px; color: #00ffff; }
        .drop-zone.active { opacity: 1; background: rgba(0,255,255,0.1); }
        .week-tracker { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .week-btn { padding: 10px 15px; background: rgba(0,0,0,0.3); border: 2px solid #444; border-radius: 5px; color: #888; font-family: 'Press Start 2P', cursive; font-size: 8px; cursor: pointer; }
        .week-btn.current { border-color: #39ff14; color: #39ff14; box-shadow: 0 0 10px rgba(57,255,20,0.3); }
        .week-btn.completed { border-color: #ff00ff; color: #ff00ff; }
        .attendance-btn { padding: 8px 12px; border: 2px solid; border-radius: 5px; background: transparent; font-family: 'Press Start 2P', cursive; font-size: 7px; cursor: pointer; }
        .attendance-btn.present { border-color: #39ff14; color: #39ff14; }
        .attendance-btn.present.active { background: #39ff14; color: #000; }
        .attendance-btn.late { border-color: #ffff00; color: #ffff00; }
        .attendance-btn.late.active { background: #ffff00; color: #000; }
        .attendance-btn.absent { border-color: #ff3366; color: #ff3366; }
        .attendance-btn.absent.active { background: #ff3366; color: #fff; }
        .teacher-card { background: rgba(0,0,0,0.5); border: 2px solid #39ff14; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .teacher-name { color: #39ff14; font-size: 10px; margin-bottom: 8px; }
        .teacher-classes { font-size: 7px; color: #888; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal-overlay.active { display: flex; }
        .modal { background: #1a1a2e; border: 3px solid #ff00ff; border-radius: 10px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; position: relative; }
        .modal-close { position: absolute; top: 10px; right: 15px; background: none; border: none; color: #ff3366; font-size: 20px; cursor: pointer; font-family: 'Press Start 2P', cursive; }
        .modal-title { color: #00ffff; font-size: 12px; margin-bottom: 20px; }
        #loginSection { max-width: 450px; margin: 50px auto; background: rgba(0,0,0,0.8); padding: 30px; border-radius: 10px; border: 3px solid #ff00ff; }
        #loginSection h2 { font-size: 14px; margin-bottom: 25px; color: #00ffff; text-align: center; }
        #mainPanel { display: none; }
        .role-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .role-tab { flex: 1; padding: 15px; background: rgba(255,0,255,0.2); border: 2px solid #ff00ff; border-radius: 5px; color: #ff00ff; font-family: 'Press Start 2P', cursive; font-size: 8px; cursor: pointer; text-align: center; }
        .role-tab.active { background: #ff00ff; color: #000; }
        .message { padding: 12px; border-radius: 5px; margin-bottom: 15px; font-size: 8px; }
        .message.success { background: rgba(57,255,20,0.2); border: 2px solid #39ff14; color: #39ff14; }
        .message.error { background: rgba(255,51,102,0.2); border: 2px solid #ff3366; color: #ff3366; }
        .success-screen { text-align: center; padding: 40px; }
        .success-icon { font-size: 60px; margin-bottom: 20px; }
        .assign-btn { padding: 6px 10px; background: transparent; border: 2px solid #39ff14; border-radius: 4px; color: #39ff14; font-family: 'Press Start 2P', cursive; font-size: 7px; cursor: pointer; }
        .assign-btn:hover { background: #39ff14; color: #000; }
        .checkbox-group { display: flex; gap: 15px; flex-wrap: wrap; }
        .checkbox-label { display: flex; align-items: center; gap: 8px; font-size: 8px; cursor: pointer; }
        .checkbox-label input { width: 18px; height: 18px; }
        .settings-row { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        .settings-label { color: #ffff00; font-size: 8px; min-width: 180px; }
        .settings-input { width: 100px; text-align: center; }
        .material-block { background: rgba(0,0,0,0.3); border: 2px solid #444; border-radius: 8px; padding: 15px; margin-bottom: 10px; cursor: grab; }
        .material-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .material-type { font-size: 7px; color: #ff00ff; text-transform: uppercase; }
        .material-content { font-size: 9px; line-height: 1.6; }
        .material-content img { max-width: 100%; border-radius: 5px; }
        .material-content a { color: #00ffff; }
        .history-present { color: #39ff14; }
        .history-late { color: #ffff00; }
        .history-absent { color: #ff3366; }
        
        /* Schedule Calendar Styles */
        .schedule-grid { display: grid; grid-template-columns: 100px repeat(2, 1fr); gap: 2px; background: #333; border: 2px solid #00ffff; border-radius: 8px; overflow: hidden; }
        .schedule-header { background: linear-gradient(135deg, #ff00ff, #cc00cc); color: #fff; padding: 12px 8px; text-align: center; font-size: 9px; font-weight: bold; }
        .schedule-time { background: rgba(0,255,255,0.2); color: #00ffff; padding: 10px 8px; text-align: center; font-size: 8px; display: flex; align-items: center; justify-content: center; }
        .schedule-cell { background: rgba(0,0,0,0.6); padding: 8px; min-height: 80px; transition: all 0.2s; position: relative; }
        .schedule-cell:hover { background: rgba(0,255,255,0.1); }
        .schedule-cell.has-class { border-left: 3px solid #39ff14; }
        .schedule-cell.empty { border-left: 3px solid #666; }
        .schedule-cell.needs-teacher { border-left: 3px solid #ffff00; }
        .schedule-cell.full { border-left: 3px solid #ff3366; }
        .schedule-class-block { background: rgba(57,255,20,0.15); border: 1px solid #39ff14; border-radius: 5px; padding: 8px; margin-bottom: 5px; }
        .schedule-class-block.no-teacher { background: rgba(255,255,0,0.15); border-color: #ffff00; }
        .schedule-class-block.full { background: rgba(255,51,102,0.15); border-color: #ff3366; }
        .schedule-class-level { font-size: 7px; color: #ff00ff; margin-bottom: 4px; }
        .schedule-class-info { font-size: 7px; color: #888; }
        .schedule-class-teacher { font-size: 7px; color: #39ff14; margin-top: 4px; }
        .schedule-class-students { font-size: 8px; color: #00ffff; font-weight: bold; }
        .schedule-legend { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 8px; }
        .legend-bar { width: 4px; height: 20px; border-radius: 2px; }
        .legend-bar.active { background: #39ff14; }
        .legend-bar.needs-teacher { background: #ffff00; }
        .legend-bar.full { background: #ff3366; }
        .legend-bar.empty { background: #666; }
        .schedule-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .summary-box { background: rgba(0,0,0,0.5); border: 2px solid; border-radius: 8px; padding: 15px; text-align: center; }
        .summary-box.total { border-color: #00ffff; }
        .summary-box.active { border-color: #39ff14; }
        .summary-box.needs-teacher { border-color: #ffff00; }
        .summary-box.full { border-color: #ff3366; }
        .summary-box.empty { border-color: #666; }
        .summary-box.available { border-color: #ff00ff; }
        .summary-number { font-size: 20px; margin-bottom: 5px; }
        .summary-label { font-size: 7px; color: #888; }
        
        /* Class Details Modal Styles */
        .student-detail-row { background: rgba(0,0,0,0.3); border: 1px solid #444; border-radius: 8px; padding: 12px; margin-bottom: 10px; }
        .student-detail-row.absent-student { border-color: #ff3366; background: rgba(255,51,102,0.1); }
        .student-detail-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; flex-wrap: wrap; gap: 10px; }
        .student-detail-name { color: #00ffff; font-size: 10px; }
        .student-detail-info { font-size: 8px; color: #888; margin-bottom: 5px; }
        .student-detail-phone { font-size: 9px; color: #39ff14; margin: 8px 0; padding: 8px; background: rgba(57,255,20,0.1); border-radius: 5px; display: none; }
        .student-detail-phone.visible { display: block; }
        .student-detail-phone a { color: #39ff14; text-decoration: none; }
        .student-detail-attendance { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 8px; }
        .attendance-week { padding: 4px 8px; border-radius: 4px; font-size: 7px; border: 1px solid #333; }
        .attendance-week.present { background: rgba(57,255,20,0.2); color: #39ff14; border-color: #39ff14; }
        .attendance-week.late { background: rgba(255,255,0,0.2); color: #ffff00; border-color: #ffff00; }
        .attendance-week.absent { background: rgba(255,51,102,0.2); color: #ff3366; border-color: #ff3366; }
        .contacted-row { margin-top: 10px; padding-top: 10px; border-top: 1px solid #333; display: none; }
        .contacted-row.visible { display: flex; align-items: center; gap: 10px; }
        .contacted-checkbox { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 8px; }
        .contacted-checkbox input { width: 18px; height: 18px; accent-color: #39ff14; }
        .absence-reason-display { font-size: 8px; color: #ff9900; margin-top: 5px; padding: 5px; background: rgba(255,153,0,0.1); border-radius: 4px; }
        
        /* Absence List Styles */
        .absence-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; margin-bottom: 8px; border-radius: 8px; border-left: 4px solid; transition: all 0.2s; }
        .absence-item:hover { transform: translateX(5px); }
        .absence-item.contacted { background: rgba(57,255,20,0.1); border-color: #39ff14; }
        .absence-item.not-contacted { background: rgba(255,51,102,0.1); border-color: #ff3366; }
        .absence-item-info { flex: 1; }
        .absence-item-name { color: #00ffff; font-size: 10px; margin-bottom: 5px; }
        .absence-item-details { font-size: 8px; color: #888; }
        .absence-item-class { font-size: 8px; color: #ffff00; margin-top: 3px; }
        .absence-item-reason { font-size: 8px; color: #ff9900; margin-top: 5px; padding: 5px 8px; background: rgba(255,153,0,0.1); border-radius: 4px; display: inline-block; }
        .absence-item-phone { font-size: 9px; margin-top: 5px; }
        .absence-item-phone a { color: #39ff14; text-decoration: none; }
        .absence-item-status { display: flex; flex-direction: column; align-items: flex-end; gap: 5px; }
        .absence-status-badge { padding: 5px 10px; border-radius: 5px; font-size: 8px; font-weight: bold; }
        .absence-status-badge.contacted { background: rgba(57,255,20,0.3); color: #39ff14; }
        .absence-status-badge.not-contacted { background: rgba(255,51,102,0.3); color: #ff3366; }
        .absence-week-badge { background: rgba(255,255,255,0.1); padding: 3px 8px; border-radius: 4px; font-size: 7px; color: #888; }
        
        /* Limbo Student Availability Tags */
        .limbo-availability { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; }
        .avail-tag { padding: 4px 8px; border-radius: 4px; font-size: 7px; border: 2px solid; }
        .avail-tag.pref-1 { background: rgba(57,255,20,0.2); border-color: #39ff14; color: #39ff14; }
        .avail-tag.pref-2 { background: rgba(255,255,0,0.2); border-color: #ffff00; color: #ffff00; }
        .avail-tag.pref-3 { background: rgba(255,102,0,0.2); border-color: #ff6600; color: #ff6600; }
        
        /* Clickable schedule cell */
        .schedule-class-block.clickable { cursor: pointer; transition: all 0.2s; }
        .schedule-class-block.clickable:hover { transform: scale(1.02); box-shadow: 0 0 10px rgba(0,255,255,0.3); }
        
        /* Course Calendar Styles */
        .week-date-card { background: rgba(0,0,0,0.4); border: 2px solid #444; border-radius: 8px; padding: 12px; text-align: center; transition: all 0.2s; }
        .week-date-card:hover { border-color: #00ffff; }
        .week-date-card.current { border-color: #39ff14; background: rgba(57,255,20,0.1); }
        .week-date-card.past { opacity: 0.5; }
        .week-date-card.future { border-color: #666; }
        .week-date-number { font-size: 14px; color: #00ffff; margin-bottom: 5px; }
        .week-date-card.current .week-date-number { color: #39ff14; }
        .week-date-range { font-size: 8px; color: #ffff00; margin-bottom: 5px; }
        .week-date-status { font-size: 7px; color: #888; }
        .week-date-card.current .week-date-status { color: #39ff14; }
        .course-dates-summary { background: rgba(0,0,0,0.3); border: 1px solid #333; border-radius: 8px; padding: 15px; margin-bottom: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .course-date-item { text-align: center; }
        .course-date-label { font-size: 7px; color: #888; margin-bottom: 5px; }
        .course-date-value { font-size: 10px; color: #00ffff; }
        .course-date-value.end { color: #ff00ff; }
        
        /* Monthly Calendar */
        .monthly-calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .calendar-header { background: rgba(0,0,0,0.5); color: #00ffff; padding: 10px 5px; text-align: center; font-size: 8px; }
        .calendar-day { background: rgba(0,0,0,0.3); border: 1px solid #333; min-height: 80px; padding: 5px; position: relative; transition: all 0.2s; }
        .calendar-day:hover { border-color: #00ffff; }
        .calendar-day.other-month { opacity: 0.3; }
        .calendar-day.today { border-color: #00ffff; box-shadow: 0 0 10px rgba(0,255,255,0.3); }
        .calendar-day.course-start, .calendar-day.course-end { border-color: #ff00ff; }
        .calendar-day-number { font-size: 10px; color: #fff; margin-bottom: 5px; }
        .calendar-day.today .calendar-day-number { color: #00ffff; font-weight: bold; }
        .calendar-day.has-class { background: rgba(57,255,20,0.1); }
        .calendar-class-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin: 1px; cursor: pointer; }
        .calendar-class-info { font-size: 6px; color: #888; margin-top: 3px; }
        .calendar-week-label { position: absolute; top: 5px; right: 5px; font-size: 6px; color: #666; }
        .calendar-day.has-class { cursor: pointer; }
        .calendar-day.has-class:hover { background: rgba(57,255,20,0.2); }
        
        /* Date Option Buttons */
        .date-option { padding: 12px; border: 2px solid #333; border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: center; background: rgba(0,0,0,0.3); }
        .date-option:hover { border-color: #00ffff; background: rgba(0,255,255,0.1); }
        .date-option.selected { border-color: #39ff14; background: rgba(57,255,20,0.2); }
        .date-option-day { font-size: 10px; color: #00ffff; margin-bottom: 3px; }
        .date-option-date { font-size: 8px; color: #ffff00; }
        .date-option-end { font-size: 7px; color: #888; margin-top: 5px; }
        
        /* Completed Students */
        .completed-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; margin-bottom: 8px; border-radius: 8px; border-left: 4px solid; }
        .completed-item.joined { background: rgba(57,255,20,0.1); border-color: #39ff14; }
        .completed-item.not-interested { background: rgba(255,51,102,0.1); border-color: #ff3366; }
        .completed-item.pending { background: rgba(255,255,0,0.1); border-color: #ffff00; }
        .completed-item-info { flex: 1; }
        .completed-item-name { color: #00ffff; font-size: 10px; margin-bottom: 5px; }
        .completed-item-details { font-size: 8px; color: #888; }
        .completed-item-class { font-size: 8px; color: #ffff00; margin-top: 3px; }
        .completed-item-actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .community-btn { padding: 8px 12px; border-radius: 5px; font-size: 8px; font-family: 'Press Start 2P', cursive; cursor: pointer; border: none; transition: all 0.2s; }
        .community-btn.join { background: #39ff14; color: #000; }
        .community-btn.not-interested { background: #ff3366; color: #fff; }
        .community-btn:hover { transform: scale(1.05); }
        .community-status { padding: 5px 10px; border-radius: 5px; font-size: 8px; }
        .community-status.joined { background: rgba(57,255,20,0.3); color: #39ff14; }
        .community-status.not-interested { background: rgba(255,51,102,0.3); color: #ff3366; }
        
        /* Move Student Modal */
        .move-student-class { padding: 10px; margin: 5px 0; border: 2px solid #333; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .move-student-class:hover { border-color: #00ffff; background: rgba(0,255,255,0.1); }
        .move-student-class.selected { border-color: #39ff14; background: rgba(57,255,20,0.1); }
        
        /* Calendar Class Picker */
        .calendar-class-option:hover { border-color: #39ff14 !important; background: rgba(57,255,20,0.2) !important; transform: scale(1.02); }
        
        /* Video Recording */
        .recording-section { background: rgba(0,0,0,0.3); border: 2px solid #ff3366; border-radius: 10px; padding: 15px; margin: 15px 0; }
        .recording-section.recording { border-color: #ff0000; animation: pulse-border 1s infinite; }
        @keyframes pulse-border { 0%, 100% { border-color: #ff0000; } 50% { border-color: #ff6666; } }
        .record-btn { padding: 15px 25px; font-size: 10px; border-radius: 50px; cursor: pointer; transition: all 0.2s; font-family: 'Press Start 2P', cursive; }
        .record-btn.start { background: #ff3366; color: #fff; border: none; }
        .record-btn.start:hover { background: #ff0044; transform: scale(1.05); }
        .record-btn.recording { background: #ff0000; color: #fff; border: none; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .video-preview { width: 100%; max-width: 400px; border-radius: 8px; background: #000; margin: 10px auto; display: block; }
        .korean-passage { background: rgba(255,255,0,0.1); border: 2px solid #ffff00; border-radius: 8px; padding: 15px; margin: 10px 0; font-size: 12px; line-height: 1.8; color: #fff; }
        
        /* Priority Buttons */
        .priority-btn { padding: 10px 15px; font-size: 8px; border-radius: 8px; cursor: pointer; transition: all 0.2s; font-family: 'Press Start 2P', cursive; background: #1a1a2e; color: #888; border: 2px solid #333; }
        .priority-btn:hover { border-color: #666; }
        .priority-btn.selected { transform: scale(1.05); }
        .priority-btn.selected#priorityHigh { background: rgba(255,0,0,0.2); border-color: #ff0000; color: #ff0000; }
        .priority-btn.selected#priorityMid { background: rgba(255,255,0,0.2); border-color: #ffff00; color: #ffff00; }
        .priority-btn.selected#priorityLow { background: rgba(57,255,20,0.2); border-color: #39ff14; color: #39ff14; }
        
        /* Suggestion Cards */
        .suggestion-card { background: rgba(0,0,0,0.3); border: 2px solid #333; border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .suggestion-card.priority-high { border-left: 4px solid #ff0000; }
        .suggestion-card.priority-mid { border-left: 4px solid #ffff00; }
        .suggestion-card.priority-low { border-left: 4px solid #39ff14; }
        .suggestion-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .suggestion-title { color: #00ffff; font-size: 10px; flex: 1; }
        .suggestion-priority { padding: 3px 8px; border-radius: 4px; font-size: 7px; }
        .suggestion-priority.high { background: rgba(255,0,0,0.3); color: #ff0000; }
        .suggestion-priority.mid { background: rgba(255,255,0,0.3); color: #ffff00; }
        .suggestion-priority.low { background: rgba(57,255,20,0.3); color: #39ff14; }
        .suggestion-body { font-size: 8px; color: #ccc; margin-bottom: 10px; line-height: 1.6; }
        .suggestion-meta { font-size: 7px; color: #666; display: flex; justify-content: space-between; align-items: center; }
        .suggestion-status { padding: 3px 8px; border-radius: 4px; font-size: 7px; }
        .suggestion-status.pending { background: rgba(255,255,0,0.2); color: #ffff00; }
        .suggestion-status.approved { background: rgba(57,255,20,0.2); color: #39ff14; }
        .suggestion-status.declined { background: rgba(255,51,102,0.2); color: #ff3366; }
        .suggestion-actions { display: flex; gap: 8px; margin-top: 10px; }
        
        /* Proposals Layout */
        .proposals-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .proposals-left, .proposals-right { min-width: 0; }
        @media (max-width: 1024px) { .proposals-layout { grid-template-columns: 1fr; } }
        
        /* Proposal Card */
        .proposal-card { background: rgba(0,0,0,0.3); border: 2px solid #333; border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .proposal-card.status-draft { border-left: 4px solid #888; }
        .proposal-card.status-sent { border-left: 4px solid #ffff00; }
        .proposal-card.status-all_agreed { border-left: 4px solid #39ff14; }
        .proposal-card.status-has_rejections { border-left: 4px solid #ff3366; }
        .proposal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .proposal-info { flex: 1; }
        .proposal-day { color: #00ffff; font-size: 12px; }
        .proposal-time { color: #888; font-size: 9px; }
        .proposal-status { padding: 3px 8px; border-radius: 4px; font-size: 7px; }
        .proposal-status.draft { background: rgba(136,136,136,0.3); color: #888; }
        .proposal-status.sent { background: rgba(255,255,0,0.3); color: #ffff00; }
        .proposal-status.all_agreed { background: rgba(57,255,20,0.3); color: #39ff14; }
        .proposal-status.has_rejections { background: rgba(255,51,102,0.3); color: #ff3366; }
        .proposal-students { margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 5px; min-height: 60px; }
        .proposal-students.drag-over { border: 2px dashed #00ffff; background: rgba(0,255,255,0.1); }
        .proposal-student { display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 5px 0; background: rgba(0,0,0,0.3); border-radius: 5px; border: 1px solid #333; }
        .proposal-student-name { font-size: 8px; color: #fff; }
        .proposal-student-response { font-size: 7px; padding: 2px 6px; border-radius: 3px; }
        .proposal-student-response.pending { background: rgba(255,255,0,0.2); color: #ffff00; }
        .proposal-student-response.agreed { background: rgba(57,255,20,0.2); color: #39ff14; }
        .proposal-student-response.rejected { background: rgba(255,51,102,0.2); color: #ff3366; }
        .proposal-date-picker { margin: 10px 0; padding: 10px; background: rgba(255,255,0,0.1); border: 1px solid #ffff00; border-radius: 5px; }
        .proposal-actions { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
        
        /* Available Students for Drag */
        .available-student { padding: 10px; margin: 5px 0; background: rgba(0,0,0,0.3); border: 2px solid #333; border-radius: 8px; cursor: grab; transition: all 0.2s; }
        .available-student:hover { border-color: #00ffff; background: rgba(0,255,255,0.1); }
        .available-student.dragging { opacity: 0.5; cursor: grabbing; }
        .available-student.rainbow-fit { animation: rainbow-border 2s linear infinite; }
        @keyframes rainbow-border {
            0% { border-color: #ff0000; box-shadow: 0 0 10px #ff0000; }
            17% { border-color: #ff9900; box-shadow: 0 0 10px #ff9900; }
            33% { border-color: #ffff00; box-shadow: 0 0 10px #ffff00; }
            50% { border-color: #39ff14; box-shadow: 0 0 10px #39ff14; }
            67% { border-color: #00ffff; box-shadow: 0 0 10px #00ffff; }
            83% { border-color: #ff00ff; box-shadow: 0 0 10px #ff00ff; }
            100% { border-color: #ff0000; box-shadow: 0 0 10px #ff0000; }
        }
        .available-student-name { font-size: 9px; color: #fff; margin-bottom: 3px; }
        .available-student-info { font-size: 7px; color: #888; }
        
        /* Date Picker Modal */
        .date-picker-modal { text-align: center; }
        .date-picker-modal input[type="date"] { font-family: 'Press Start 2P', cursive; font-size: 10px; padding: 10px; background: #1a1a2e; color: #00ffff; border: 2px solid #00ffff; border-radius: 5px; }
        
        /* Class Preview Cards */
        .class-preview-card { background: rgba(0,0,0,0.3); border: 2px solid #333; border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .class-preview-card.has-date { border-color: #39ff14; }
        .class-preview-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .class-preview-info { color: #00ffff; font-size: 11px; }
        .class-preview-students { display: flex; flex-wrap: wrap; gap: 5px; margin: 10px 0; }
        .class-preview-student { padding: 5px 10px; background: rgba(0,255,255,0.1); border: 1px solid #00ffff; border-radius: 15px; font-size: 7px; color: #fff; }
        .class-preview-date { display: flex; align-items: center; gap: 10px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #333; }
        .class-preview-date label { font-size: 8px; color: #ffff00; }
        .class-preview-date input[type="date"] { font-family: 'Press Start 2P', cursive; font-size: 8px; padding: 8px; background: #1a1a2e; color: #00ffff; border: 2px solid #00ffff; border-radius: 5px; flex: 1; }
        .class-preview-date.selected input { border-color: #39ff14; color: #39ff14; }
        .saturday-quick-btns { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; }
        .saturday-quick-btn { padding: 5px 8px; font-size: 6px; background: rgba(255,255,0,0.1); border: 1px solid #ffff00; color: #ffff00; border-radius: 4px; cursor: pointer; font-family: 'Press Start 2P', cursive; }
        .saturday-quick-btn:hover { background: rgba(255,255,0,0.3); }
        .saturday-quick-btn.selected { background: rgba(57,255,20,0.3); border-color: #39ff14; color: #39ff14; }
        
        @media (max-width: 768px) { .header h1 { font-size: 12px; } .grid-2 { grid-template-columns: 1fr; } .availability-grid { grid-template-columns: 1fr; } .schedule-grid { grid-template-columns: 60px repeat(2, 1fr); } .schedule-header, .schedule-time { font-size: 7px; padding: 8px 4px; } #courseCalendarGrid { grid-template-columns: repeat(2, 1fr); } .monthly-calendar { grid-template-columns: repeat(7, 1fr); } .calendar-day { min-height: 50px; } }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Section -->
        <div id="loginSection">
            <h2>üéÆ CLASS SCHEDULER</h2>
            <div class="role-tabs">
                <button class="role-tab active" onclick="switchRole('student')">üìù STUDENT</button>
                <button class="role-tab" onclick="switchRole('admin')">‚öôÔ∏è ADMIN</button>
                <button class="role-tab" onclick="switchRole('teacher')">üë®‚Äçüè´ TEACHER</button>
            </div>

            <!-- Student Registration -->
            <div id="studentLoginForm">
                <div id="studentRegMessage"></div>
                <div class="form-group"><label>Full Name</label><input type="text" id="studentName" placeholder="Enter your name"></div>
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="studentEmail" placeholder="Enter your email" onblur="validateEmail()">
                    <p id="emailError" style="color: #ff3366; font-size: 7px; margin-top: 5px; display: none;"></p>
                </div>
                <div class="form-group">
                    <label>Phone Number <span style="color: #888; font-size: 7px;">(For class alerts only)</span></label>
                    <input type="tel" id="studentPhone" placeholder="Your phone number">
                </div>
                <div class="form-group">
                    <label>Discord Username <span style="color: #888; font-size: 7px;">(For class communication)</span></label>
                    <input type="text" id="studentDiscord" placeholder="e.g. username#1234 or username">
                </div>
                <div class="form-group">
                    <label>Country</label>
                    <select id="studentCountry" onchange="onCountryChange()">
                        <option value="">Select your country</option>
                        <option value="US">United States</option>
                        <option value="CA">Canada</option>
                        <option value="GB">United Kingdom</option>
                        <option value="AU">Australia</option>
                        <option value="KR">South Korea</option>
                        <option value="JP">Japan</option>
                        <option value="DE">Germany</option>
                        <option value="FR">France</option>
                        <option value="OTHER">Other</option>
                    </select>
                </div>
                <div id="locationFields" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group" id="cityGroup">
                            <label>City</label>
                            <input type="text" id="studentCity" placeholder="Your city">
                        </div>
                        <div class="form-group" id="stateGroup">
                            <label id="stateLabel">State/Province</label>
                            <input type="text" id="studentState" list="stateList" placeholder="Start typing..." onchange="onStateChange()">
                            <datalist id="stateList"></datalist>
                        </div>
                    </div>
                </div>
                <div class="form-group" id="splitTimezoneGroup" style="display: none;">
                    <label id="splitTimezoneLabel">Your Timezone</label>
                    <p style="font-size: 7px; color: #ff9900; margin-bottom: 8px;">Your state spans multiple timezones. Please select yours:</p>
                    <select id="splitTimezoneSelect">
                    </select>
                </div>
                <div class="form-group" id="timezoneGroup" style="display: none;">
                    <label>Your Timezone</label>
                    <select id="studentTimezone">
                        <option value="America/New_York">Eastern Time (ET)</option>
                        <option value="America/Chicago">Central Time (CT)</option>
                        <option value="America/Denver">Mountain Time (MT)</option>
                        <option value="America/Los_Angeles">Pacific Time (PT)</option>
                        <option value="America/Anchorage">Alaska Time (AKT)</option>
                        <option value="Pacific/Honolulu">Hawaii Time (HST)</option>
                        <option value="Europe/London">London (GMT/BST)</option>
                        <option value="Europe/Paris">Paris/Berlin (CET)</option>
                        <option value="Asia/Seoul">Seoul (KST)</option>
                        <option value="Asia/Tokyo">Tokyo (JST)</option>
                        <option value="Australia/Sydney">Sydney (AEST)</option>
                        <option value="Australia/Perth">Perth (AWST)</option>
                    </select>
                </div>
                <div class="card" style="margin-top: 20px;">
                    <h3>üé§ Pronunciation Recording</h3>
                    <p style="font-size: 8px; margin-bottom: 15px; color: #888;">This helps us determine your level. Record yourself reading the passage below.</p>
                    
                    <div style="background: rgba(255,255,0,0.1); border: 2px solid #ffff00; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <p style="font-size: 8px; color: #ffff00; margin-bottom: 10px;">üìñ Read this Korean passage:</p>
                        <p class="korean-passage" style="font-size: 11px; line-height: 2; color: #fff;">"Ìô©ÌòºÏù¥ Ïßà Î¨¥Î†µ, ÎÇ°ÏùÄ ÏïÑÌååÌä∏ Îã®ÏßÄ ÎÜÄÏù¥ÌÑ∞ Î≤§ÏπòÏóêÎäî Ïñ∏Ï†úÎÇò Í∞ôÏùÄ ÌíçÍ≤ΩÏù¥ ÌéºÏ≥êÏ°åÎã§. Ïù¥Î¶Ñ Î™®Î•º Ï§ëÎÖÑ ÎÇ®ÏûêÍ∞Ä ÎÇ°ÏùÄ Ïô∏Ìà¨Î•º Ïó¨ÎØ∏Í≥† ÏïâÏïÑ ÏûàÏóàÍ≥†, Í∑∏Ïùò Î∞úÏπòÏóêÎäî Î≥µÏä¨Î≥µÏä¨Ìïú Ìù∞ÏÉâ ÎØπÏä§Í≤¨ 'ÎßàÎ£®'Í∞Ä ÏñåÏ†ÑÌûà Í∏∞ÎåÄÏñ¥ ÏûàÏóàÎã§. ÎÇ®ÏûêÏùò ÏÇ∂ÏùÄ Ï°∞Ïö©ÌïòÍ≥†, ÎïåÎ°úÎäî Ï†ÅÎßâÌñàÎã§. Í∞ÄÏ°±Í≥ºÏùò Ïó∞ÎùΩÏùÄ ÎÅäÏñ¥ÏßÑ ÏßÄ Ïò§ÎûòÏòÄÍ≥†, ÏùÄÌá¥ ÌõÑ Í∑∏Ïùò ÏÑ∏ÏÉÅÏùÄ Ïù¥ Î≤§Ïπò ÌÅ¨Í∏∞ÎßåÌÅº Ï§ÑÏñ¥Îì† ÎìØÌñàÎã§."</p>
                        <div style="margin-top: 15px; padding: 15px; background: rgba(255,51,102,0.2); border: 2px solid #ff3366; border-radius: 8px;">
                            <p style="font-size: 10px; color: #ff3366; margin-bottom: 5px;">‚ö†Ô∏è If you cannot read Korean, say:</p>
                            <p style="font-size: 16px; color: #00ffff; font-weight: bold; text-align: center;">"I do not know how to read Korean"</p>
                        </div>
                    </div>
                    
                    <div class="recording-section" id="recordingSection">
                        <p style="font-size: 8px; color: #888; margin-bottom: 10px;">üìπ Instructions: Click the button to start recording. Click again to stop. Maximum 1 minute.</p>
                        <div style="text-align: center;">
                            <video id="videoPreview" class="video-preview" autoplay muted playsinline style="display: none;"></video>
                            <video id="videoPlayback" class="video-preview" controls style="display: none;"></video>
                            <div style="margin: 15px 0;">
                                <button class="record-btn start" id="recordBtn" onclick="toggleRecording()">
                                    üé§ START RECORDING
                                </button>
                            </div>
                            <p id="recordingStatus" style="font-size: 8px; color: #888;"></p>
                            <div id="recordingTimer" style="font-size: 14px; color: #ff3366; display: none;">00:00 / 01:00</div>
                        </div>
                    </div>
                    <input type="hidden" id="studentVideoUrl">
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h3>üìÖ Select Your Availability</h3>
                    <p style="font-size: 8px; margin-bottom: 15px; color: #888;">Click to select 3 preferences. Times shown in EST.</p>
                    <div class="selection-legend">
                        <div class="legend-item"><div class="legend-color ideal"></div><span>1st: Ideal</span></div>
                        <div class="legend-item"><div class="legend-color second"></div><span>2nd: Second</span></div>
                        <div class="legend-item"><div class="legend-color doable"></div><span>3rd: Doable</span></div>
                    </div>
                    <div class="availability-grid" id="availabilityGrid"></div>
                </div>
                <button class="btn btn-success btn-block" onclick="submitStudentRegistration()" style="margin-top: 20px;">üöÄ SUBMIT REGISTRATION</button>
            </div>

            <!-- Student Success -->
            <div id="studentSuccessScreen" style="display: none;">
                <div class="success-screen">
                    <div class="success-icon">‚úÖ</div>
                    <h3 style="color: #39ff14; margin-bottom: 15px;">REGISTRATION COMPLETE!</h3>
                    <p style="font-size: 8px; margin-bottom: 20px; color: #888;">You will receive an email with your class assignment soon.</p>
                    <button class="btn btn-info" onclick="resetStudentForm()">Register Another Student</button>
                </div>
            </div>

            <!-- Admin Login -->
            <div id="adminLoginForm" style="display: none;">
                <div id="adminLoginMessage"></div>
                <div class="form-group"><label>Admin Email</label><input type="email" id="adminEmail" placeholder="Enter admin email"></div>
                <div class="form-group"><label>Password</label><input type="password" id="adminPassword" placeholder="Enter password"></div>
                <button class="btn btn-primary btn-block" onclick="adminLogin()">üîì LOGIN AS ADMIN</button>
            </div>

            <!-- Teacher Login -->
            <div id="teacherLoginForm" style="display: none;">
                <div id="teacherLoginMessage"></div>
                <div class="form-group"><label>Teacher Email</label><input type="email" id="teacherEmail" placeholder="Enter teacher email"></div>
                <div class="form-group"><label>Password</label><input type="password" id="teacherPassword" placeholder="Enter password"></div>
                <button class="btn btn-success btn-block" onclick="teacherLogin()">üîì LOGIN AS TEACHER</button>
            </div>
        </div>

        <!-- Main Panel -->
        <div id="mainPanel">
            <div class="header">
                <h1>üéÆ CLASS SCHEDULER</h1>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span class="user-info" id="userInfoDisplay"></span>
                    <button class="btn btn-danger btn-sm" onclick="logout()">LOGOUT</button>
                </div>
            </div>

            <!-- Admin Dashboard -->
            <div id="adminDashboard" style="display: none;">
                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="showAdminTab('dashboard')">üìä Dashboard</button>
                    <button class="nav-tab" onclick="showAdminTab('calendar')">üóìÔ∏è Calendar</button>
                    <button class="nav-tab" onclick="showAdminTab('schedule')">üìÖ Schedule</button>
                    <button class="nav-tab" onclick="showAdminTab('students')">üìã Students</button>
                    <button class="nav-tab" onclick="showAdminTab('proposals')">üìù Proposals</button>
                    <button class="nav-tab" onclick="showAdminTab('classes')">üìö Classes</button>
                    <button class="nav-tab" onclick="showAdminTab('attendance')">üìä Attendance</button>
                    <button class="nav-tab" onclick="showAdminTab('absences')">üö´ Absences</button>
                    <button class="nav-tab" onclick="showAdminTab('completed')">üéì Completed</button>
                    <button class="nav-tab" onclick="showAdminTab('teachers')">üë®‚Äçüè´ Teachers</button>
                    <button class="nav-tab" onclick="showAdminTab('materials')">üìñ Materials</button>
                    <button class="nav-tab" onclick="showAdminTab('suggestions')">üí° Suggestions</button>
                    <button class="nav-tab" onclick="showAdminTab('settings')">‚öôÔ∏è Settings</button>
                </div>

                <div id="adminTabDashboard" class="tab-content active">
                    <div class="stats-grid">
                        <div class="stat-card cyan"><div class="stat-number" id="statTotalStudents">0</div><div class="stat-label">TOTAL STUDENTS</div></div>
                        <div class="stat-card green"><div class="stat-number" id="statAssignedStudents">0</div><div class="stat-label">ASSIGNED</div></div>
                        <div class="stat-card yellow"><div class="stat-number" id="statPendingStudents">0</div><div class="stat-label">PENDING LEVEL</div></div>
                        <div class="stat-card orange"><div class="stat-number" id="statLimboStudents">0</div><div class="stat-label">IN LIMBO</div></div>
                        <div class="stat-card pink"><div class="stat-number" id="statTotalClasses">0</div><div class="stat-label">CLASSES</div></div>
                    </div>
                    <div class="card"><h3>üìÖ Current Week</h3><div class="week-tracker" id="dashboardWeekTracker"></div></div>
                </div>

                <!-- Calendar Tab -->
                <div id="adminTabCalendar" class="tab-content">
                    <div class="card">
                        <h3>üóìÔ∏è Monthly Calendar</h3>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <button class="btn btn-info" onclick="changeCalendarMonth(-1)">‚óÄ Prev</button>
                            <span id="calendarMonthLabel" style="font-size: 12px; color: #00ffff;"></span>
                            <button class="btn btn-info" onclick="changeCalendarMonth(1)">Next ‚ñ∂</button>
                        </div>
                        <div class="monthly-calendar" id="monthlyCalendarGrid"></div>
                        
                        <!-- Legend -->
                        <div class="schedule-legend" style="margin-top: 15px;">
                            <div class="legend-item"><div class="legend-bar" style="background: #39ff14;"></div><span>Class Day</span></div>
                            <div class="legend-item"><div class="legend-bar" style="background: #00ffff;"></div><span>Today</span></div>
                            <div class="legend-item"><div class="legend-bar" style="background: #ff00ff;"></div><span>Course Start/End</span></div>
                        </div>
                    </div>
                </div>

                <!-- Schedule Tab -->
                <div id="adminTabSchedule" class="tab-content">
                    <div class="card">
                        <h3>üìÖ Weekly Schedule Overview</h3>
                        
                        <!-- Summary Stats -->
                        <div class="schedule-summary" id="adminScheduleSummary">
                            <div class="summary-box total"><div class="summary-number" id="schedTotalSlots">16</div><div class="summary-label">TOTAL SLOTS</div></div>
                            <div class="summary-box active"><div class="summary-number" id="schedActiveClasses">0</div><div class="summary-label">ACTIVE CLASSES</div></div>
                            <div class="summary-box needs-teacher"><div class="summary-number" id="schedNeedsTeacher">0</div><div class="summary-label">NEED TEACHER</div></div>
                            <div class="summary-box full"><div class="summary-number" id="schedFullClasses">0</div><div class="summary-label">FULL CLASSES</div></div>
                            <div class="summary-box empty"><div class="summary-number" id="schedEmptySlots">16</div><div class="summary-label">EMPTY SLOTS</div></div>
                            <div class="summary-box available"><div class="summary-number" id="schedAvailableSpots">0</div><div class="summary-label">SPOTS AVAILABLE</div></div>
                        </div>
                        
                        <!-- Legend -->
                        <div class="schedule-legend">
                            <div class="legend-item"><div class="legend-bar active"></div><span>Active (has teacher)</span></div>
                            <div class="legend-item"><div class="legend-bar needs-teacher"></div><span>Needs Teacher</span></div>
                            <div class="legend-item"><div class="legend-bar full"></div><span>Full (max students)</span></div>
                            <div class="legend-item"><div class="legend-bar empty"></div><span>Empty Slot</span></div>
                        </div>
                        
                        <!-- Schedule Grid -->
                        <div class="schedule-grid" id="adminScheduleGrid">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <div id="adminTabStudents" class="tab-content">
                    <div class="card">
                        <h3>üìã Registered Students</h3>
                        <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-info" onclick="loadAllStudents()">üîÑ Refresh Students</button>
                            <button class="btn btn-success" onclick="autoGenerateClasses()">ü§ñ Auto-Generate Classes</button>
                        </div>
                        <div style="overflow-x: auto;"><table><thead><tr><th>Name</th><th>Email</th><th>Location</th><th>Timezone</th><th>Video</th><th>Level</th><th>Status</th><th>Actions</th></tr></thead><tbody id="studentsTableBody"><tr><td colspan="8" style="text-align: center; color: #888;">Loading...</td></tr></tbody></table></div>
                    </div>
                </div>

                <!-- Proposals Tab -->
                <div id="adminTabProposals" class="tab-content">
                    <div class="proposals-layout">
                        <!-- Left Side - Proposed Classes -->
                        <div class="proposals-left">
                            <div class="card">
                                <h3>üìù Proposed Classes</h3>
                                <p style="font-size: 8px; color: #888; margin-bottom: 15px;">Review and manage class proposals before finalizing.</p>
                                <div id="proposalsContainer"><p style="color: #888; font-size: 8px;">No proposals yet. Use "Auto-Generate Classes" to create proposals.</p></div>
                            </div>
                        </div>
                        
                        <!-- Right Side - Available Students -->
                        <div class="proposals-right">
                            <div class="card">
                                <h3>üë• Available Students</h3>
                                <p style="font-size: 8px; color: #888; margin-bottom: 15px;">Drag students into proposed classes. <span style="color: #ff00ff;">üåà Rainbow = good fit</span></p>
                                <div id="availableStudentsForProposals"><p style="color: #888; font-size: 8px;">No available students.</p></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="adminTabClasses" class="tab-content">
                    <div class="card"><h3>üìÖ Week Tracker</h3><div class="week-tracker" id="classesWeekTracker"></div></div>
                    <div class="grid-2">
                        <div class="card"><h3>üìö Generated Classes</h3><div id="classesContainer"><p style="color: #888; font-size: 8px;">No classes yet.</p></div></div>
                        <div class="card"><h3 style="color: #ff3366; border-color: #ff3366;">‚ö†Ô∏è Limbo Students</h3><div class="limbo-section" id="limboContainer"><p style="color: #888; font-size: 8px;">No students in limbo.</p></div></div>
                    </div>
                </div>

                <!-- Admin Attendance Tab -->
                <div id="adminTabAttendance" class="tab-content">
                    <div class="card">
                        <h3>üìä Attendance Overview</h3>
                        <p style="font-size: 8px; color: #888; margin-bottom: 15px;">View and manage attendance for all classes.</p>
                        
                        <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                            <button class="btn btn-info" onclick="loadAdminAttendance()">üîÑ Refresh</button>
                            <div class="form-group" style="margin: 0;">
                                <select id="adminAttendanceClassFilter" onchange="loadAdminAttendance()" style="padding: 8px; font-size: 8px;">
                                    <option value="all">All Classes</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Attendance Stats -->
                        <div class="schedule-summary" style="margin-bottom: 20px;">
                            <div class="summary-box" style="border-color: #39ff14;"><div class="summary-number" id="adminAttendancePresent" style="color: #39ff14;">0</div><div class="summary-label">PRESENT</div></div>
                            <div class="summary-box" style="border-color: #ffff00;"><div class="summary-number" id="adminAttendanceLate" style="color: #ffff00;">0</div><div class="summary-label">LATE</div></div>
                            <div class="summary-box" style="border-color: #ff3366;"><div class="summary-number" id="adminAttendanceAbsent" style="color: #ff3366;">0</div><div class="summary-label">ABSENT</div></div>
                            <div class="summary-box" style="border-color: #888;"><div class="summary-number" id="adminAttendanceNotMarked" style="color: #888;">0</div><div class="summary-label">NOT MARKED</div></div>
                        </div>
                        
                        <!-- Legend -->
                        <div class="schedule-legend" style="margin-bottom: 15px;">
                            <div class="legend-item"><div class="legend-bar" style="background: #39ff14;"></div><span>Present</span></div>
                            <div class="legend-item"><div class="legend-bar" style="background: #ffff00;"></div><span>Late</span></div>
                            <div class="legend-item"><div class="legend-bar" style="background: #ff3366;"></div><span>Absent</span></div>
                        </div>
                        
                        <!-- Attendance List -->
                        <div id="adminAttendanceContainer">
                            <p style="color: #888; font-size: 8px;">Click refresh to load attendance...</p>
                        </div>
                    </div>
                </div>

                <!-- Absences Tab -->
                <div id="adminTabAbsences" class="tab-content">
                    <div class="card">
                        <h3>üö´ Student Absences</h3>
                        <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                            <button class="btn btn-info" onclick="loadAbsencesList()">üîÑ Refresh</button>
                            <div class="form-group" style="margin: 0;">
                                <select id="absenceWeekFilter" onchange="loadAbsencesList()" style="padding: 8px; font-size: 8px;">
                                    <option value="all">All Weeks</option>
                                    <option value="1">Week 1</option>
                                    <option value="2">Week 2</option>
                                    <option value="3">Week 3</option>
                                    <option value="4">Week 4</option>
                                    <option value="5">Week 5</option>
                                    <option value="6">Week 6</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <select id="absenceContactFilter" onchange="filterAbsencesList()" style="padding: 8px; font-size: 8px;">
                                    <option value="all">All Status</option>
                                    <option value="not-contacted">Not Contacted Only</option>
                                    <option value="contacted">Contacted Only</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Absence Stats -->
                        <div class="schedule-summary" style="margin-bottom: 20px;">
                            <div class="summary-box" style="border-color: #ff3366;"><div class="summary-number" id="absenceTotalCount" style="color: #ff3366;">0</div><div class="summary-label">TOTAL ABSENCES</div></div>
                            <div class="summary-box" style="border-color: #39ff14;"><div class="summary-number" id="absenceContactedCount" style="color: #39ff14;">0</div><div class="summary-label">CONTACTED</div></div>
                            <div class="summary-box" style="border-color: #ff6600;"><div class="summary-number" id="absenceNotContactedCount" style="color: #ff6600;">0</div><div class="summary-label">NOT CONTACTED</div></div>
                        </div>
                        
                        <!-- Legend -->
                        <div class="schedule-legend" style="margin-bottom: 15px;">
                            <div class="legend-item"><div class="legend-bar" style="background: #39ff14;"></div><span>Contacted</span></div>
                            <div class="legend-item"><div class="legend-bar" style="background: #ff3366;"></div><span>Not Contacted</span></div>
                        </div>
                        
                        <!-- Absences List -->
                        <div id="absencesListContainer">
                            <p style="color: #888; font-size: 8px;">Click refresh to load absences...</p>
                        </div>
                    </div>
                </div>

                <!-- Completed Tab -->
                <div id="adminTabCompleted" class="tab-content">
                    <div class="card">
                        <h3>üéì Completed Students</h3>
                        <p style="font-size: 8px; color: #888; margin-bottom: 15px;">Students who have finished their 6-week course. Track if they've joined the KoreanLearnin community.</p>
                        
                        <div style="margin-bottom: 15px;">
                            <button class="btn btn-info" onclick="loadCompletedStudents()">üîÑ Refresh</button>
                        </div>
                        
                        <!-- Completed Stats -->
                        <div class="schedule-summary" style="margin-bottom: 20px;">
                            <div class="summary-box" style="border-color: #ff00ff;"><div class="summary-number" id="completedTotalCount" style="color: #ff00ff;">0</div><div class="summary-label">TOTAL COMPLETED</div></div>
                            <div class="summary-box" style="border-color: #39ff14;"><div class="summary-number" id="completedJoinedCount" style="color: #39ff14;">0</div><div class="summary-label">JOINED COMMUNITY</div></div>
                            <div class="summary-box" style="border-color: #ff3366;"><div class="summary-number" id="completedNotInterestedCount" style="color: #ff3366;">0</div><div class="summary-label">NOT INTERESTED</div></div>
                            <div class="summary-box" style="border-color: #ffff00;"><div class="summary-number" id="completedPendingCount" style="color: #ffff00;">0</div><div class="summary-label">PENDING</div></div>
                        </div>
                        
                        <!-- Legend -->
                        <div class="schedule-legend" style="margin-bottom: 15px;">
                            <div class="legend-item"><div class="legend-bar" style="background: #39ff14;"></div><span>Joined Community</span></div>
                            <div class="legend-item"><div class="legend-bar" style="background: #ff3366;"></div><span>Not Interested</span></div>
                            <div class="legend-item"><div class="legend-bar" style="background: #ffff00;"></div><span>Pending Response</span></div>
                        </div>
                        
                        <!-- Completed Students List -->
                        <div id="completedStudentsContainer">
                            <p style="color: #888; font-size: 8px;">Click refresh to load completed students...</p>
                        </div>
                    </div>
                </div>

                <div id="adminTabTeachers" class="tab-content">
                    <div class="grid-2">
                        <div class="card">
                            <h3>‚ûï Add New Teacher</h3>
                            <div id="addTeacherMessage"></div>
                            <div class="form-group"><label>Teacher Name</label><input type="text" id="newTeacherName" placeholder="Enter name"></div>
                            <div class="form-group"><label>Teacher Email</label><input type="email" id="newTeacherEmail" placeholder="Enter email"></div>
                            <div class="form-group"><label>Password</label><input type="password" id="newTeacherPassword" placeholder="Create password"></div>
                            <div class="form-group"><label>Available Days</label>
                                <div class="checkbox-group">
                                    <label class="checkbox-label"><input type="checkbox" id="teacherDaySat" checked> Saturday</label>
                                    <label class="checkbox-label"><input type="checkbox" id="teacherDaySun" checked> Sunday</label>
                                    <label class="checkbox-label"><input type="checkbox" id="teacherDayThu"> Thursday</label>
                                </div>
                            </div>
                            <button class="btn btn-success" onclick="addNewTeacher()">‚ûï Add Teacher</button>
                        </div>
                        <div class="card"><h3>üë®‚Äçüè´ Teacher List</h3><div id="teachersListContainer"><p style="color: #888;">Loading...</p></div></div>
                    </div>
                </div>

                <div id="adminTabMaterials" class="tab-content">
                    <div class="card">
                        <h3>üìñ Teaching Materials</h3>
                        <div class="form-group"><label>Select Level</label>
                            <select id="materialLevelSelect" onchange="loadMaterialsForLevel()">
                                <option value="absolute">Absolute Beginner</option>
                                <option value="novice">Novice</option>
                                <option value="beginner">Beginner</option>
                                <option value="advanced">Advanced Beginner</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <button class="btn btn-sm btn-primary" onclick="addMaterialBlock('text')">üìù Text</button>
                            <button class="btn btn-sm btn-info" onclick="addMaterialBlock('link')">üîó Link</button>
                            <button class="btn btn-sm btn-success" onclick="addMaterialBlock('image')">üñºÔ∏è Image</button>
                            <button class="btn btn-sm btn-warning" onclick="addMaterialBlock('file')">üìÅ File</button>
                        </div>
                        <div id="materialsContainer"><p style="color: #888; font-size: 8px;">No materials yet.</p></div>
                    </div>
                </div>

                <div id="adminTabSuggestions" class="tab-content">
                    <div class="card">
                        <h3>üí° Teacher Suggestions</h3>
                        <p style="font-size: 8px; color: #888; margin-bottom: 15px;">Review and respond to suggestions from teachers.</p>
                        <div id="adminSuggestionsContainer"><p style="color: #888; font-size: 8px;">No suggestions yet.</p></div>
                    </div>
                </div>

                <div id="adminTabSettings" class="tab-content">
                    <div class="card">
                        <h3>‚öôÔ∏è Settings</h3>
                        <div id="settingsMessage"></div>
                        <div class="settings-row"><span class="settings-label">Min Students/Class:</span><input type="number" class="settings-input" id="settingMinStudents" value="5" min="1" max="20"></div>
                        <div class="settings-row"><span class="settings-label">Max Students/Class:</span><input type="number" class="settings-input" id="settingMaxStudents" value="10" min="1" max="20"></div>
                        <div class="settings-row"><span class="settings-label">Current Week:</span>
                            <select id="settingCurrentWeek" class="settings-input"><option value="1">Week 1</option><option value="2">Week 2</option><option value="3">Week 3</option><option value="4">Week 4</option><option value="5">Week 5</option><option value="6">Week 6</option></select>
                        </div>
                        <div class="settings-row">
                            <span class="settings-label">Course Start Date:</span>
                            <input type="date" class="settings-input" id="settingStartDate" style="font-family: 'Press Start 2P', cursive; font-size: 8px;">
                        </div>
                        <button class="btn btn-success" onclick="saveSettings()">üíæ Save</button>
                        
                        <!-- Course Calendar Preview -->
                        <div id="courseCalendarPreview" style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #333;">
                            <h4 style="color: #ffff00; font-size: 10px; margin-bottom: 15px;">üìÖ Course Calendar</h4>
                            <div id="courseCalendarGrid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;"></div>
                        </div>
                    </div>
                    
                    <!-- Database Cleanup Section -->
                    <div class="card" style="margin-top: 20px; border-color: #ff3366;">
                        <h3 style="color: #ff3366;">üßπ Database Cleanup</h3>
                        <p style="font-size: 8px; color: #888; margin-bottom: 15px;">Remove orphan records and fix inconsistent data.</p>
                        <div id="cleanupMessage"></div>
                        <div id="cleanupPreview" style="margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 5px; display: none;">
                            <p style="font-size: 8px; color: #ffff00; margin-bottom: 10px;">üìã Issues Found:</p>
                            <div id="cleanupIssuesList"></div>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-info" onclick="scanForIssues()">üîç Scan for Issues</button>
                            <button class="btn btn-warning" onclick="cleanOrphanRecords()" id="cleanOrphansBtn" disabled>üßπ Clean Orphan Records</button>
                            <button class="btn btn-danger" onclick="resetAllData()">‚ö†Ô∏è Reset ALL Data</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Teacher Dashboard -->
            <div id="teacherDashboard" style="display: none;">
                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="showTeacherTab('myClasses')">üìö My Classes</button>
                    <button class="nav-tab" onclick="showTeacherTab('calendar')">üóìÔ∏è Calendar</button>
                    <button class="nav-tab" onclick="showTeacherTab('schedule')">üìÖ Schedule</button>
                    <button class="nav-tab" onclick="showTeacherTab('attendance')">üìä Attendance</button>
                    <button class="nav-tab" onclick="showTeacherTab('materials')">üìñ Materials</button>
                    <button class="nav-tab" onclick="showTeacherTab('suggestions')">üí° Suggestions</button>
                </div>
                <div id="teacherTabMyClasses" class="tab-content active">
                    <div class="card"><h3>üìÖ Current Week</h3><div class="week-tracker" id="teacherWeekTracker"></div></div>
                    <div class="card"><h3>üìö My Classes</h3><div id="teacherClassesContainer"><p style="color: #888;">Loading...</p></div></div>
                </div>
                
                <!-- Teacher Calendar Tab -->
                <div id="teacherTabCalendar" class="tab-content">
                    <div class="card">
                        <h3>üóìÔ∏è Monthly Calendar</h3>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <button class="btn btn-info" onclick="changeCalendarMonth(-1)">‚óÄ Prev</button>
                            <span id="teacherCalendarMonthLabel" style="font-size: 12px; color: #00ffff;"></span>
                            <button class="btn btn-info" onclick="changeCalendarMonth(1)">Next ‚ñ∂</button>
                        </div>
                        <div class="monthly-calendar" id="teacherMonthlyCalendarGrid"></div>
                        
                        <!-- Legend -->
                        <div class="schedule-legend" style="margin-top: 15px;">
                            <div class="legend-item"><div class="legend-bar" style="background: #39ff14;"></div><span>Class Day</span></div>
                            <div class="legend-item"><div class="legend-bar" style="background: #00ffff;"></div><span>Today</span></div>
                            <div class="legend-item"><div class="legend-bar" style="background: #ff00ff;"></div><span>Course Start/End</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- Teacher Schedule Tab -->
                <div id="teacherTabSchedule" class="tab-content">
                    <div class="card">
                        <h3>üìÖ My Weekly Schedule</h3>
                        
                        <!-- Summary Stats for Teacher -->
                        <div class="schedule-summary" id="teacherScheduleSummary">
                            <div class="summary-box active"><div class="summary-number" id="teacherTotalClasses">0</div><div class="summary-label">MY CLASSES</div></div>
                            <div class="summary-box cyan"><div class="summary-number" id="teacherTotalStudents">0</div><div class="summary-label">TOTAL STUDENTS</div></div>
                            <div class="summary-box full"><div class="summary-number" id="teacherFullClasses">0</div><div class="summary-label">FULL CLASSES</div></div>
                            <div class="summary-box available"><div class="summary-number" id="teacherAvailableSpots">0</div><div class="summary-label">SPOTS AVAILABLE</div></div>
                        </div>
                        
                        <!-- Legend -->
                        <div class="schedule-legend">
                            <div class="legend-item"><div class="legend-bar active"></div><span>My Class</span></div>
                            <div class="legend-item"><div class="legend-bar full"></div><span>Full</span></div>
                            <div class="legend-item"><div class="legend-bar empty"></div><span>Not Assigned</span></div>
                        </div>
                        
                        <!-- Schedule Grid -->
                        <div class="schedule-grid" id="teacherScheduleGrid">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
                <div id="teacherTabAttendance" class="tab-content">
                    <div class="card">
                        <h3>üìä Attendance History</h3>
                        <div class="form-group"><label>Select Class</label><select id="attendanceClassSelect" onchange="loadAttendanceHistory()"><option value="">-- Select --</option></select></div>
                        <div style="overflow-x: auto;"><table><thead><tr><th>Student</th><th>W1</th><th>W2</th><th>W3</th><th>W4</th><th>W5</th><th>W6</th></tr></thead><tbody id="attendanceHistoryBody"><tr><td colspan="7" style="text-align: center; color: #888;">Select a class</td></tr></tbody></table></div>
                    </div>
                </div>
                <div id="teacherTabMaterials" class="tab-content">
                    <div class="card">
                        <h3>üìñ Teaching Materials</h3>
                        <div class="form-group"><label>Select Level</label>
                            <select id="teacherMaterialLevel" onchange="loadTeacherMaterials()">
                                <option value="absolute">Absolute Beginner</option>
                                <option value="novice">Novice</option>
                                <option value="beginner">Beginner</option>
                                <option value="advanced">Advanced Beginner</option>
                            </select>
                        </div>
                        <div id="teacherMaterialsDisplay"><p style="color: #888; font-size: 8px;">Select a level.</p></div>
                    </div>
                </div>
                
                <div id="teacherTabSuggestions" class="tab-content">
                    <div class="card">
                        <h3>üí° Submit a Suggestion</h3>
                        <p style="font-size: 8px; color: #888; margin-bottom: 15px;">Share your ideas to help improve our classes and system.</p>
                        <div id="suggestionFormMessage"></div>
                        <div class="form-group">
                            <label>Suggestion Title</label>
                            <input type="text" id="suggestionTitle" placeholder="Brief title for your suggestion">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="suggestionDescription" rows="4" placeholder="Describe your suggestion in detail..." style="width: 100%; font-family: 'Press Start 2P', cursive; font-size: 8px; padding: 10px; background: #1a1a2e; color: #fff; border: 2px solid #333; border-radius: 5px; resize: vertical;"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Priority Level</label>
                            <div style="display: flex; gap: 10px; margin-top: 8px;">
                                <button type="button" class="priority-btn" id="priorityHigh" onclick="selectPriority('high')">üî¥ High</button>
                                <button type="button" class="priority-btn" id="priorityMid" onclick="selectPriority('mid')">üü° Mid</button>
                                <button type="button" class="priority-btn" id="priorityLow" onclick="selectPriority('low')">üü¢ Low</button>
                            </div>
                            <input type="hidden" id="suggestionPriority" value="">
                        </div>
                        <button class="btn btn-success" onclick="submitSuggestion()">üì§ Submit Suggestion</button>
                    </div>
                    
                    <div class="card" style="margin-top: 20px;">
                        <h3>üìã My Previous Suggestions</h3>
                        <div id="teacherSuggestionsContainer"><p style="color: #888; font-size: 8px;">No suggestions submitted yet.</p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Level Modal -->
    <div class="modal-overlay" id="levelModal">
        <div class="modal">
            <button class="modal-close" onclick="closeLevelModal()">‚úï</button>
            <h3 class="modal-title">üìù Assign Level</h3>
            <p style="font-size: 9px; margin-bottom: 15px;">Student: <span id="modalStudentName" style="color: #00ffff;"></span></p>
            <div id="levelModalMessage"></div>
            <div class="form-group"><label>Select Level</label>
                <select id="levelSelect"><option value="">-- Select --</option><option value="absolute">Absolute Beginner</option><option value="novice">Novice</option><option value="beginner">Beginner</option><option value="advanced">Advanced Beginner</option></select>
            </div>
            <input type="hidden" id="modalStudentId">
            <button class="btn btn-success" onclick="assignStudentLevel()">‚úì Assign</button>
        </div>
    </div>

    <!-- Material Modal -->
    <div class="modal-overlay" id="materialModal">
        <div class="modal">
            <button class="modal-close" onclick="closeMaterialModal()">‚úï</button>
            <h3 class="modal-title" id="materialModalTitle">Add Material</h3>
            <div id="materialModalMessage"></div>
            <div id="materialFormContainer"></div>
            <input type="hidden" id="editingMaterialId">
            <input type="hidden" id="editingMaterialType">
            <button class="btn btn-success" onclick="saveMaterial()">üíæ Save</button>
        </div>
    </div>

    <!-- Warning Modal -->
    <div class="modal-overlay" id="warningModal">
        <div class="modal">
            <button class="modal-close" onclick="closeWarningModal()">‚úï</button>
            <h3 class="modal-title" style="color: #ffff00;">‚ö†Ô∏è Warning</h3>
            <p id="warningMessage" style="font-size: 9px; margin-bottom: 20px;"></p>
            <button class="btn btn-success" onclick="confirmWarningAction()">Proceed</button>
            <button class="btn btn-secondary" onclick="closeWarningModal()">Cancel</button>
        </div>
    </div>

    <!-- Absence Reason Modal -->
    <div class="modal-overlay" id="absenceModal">
        <div class="modal">
            <button class="modal-close" onclick="closeAbsenceModal()">‚úï</button>
            <h3 class="modal-title" style="color: #ff3366;">üìù Absence Reason</h3>
            <p style="font-size: 9px; margin-bottom: 15px;">Student: <span id="absenceStudentName" style="color: #00ffff;"></span></p>
            <p style="font-size: 9px; margin-bottom: 20px;">Did the student give a reason for their absence?</p>
            <input type="hidden" id="absenceClassId">
            <input type="hidden" id="absenceStudentId">
            <div id="absenceReasonForm" style="display: none; margin-bottom: 15px;">
                <div class="form-group">
                    <label>Reason for Absence</label>
                    <textarea id="absenceReasonText" rows="3" placeholder="Enter the reason..."></textarea>
                </div>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-success" onclick="showAbsenceReasonForm()">‚úì Yes, has reason</button>
                <button class="btn btn-danger" onclick="markAbsentNoReason()">‚úó No reason given</button>
            </div>
            <div id="absenceSubmitBtn" style="display: none; margin-top: 15px;">
                <button class="btn btn-primary" onclick="submitAbsenceWithReason()">üíæ Save Absence with Reason</button>
            </div>
        </div>
    </div>

    <!-- Class Details Modal -->
    <div class="modal-overlay" id="classDetailsModal">
        <div class="modal" style="max-width: 700px;">
            <button class="modal-close" onclick="closeClassDetailsModal()">‚úï</button>
            <h3 class="modal-title">üìö Class Details</h3>
            <div id="classDetailsHeader" style="margin-bottom: 20px;"></div>
            <div id="classDetailsMessage"></div>
            <h4 style="color: #ffff00; font-size: 10px; margin-bottom: 15px;">üë• Students in this Class</h4>
            <div id="classStudentsList" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Course Start Date Modal -->
    <div class="modal-overlay" id="startDateModal">
        <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close" onclick="cancelStartDateModal()">‚úï</button>
            <h3 class="modal-title">üìÖ Preview & Set Class Start Dates</h3>
            <p style="font-size: 9px; margin-bottom: 20px; color: #888;">Review the proposed class groupings below. Select a start date for each class, then generate proposals.</p>
            
            <div id="classPreviewContainer" style="margin-bottom: 20px;">
                <p style="color: #888; font-size: 8px;">Loading class preview...</p>
            </div>
            
            <div id="limboPreviewContainer" style="display: none; margin-bottom: 20px; padding: 15px; background: rgba(255,51,102,0.1); border: 2px solid #ff3366; border-radius: 8px;">
                <h4 style="color: #ff3366; font-size: 10px; margin-bottom: 10px;">‚ö†Ô∏è Students Without Enough Classmates (Limbo)</h4>
                <p style="font-size: 7px; color: #888; margin-bottom: 10px;">These students don't have enough classmates with matching availability. They will be marked as "limbo".</p>
                <div id="limboStudentsList"></div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: center; padding-top: 15px; border-top: 2px solid #333;">
                <button class="btn btn-success" onclick="confirmAutoGenerate()" id="generateProposalsBtn" disabled>‚úì Generate Proposals</button>
                <button class="btn btn-secondary" onclick="cancelStartDateModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Move Student Modal -->
    <div class="modal-overlay" id="moveStudentModal">
        <div class="modal" style="max-width: 600px;">
            <button class="modal-close" onclick="closeMoveStudentModal()">‚úï</button>
            <h3 class="modal-title">üîÑ Move Student</h3>
            <p style="font-size: 9px; margin-bottom: 15px;">Student: <span id="moveStudentName" style="color: #00ffff;"></span></p>
            <input type="hidden" id="moveStudentId">
            <input type="hidden" id="moveFromClassId">
            <div style="margin-bottom: 15px;">
                <label class="checkbox-label">
                    <input type="checkbox" id="returnToPoolCheckbox" onchange="toggleMoveOptions()">
                    <span style="font-size: 8px;">Return to student pool (schedule changed, needs reassignment)</span>
                </label>
            </div>
            <div id="moveToClassSection">
                <h4 style="color: #ffff00; font-size: 10px; margin-bottom: 10px;">Select destination class:</h4>
                <div id="moveClassOptions" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
            <div style="margin-top: 15px;">
                <button class="btn btn-success" onclick="confirmMoveStudent()">‚úì Confirm Move</button>
                <button class="btn btn-secondary" onclick="closeMoveStudentModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Student Details Modal -->
    <div class="modal-overlay" id="studentDetailsModal">
        <div class="modal" style="max-width: 500px;">
            <button class="modal-close" onclick="closeStudentDetailsModal()">‚úï</button>
            <h3 class="modal-title">üë§ Student Details</h3>
            <div id="studentDetailsContent" style="padding: 15px 0;">
                <p style="color: #888; font-size: 8px;">Loading...</p>
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <button class="btn btn-secondary" onclick="closeStudentDetailsModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Community Reminder Modal (for teachers on Week 6) -->
    <div class="modal-overlay" id="communityReminderModal">
        <div class="modal" style="text-align: center; max-width: 600px;">
            <button class="modal-close" onclick="closeCommunityReminderModal()">‚úï</button>
            <h3 class="modal-title" style="color: #ff00ff;">üéâ Final Week Reminder!</h3>
            <div style="font-size: 50px; margin: 20px 0;">üéì</div>
            <p style="font-size: 10px; color: #ffff00; margin-bottom: 15px;">This is the LAST WEEK of the 6-week course!</p>
            <p style="font-size: 9px; color: #888; margin-bottom: 20px;">Please remind your students about the <strong style="color: #00ffff;">KoreanLearnin Community</strong> programs!</p>
            <div style="background: rgba(0,255,255,0.1); border: 2px solid #00ffff; border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                <p style="font-size: 9px; color: #00ffff; margin-bottom: 10px;">üó£Ô∏è Suggested script:</p>
                <p style="font-size: 8px; color: #fff; font-style: italic; margin-bottom: 10px;">"Congratulations on finishing the course! If you'd like to continue learning and get conversational in Korean within 1 year, consider joining our programs!"</p>
            </div>
            <div style="background: rgba(57,255,20,0.1); border: 2px solid #39ff14; border-radius: 10px; padding: 15px; margin-bottom: 15px; text-align: left;">
                <p style="font-size: 10px; color: #39ff14; margin-bottom: 10px; text-align: center;">üí∞ Pricing Options</p>
                <p style="font-size: 8px; color: #fff; margin-bottom: 8px;"><strong style="color: #ffff00;">üåü 1-Year Mastery Program:</strong> $500/year</p>
                <p style="font-size: 7px; color: #888; margin-bottom: 10px; padding-left: 20px;">‚Üí Since you paid $200 for this course, it's only <strong style="color: #39ff14;">$300</strong> to upgrade!</p>
                <p style="font-size: 7px; color: #ff9900; margin-bottom: 10px; padding-left: 20px;">‚ö° Sign up THIS WEEK to get a $200 discount code!</p>
                <p style="font-size: 8px; color: #fff;"><strong style="color: #00ffff;">üìÖ Monthly Program:</strong> $89/month</p>
            </div>
            <button class="btn btn-success" onclick="closeCommunityReminderModal()">Got it! üëç</button>
        </div>
    </div>

    <!-- Class Attendance Complete Modal (for teachers after marking all students in Week 6) -->
    <div class="modal-overlay" id="classCompleteReminderModal">
        <div class="modal" style="text-align: center; max-width: 600px;">
            <button class="modal-close" onclick="closeClassCompleteReminderModal()">‚úï</button>
            <h3 class="modal-title" style="color: #ff00ff;">üéâ All Students Marked!</h3>
            <div style="font-size: 50px; margin: 20px 0;">‚úÖ</div>
            <p style="font-size: 10px; color: #ffff00; margin-bottom: 15px;">You've marked attendance for all students in the final week!</p>
            <p style="font-size: 9px; color: #888; margin-bottom: 20px;">Don't forget to ask them about continuing their Korean journey!</p>
            <div style="background: rgba(57,255,20,0.1); border: 2px solid #39ff14; border-radius: 10px; padding: 15px; margin-bottom: 15px; text-align: left;">
                <p style="font-size: 10px; color: #39ff14; margin-bottom: 12px; text-align: center;">üí¨ Remind your students:</p>
                <p style="font-size: 8px; color: #fff; margin-bottom: 10px;"><strong style="color: #ffff00;">üåü 1-Year Mastery Program:</strong> Get conversational in Korean within 1 year!</p>
                <p style="font-size: 8px; color: #fff; margin-bottom: 5px; padding-left: 15px;">‚Ä¢ Regular price: $500/year</p>
                <p style="font-size: 8px; color: #39ff14; margin-bottom: 5px; padding-left: 15px;">‚Ä¢ Your class fee ($200) rolls into it = <strong>Only $300!</strong></p>
                <p style="font-size: 8px; color: #ff9900; margin-bottom: 15px; padding-left: 15px;">‚ö° Must sign up THIS WEEK to get the $200 discount code!</p>
                <p style="font-size: 8px; color: #fff;"><strong style="color: #00ffff;">üìÖ Monthly Program:</strong> $89/month - no commitment!</p>
            </div>
            <button class="btn btn-success" onclick="closeClassCompleteReminderModal()">Got it! üëç</button>
        </div>
    </div>

    <!-- Calendar Class Picker Modal -->
    <div class="modal-overlay" id="calendarClassPickerModal">
        <div class="modal" style="max-width: 400px;">
            <button class="modal-close" onclick="closeCalendarClassPicker()">‚úï</button>
            <h3 class="modal-title">üìÖ Classes on this Day</h3>
            <p style="font-size: 8px; color: #888; margin-bottom: 15px;">Click a class to view details:</p>
            <div id="calendarClassPickerList" style="display: grid; gap: 10px;"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <script>
        console.log('Script starting...');

        // Check if Firebase SDK is loaded
        if (typeof firebase === 'undefined') {
            console.error('Firebase SDK not loaded!');
            alert('Firebase SDK failed to load. Please check your internet connection and refresh the page.');
        } else {
            console.log('Firebase SDK loaded');
        }

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDzI1_B49onrKJriy3er88O1KOJTLBzbYY",
            authDomain: "korean-ta-evaluator.firebaseapp.com",
            projectId: "korean-ta-evaluator",
            storageBucket: "korean-ta-evaluator.firebasestorage.app",
            messagingSenderId: "386010826708",
            appId: "1:386010826708:web:d06d6fbdadce561b36b841",
            measurementId: "G-FGT8J0D64J"
        };
        
        console.log('Initializing Firebase...');
        // Initialize Firebase
        let auth, db, storage, secondaryAuth;
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            storage = firebase.storage();
            
            // Secondary app for creating accounts without logging out admin
            const secondaryApp = firebase.initializeApp(firebaseConfig, "Secondary");
            secondaryAuth = secondaryApp.auth();
            
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            alert("Failed to initialize Firebase: " + error.message);
        }

        // Constants
        const TIME_SLOTS = ['6:30 PM', '7:10 PM', '7:50 PM', '8:30 PM', '9:10 PM', '9:50 PM', '10:30 PM', '11:10 PM'];
        const DAYS = ['Saturday', 'Sunday'];
        const LEVELS = { absolute: 'Absolute Beginner', novice: 'Novice', beginner: 'Beginner', advanced: 'Advanced Beginner' };
        const LEVEL_PRIORITY = ['absolute', 'novice', 'beginner', 'advanced'];

        // State
        let currentUser = null;
        let selectedSlots = { 1: null, 2: null, 3: null };
        let allStudents = [];
        let allClasses = [];
        let allTeachers = [];
        let allProposals = [];
        let schedulerSettings = { minStudents: 5, maxStudents: 10, currentWeek: 1, startDate: null };
        let pendingDropAction = null;
        let draggedStudentId = null;
        let draggedProposalStudentId = null;

        // Timezone Map
        // US States with their default timezones
        const US_STATES = {
            'Alabama': 'America/Chicago',
            'Alaska': 'America/Anchorage', // Split timezone
            'Arizona': 'America/Phoenix',
            'Arkansas': 'America/Chicago',
            'California': 'America/Los_Angeles',
            'Colorado': 'America/Denver',
            'Connecticut': 'America/New_York',
            'Delaware': 'America/New_York',
            'Florida': 'America/New_York', // Split timezone
            'Georgia': 'America/New_York',
            'Hawaii': 'Pacific/Honolulu',
            'Idaho': 'America/Boise', // Split timezone
            'Illinois': 'America/Chicago',
            'Indiana': 'America/Indiana/Indianapolis', // Split timezone
            'Iowa': 'America/Chicago',
            'Kansas': 'America/Chicago', // Split timezone
            'Kentucky': 'America/Kentucky/Louisville', // Split timezone
            'Louisiana': 'America/Chicago',
            'Maine': 'America/New_York',
            'Maryland': 'America/New_York',
            'Massachusetts': 'America/New_York',
            'Michigan': 'America/Detroit', // Split timezone
            'Minnesota': 'America/Chicago',
            'Mississippi': 'America/Chicago',
            'Missouri': 'America/Chicago',
            'Montana': 'America/Denver',
            'Nebraska': 'America/Chicago', // Split timezone
            'Nevada': 'America/Los_Angeles', // Split timezone
            'New Hampshire': 'America/New_York',
            'New Jersey': 'America/New_York',
            'New Mexico': 'America/Denver',
            'New York': 'America/New_York',
            'North Carolina': 'America/New_York',
            'North Dakota': 'America/Chicago', // Split timezone
            'Ohio': 'America/New_York',
            'Oklahoma': 'America/Chicago',
            'Oregon': 'America/Los_Angeles', // Split timezone
            'Pennsylvania': 'America/New_York',
            'Rhode Island': 'America/New_York',
            'South Carolina': 'America/New_York',
            'South Dakota': 'America/Chicago', // Split timezone
            'Tennessee': 'America/Chicago', // Split timezone
            'Texas': 'America/Chicago', // Split timezone
            'Utah': 'America/Denver',
            'Vermont': 'America/New_York',
            'Virginia': 'America/New_York',
            'Washington': 'America/Los_Angeles',
            'West Virginia': 'America/New_York',
            'Wisconsin': 'America/Chicago',
            'Wyoming': 'America/Denver',
            'District of Columbia': 'America/New_York'
        };
        
        // Canadian Provinces with their default timezones
        const CA_PROVINCES = {
            'Alberta': 'America/Edmonton',
            'British Columbia': 'America/Vancouver',
            'Manitoba': 'America/Winnipeg',
            'New Brunswick': 'America/Moncton',
            'Newfoundland and Labrador': 'America/St_Johns',
            'Northwest Territories': 'America/Yellowknife',
            'Nova Scotia': 'America/Halifax',
            'Nunavut': 'America/Iqaluit',
            'Ontario': 'America/Toronto',
            'Prince Edward Island': 'America/Halifax',
            'Quebec': 'America/Montreal',
            'Saskatchewan': 'America/Regina',
            'Yukon': 'America/Whitehorse'
        };
        
        // Split timezone states with their options
        const SPLIT_TIMEZONE_STATES = {
            'Alaska': [
                { value: 'America/Anchorage', label: 'Alaska Time (most of Alaska)' },
                { value: 'America/Adak', label: 'Hawaii-Aleutian Time (Aleutian Islands)' }
            ],
            'Florida': [
                { value: 'America/New_York', label: 'Eastern Time (most of Florida)' },
                { value: 'America/Chicago', label: 'Central Time (western panhandle - Pensacola, Panama City)' }
            ],
            'Idaho': [
                { value: 'America/Boise', label: 'Mountain Time (southern Idaho)' },
                { value: 'America/Los_Angeles', label: 'Pacific Time (northern panhandle)' }
            ],
            'Indiana': [
                { value: 'America/Indiana/Indianapolis', label: 'Eastern Time (most of Indiana)' },
                { value: 'America/Chicago', label: 'Central Time (northwest & southwest corners)' }
            ],
            'Kansas': [
                { value: 'America/Chicago', label: 'Central Time (most of Kansas)' },
                { value: 'America/Denver', label: 'Mountain Time (western counties)' }
            ],
            'Kentucky': [
                { value: 'America/Kentucky/Louisville', label: 'Eastern Time (eastern Kentucky)' },
                { value: 'America/Chicago', label: 'Central Time (western Kentucky)' }
            ],
            'Michigan': [
                { value: 'America/Detroit', label: 'Eastern Time (most of Michigan)' },
                { value: 'America/Chicago', label: 'Central Time (western Upper Peninsula)' }
            ],
            'Nebraska': [
                { value: 'America/Chicago', label: 'Central Time (most of Nebraska)' },
                { value: 'America/Denver', label: 'Mountain Time (western panhandle)' }
            ],
            'Nevada': [
                { value: 'America/Los_Angeles', label: 'Pacific Time (most of Nevada)' },
                { value: 'America/Denver', label: 'Mountain Time (West Wendover area)' }
            ],
            'North Dakota': [
                { value: 'America/Chicago', label: 'Central Time (most of North Dakota)' },
                { value: 'America/Denver', label: 'Mountain Time (southwest corner)' }
            ],
            'Oregon': [
                { value: 'America/Los_Angeles', label: 'Pacific Time (most of Oregon)' },
                { value: 'America/Boise', label: 'Mountain Time (Malheur County)' }
            ],
            'South Dakota': [
                { value: 'America/Chicago', label: 'Central Time (eastern South Dakota)' },
                { value: 'America/Denver', label: 'Mountain Time (western South Dakota)' }
            ],
            'Tennessee': [
                { value: 'America/Chicago', label: 'Central Time (western & middle Tennessee)' },
                { value: 'America/New_York', label: 'Eastern Time (eastern Tennessee)' }
            ],
            'Texas': [
                { value: 'America/Chicago', label: 'Central Time (most of Texas)' },
                { value: 'America/Denver', label: 'Mountain Time (El Paso & Hudspeth County)' }
            ]
        };
        
        // Country timezone defaults
        const COUNTRY_TIMEZONES = {
            'US': 'America/New_York',
            'CA': 'America/Toronto',
            'GB': 'Europe/London',
            'AU': 'Australia/Sydney',
            'KR': 'Asia/Seoul',
            'JP': 'Asia/Tokyo',
            'DE': 'Europe/Berlin',
            'FR': 'Europe/Paris'
        };

        // Utility Functions
        function showMessage(id, msg, type) {
            const el = document.getElementById(id);
            if (el) { el.innerHTML = `<div class="message ${type}">${msg}</div>`; setTimeout(() => el.innerHTML = '', 5000); }
        }
        
        // Email validation
        function validateEmail() {
            const email = document.getElementById('studentEmail').value.trim();
            const errorEl = document.getElementById('emailError');
            
            if (!email) {
                errorEl.style.display = 'none';
                return false;
            }
            
            // Check for @ symbol
            if (!email.includes('@')) {
                errorEl.textContent = 'Email must contain @ symbol';
                errorEl.style.display = 'block';
                return false;
            }
            
            // Check for valid format
            const emailRegex = /^[^\s@]+@[^\s@]+\.(com|org|edu|net|gov|co|io|me|info|biz|us|ca|uk|au|de|fr|kr|jp)$/i;
            if (!emailRegex.test(email)) {
                errorEl.textContent = 'Please enter a valid email address';
                errorEl.style.display = 'block';
                return false;
            }
            
            errorEl.style.display = 'none';
            return true;
        }
        
        // Country change handler
        function onCountryChange() {
            const country = document.getElementById('studentCountry').value;
            const locationFields = document.getElementById('locationFields');
            const stateGroup = document.getElementById('stateGroup');
            const cityGroup = document.getElementById('cityGroup');
            const timezoneGroup = document.getElementById('timezoneGroup');
            const splitTimezoneGroup = document.getElementById('splitTimezoneGroup');
            const stateList = document.getElementById('stateList');
            const stateLabel = document.getElementById('stateLabel');
            
            // Reset fields
            document.getElementById('studentState').value = '';
            document.getElementById('studentCity').value = '';
            splitTimezoneGroup.style.display = 'none';
            
            if (country === 'GB') {
                // UK - no state/city needed
                locationFields.style.display = 'none';
                timezoneGroup.style.display = 'none';
            } else if (country === 'US') {
                // US - show state autocomplete
                locationFields.style.display = 'block';
                stateGroup.style.display = 'block';
                cityGroup.style.display = 'block';
                timezoneGroup.style.display = 'none';
                stateLabel.textContent = 'State';
                stateList.innerHTML = Object.keys(US_STATES).map(s => `<option value="${s}">`).join('');
            } else if (country === 'CA') {
                // Canada - show province autocomplete
                locationFields.style.display = 'block';
                stateGroup.style.display = 'block';
                cityGroup.style.display = 'block';
                timezoneGroup.style.display = 'none';
                stateLabel.textContent = 'Province';
                stateList.innerHTML = Object.keys(CA_PROVINCES).map(s => `<option value="${s}">`).join('');
            } else if (country === 'OTHER') {
                // Other - show timezone picker
                locationFields.style.display = 'block';
                stateGroup.style.display = 'block';
                cityGroup.style.display = 'block';
                stateLabel.textContent = 'State/Province';
                stateList.innerHTML = '';
                timezoneGroup.style.display = 'block';
            } else if (country) {
                // Other known countries - just city
                locationFields.style.display = 'block';
                stateGroup.style.display = 'none';
                cityGroup.style.display = 'block';
                timezoneGroup.style.display = 'none';
            } else {
                locationFields.style.display = 'none';
                timezoneGroup.style.display = 'none';
            }
            
            renderAvailabilityGrid();
        }
        
        // State change handler
        function onStateChange() {
            const country = document.getElementById('studentCountry').value;
            const state = document.getElementById('studentState').value;
            const splitTimezoneGroup = document.getElementById('splitTimezoneGroup');
            const splitTimezoneSelect = document.getElementById('splitTimezoneSelect');
            const splitTimezoneLabel = document.getElementById('splitTimezoneLabel');
            
            // Check if this is a split timezone state
            if (country === 'US' && SPLIT_TIMEZONE_STATES[state]) {
                const options = SPLIT_TIMEZONE_STATES[state];
                splitTimezoneLabel.textContent = `${state} Timezone`;
                splitTimezoneSelect.innerHTML = options.map(o => `<option value="${o.value}">${o.label}</option>`).join('');
                splitTimezoneGroup.style.display = 'block';
            } else {
                splitTimezoneGroup.style.display = 'none';
            }
            
            renderAvailabilityGrid();
        }

        function getTimezone(country, state) {
            if (!country) return 'America/New_York';
            
            // UK
            if (country === 'GB') return 'Europe/London';
            
            // US
            if (country === 'US' && state) {
                // Check for split timezone state with user selection
                if (SPLIT_TIMEZONE_STATES[state]) {
                    const splitSelect = document.getElementById('splitTimezoneSelect');
                    if (splitSelect && splitSelect.value) {
                        return splitSelect.value;
                    }
                }
                // Use default for state
                if (US_STATES[state]) return US_STATES[state];
            }
            
            // Canada
            if (country === 'CA' && state) {
                if (CA_PROVINCES[state]) return CA_PROVINCES[state];
            }
            
            // Other countries with manual timezone
            if (country === 'OTHER') {
                return document.getElementById('studentTimezone').value;
            }
            
            // Default for country
            return COUNTRY_TIMEZONES[country] || 'America/New_York';
        }

        function convertESTToLocal(estTime, tz) {
            try {
                const [time, period] = estTime.split(' ');
                let [h, m] = time.split(':').map(Number);
                if (period === 'PM' && h !== 12) h += 12;
                if (period === 'AM' && h === 12) h = 0;
                const d = new Date(); d.setHours(h, m, 0, 0);
                return d.toLocaleString('en-US', { timeZone: tz, hour: 'numeric', minute: '2-digit', hour12: true });
            } catch (e) { return estTime; }
        }

        // Role Switching
        function switchRole(role) {
            document.querySelectorAll('.role-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('studentLoginForm').style.display = role === 'student' ? 'block' : 'none';
            document.getElementById('studentSuccessScreen').style.display = 'none';
            document.getElementById('adminLoginForm').style.display = role === 'admin' ? 'block' : 'none';
            document.getElementById('teacherLoginForm').style.display = role === 'teacher' ? 'block' : 'none';
        }

        // Student Registration
        function renderAvailabilityGrid() {
            const grid = document.getElementById('availabilityGrid');
            const country = document.getElementById('studentCountry').value;
            const state = document.getElementById('studentState').value;
            const tz = getTimezone(country, state);

            grid.innerHTML = DAYS.map(day => `
                <div class="day-column">
                    <div class="day-title">${day}</div>
                    ${TIME_SLOTS.map(time => {
                        const local = convertESTToLocal(time, tz);
                        const slotId = `${day}-${time}`;
                        const rank = Object.entries(selectedSlots).find(([r, s]) => s === slotId)?.[0];
                        return `<div class="time-slot ${rank ? 'selected-' + rank : ''}" onclick="selectSlot('${day}', '${time}')">${time} EST<div class="local-time">Your time: ${local}</div>${rank ? `<div class="rank-badge">${rank}</div>` : ''}</div>`;
                    }).join('')}
                </div>
            `).join('');
        }

        function selectSlot(day, time) {
            const slotId = `${day}-${time}`;
            const existing = Object.entries(selectedSlots).find(([r, s]) => s === slotId)?.[0];
            if (existing) { selectedSlots[existing] = null; }
            else { for (let i = 1; i <= 3; i++) { if (!selectedSlots[i]) { selectedSlots[i] = slotId; break; } } }
            renderAvailabilityGrid();
        }

        async function submitStudentRegistration() {
            const name = document.getElementById('studentName').value.trim();
            const email = document.getElementById('studentEmail').value.trim();
            const phone = document.getElementById('studentPhone').value.trim();
            const discord = document.getElementById('studentDiscord').value.trim();
            const country = document.getElementById('studentCountry').value;
            const videoUrl = document.getElementById('studentVideoUrl').value;
            
            // UK doesn't need city/state
            const city = country === 'GB' ? 'United Kingdom' : document.getElementById('studentCity').value.trim();
            const state = country === 'GB' ? '' : document.getElementById('studentState').value.trim();

            // Validation
            if (!name) { showMessage('studentRegMessage', 'Please enter your name', 'error'); return; }
            if (!email) { showMessage('studentRegMessage', 'Please enter your email', 'error'); return; }
            if (!validateEmail()) { showMessage('studentRegMessage', 'Please enter a valid email address', 'error'); return; }
            if (!country) { showMessage('studentRegMessage', 'Please select your country', 'error'); return; }
            
            // Country-specific validation
            if (country === 'US') {
                if (!state || !US_STATES[state]) { showMessage('studentRegMessage', 'Please select a valid US state', 'error'); return; }
                if (!city) { showMessage('studentRegMessage', 'Please enter your city', 'error'); return; }
                // Check if split timezone state needs selection
                if (SPLIT_TIMEZONE_STATES[state] && !document.getElementById('splitTimezoneSelect').value) {
                    showMessage('studentRegMessage', 'Please select your timezone', 'error'); return;
                }
            } else if (country === 'CA') {
                if (!state || !CA_PROVINCES[state]) { showMessage('studentRegMessage', 'Please select a valid Canadian province', 'error'); return; }
                if (!city) { showMessage('studentRegMessage', 'Please enter your city', 'error'); return; }
            } else if (country !== 'GB' && country !== 'OTHER') {
                if (!city) { showMessage('studentRegMessage', 'Please enter your city', 'error'); return; }
            } else if (country === 'OTHER') {
                if (!city) { showMessage('studentRegMessage', 'Please enter your city', 'error'); return; }
            }
            
            if (!selectedSlots[1] || !selectedSlots[2] || !selectedSlots[3]) { showMessage('studentRegMessage', 'Please select 3 availability preferences', 'error'); return; }
            if (!videoUrl) { showMessage('studentRegMessage', 'Please record your pronunciation video', 'error'); return; }

            const tz = getTimezone(country, state);

            try {
                await db.collection('scheduler_students').add({
                    name, email, phone, discord, city, state, country, timezone: tz,
                    availabilities: { ...selectedSlots },
                    videoUrl: videoUrl,
                    level: null, status: 'pending', classId: null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                document.getElementById('studentLoginForm').style.display = 'none';
                document.getElementById('studentSuccessScreen').style.display = 'block';
            } catch (e) { showMessage('studentRegMessage', 'Error: ' + e.message, 'error'); }
        }

        function resetStudentForm() {
            selectedSlots = { 1: null, 2: null, 3: null };
            ['studentName', 'studentEmail', 'studentPhone', 'studentDiscord', 'studentCity', 'studentState', 'studentCountry'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            document.getElementById('studentVideoUrl').value = '';
            document.getElementById('videoPlayback').style.display = 'none';
            document.getElementById('videoPlayback').src = '';
            document.getElementById('recordingStatus').textContent = '';
            document.getElementById('recordingTimer').style.display = 'none';
            document.getElementById('locationFields').style.display = 'none';
            document.getElementById('timezoneGroup').style.display = 'none';
            document.getElementById('splitTimezoneGroup').style.display = 'none';
            document.getElementById('emailError').style.display = 'none';
            const btn = document.getElementById('recordBtn');
            btn.className = 'record-btn start';
            btn.textContent = 'üé§ HOLD TO RECORD';
            document.getElementById('studentLoginForm').style.display = 'block';
            document.getElementById('studentSuccessScreen').style.display = 'none';
            renderAvailabilityGrid();
        }

        // Admin Login
        async function adminLogin() {
            if (!auth || !db) { showMessage('adminLoginMessage', 'Firebase not ready. Please refresh the page.', 'error'); return; }
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value;
            if (!email || !password) { showMessage('adminLoginMessage', 'Enter email and password', 'error'); return; }

            console.log('Attempting admin login with:', email);
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                console.log('Authentication successful:', userCredential.user.uid);
                
                // Check users collection for admin role
                const userDoc = await db.collection('users').doc(userCredential.user.uid).get();
                console.log('User doc exists:', userDoc.exists);
                
                if (!userDoc.exists) {
                    await auth.signOut();
                    showMessage('adminLoginMessage', 'User not found in database', 'error');
                    return;
                }
                
                const userData = userDoc.data();
                console.log('User data:', userData);
                
                if (userData.role !== 'admin') {
                    await auth.signOut();
                    showMessage('adminLoginMessage', 'Access denied. Admin only.', 'error');
                    return;
                }
                
                currentUser = { ...userData, uid: userCredential.user.uid, role: 'admin' };
                showMessage('adminLoginMessage', 'Login successful!', 'success');
                setTimeout(() => showAdminDashboard(), 500);
            } catch (e) { 
                console.error('Login error:', e);
                showMessage('adminLoginMessage', 'Login failed: ' + e.message, 'error'); 
            }
        }

        // Teacher Login
        async function teacherLogin() {
            if (!auth || !db) { showMessage('teacherLoginMessage', 'Firebase not ready. Please refresh the page.', 'error'); return; }
            const email = document.getElementById('teacherEmail').value.trim();
            const password = document.getElementById('teacherPassword').value;
            if (!email || !password) { showMessage('teacherLoginMessage', 'Enter email and password', 'error'); return; }

            console.log('Attempting teacher login with:', email);
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                console.log('Authentication successful:', userCredential.user.uid);
                
                // Check scheduler_teachers collection
                const q = await db.collection('scheduler_teachers').where('email', '==', email).get();
                
                if (q.empty) { 
                    await auth.signOut(); 
                    showMessage('teacherLoginMessage', 'Not registered as a scheduler teacher', 'error'); 
                    return; 
                }
                
                currentUser = { ...q.docs[0].data(), odId: q.docs[0].id, uid: userCredential.user.uid, role: 'teacher' };
                showMessage('teacherLoginMessage', 'Login successful!', 'success');
                setTimeout(() => showTeacherDashboard(), 500);
            } catch (e) { 
                console.error('Login error:', e);
                showMessage('teacherLoginMessage', 'Login failed: ' + e.message, 'error'); 
            }
        }

        async function logout() {
            await auth.signOut();
            currentUser = null;
            document.getElementById('mainPanel').style.display = 'none';
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('teacherDashboard').style.display = 'none';
        }

        // Admin Dashboard
        function showAdminDashboard() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainPanel').style.display = 'block';
            document.getElementById('adminDashboard').style.display = 'block';
            document.getElementById('teacherDashboard').style.display = 'none';
            document.getElementById('userInfoDisplay').textContent = `Admin: ${currentUser.email || currentUser.name}`;
            loadSchedulerSettings(); loadAllStudents(); loadAllTeachers(); loadAllClasses(); loadProposals();
        }

        function showAdminTab(tab, clickedElement) {
            document.querySelectorAll('#adminDashboard .tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#adminDashboard .nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`adminTab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('active');
            
            // Handle both click events and programmatic calls
            if (clickedElement) {
                clickedElement.classList.add('active');
            } else if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Programmatic call - find and activate the correct tab button
                const tabBtn = document.querySelector(`#adminDashboard .nav-tab[onclick*="${tab}"]`);
                if (tabBtn) tabBtn.classList.add('active');
            }
            
            if (tab === 'materials') loadMaterialsForLevel();
            if (tab === 'schedule') renderAdminSchedule();
            if (tab === 'absences') loadAbsencesList();
            if (tab === 'calendar') renderMonthlyCalendar();
            if (tab === 'completed') loadCompletedStudents();
            if (tab === 'attendance') loadAdminAttendance();
            if (tab === 'suggestions') loadAdminSuggestions();
            if (tab === 'proposals') { loadProposals(); renderAvailableStudentsForProposals(); }
        }

        // Teacher Dashboard
        function showTeacherDashboard() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainPanel').style.display = 'block';
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('teacherDashboard').style.display = 'block';
            document.getElementById('userInfoDisplay').textContent = `Teacher: ${currentUser.name}`;
            
            // Load settings FIRST, then load classes (so currentWeek is correct)
            loadSchedulerSettings().then(() => {
                checkWeek6Reminder();
                loadTeacherClasses(); 
                loadAllClassesForTeacher();
            });
        }

        function showTeacherTab(tab) {
            document.querySelectorAll('#teacherDashboard .tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#teacherDashboard .nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`teacherTab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('active');
            event.target.classList.add('active');
            if (tab === 'materials') loadTeacherMaterials();
            if (tab === 'schedule') renderTeacherSchedule();
            if (tab === 'calendar') renderTeacherCalendar();
            if (tab === 'suggestions') loadTeacherSuggestions();
        }
        
        function renderTeacherCalendar() {
            const grid = document.getElementById('teacherMonthlyCalendarGrid');
            const label = document.getElementById('teacherCalendarMonthLabel');
            if (!grid || !label) return;
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            label.textContent = `${monthNames[calendarMonth]} ${calendarYear}`;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let courseStart = null, courseEnd = null;
            if (schedulerSettings.startDate) {
                courseStart = new Date(schedulerSettings.startDate + 'T00:00:00');
                courseEnd = getCourseEndDate();
            }
            
            const firstDay = new Date(calendarYear, calendarMonth, 1);
            const lastDay = new Date(calendarYear, calendarMonth + 1, 0);
            const startDayOfWeek = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            
            // Build class schedule map - only for teacher's classes
            const myClasses = allClassesForTeacher.filter(c => c.teacherId === currentUser?.odId && c.status !== 'completed');
            const classDays = {};
            myClasses.forEach(cls => {
                for (let week = 1; week <= 6; week++) {
                    const weekDates = getWeekDates(week);
                    if (!weekDates) continue;
                    
                    const dayOffset = cls.day === 'Saturday' ? 6 : 0;
                    const classDate = new Date(weekDates.start);
                    classDate.setDate(weekDates.start.getDate() + ((dayOffset - weekDates.start.getDay() + 7) % 7));
                    
                    const dateKey = `${classDate.getFullYear()}-${classDate.getMonth()}-${classDate.getDate()}`;
                    if (!classDays[dateKey]) classDays[dateKey] = [];
                    classDays[dateKey].push({ ...cls, week });
                }
            });
            
            let html = '';
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                html += `<div class="calendar-header">${day}</div>`;
            });
            
            const prevMonth = new Date(calendarYear, calendarMonth, 0);
            for (let i = startDayOfWeek - 1; i >= 0; i--) {
                const day = prevMonth.getDate() - i;
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(calendarYear, calendarMonth, day);
                const dateKey = `${calendarYear}-${calendarMonth}-${day}`;
                const dayClasses = classDays[dateKey] || [];
                
                let classes = ['calendar-day'];
                if (currentDate.getTime() === today.getTime()) classes.push('today');
                if (courseStart && currentDate.getTime() === courseStart.getTime()) classes.push('course-start');
                if (courseEnd && currentDate.getTime() === courseEnd.getTime()) classes.push('course-end');
                if (dayClasses.length > 0) classes.push('has-class');
                
                let weekNum = '';
                if (courseStart && currentDate >= courseStart && currentDate <= courseEnd) {
                    const diffDays = Math.floor((currentDate - courseStart) / (1000 * 60 * 60 * 24));
                    weekNum = `W${Math.floor(diffDays / 7) + 1}`;
                }
                
                html += `<div class="${classes.join(' ')}">
                    <div class="calendar-day-number">${day}</div>
                    ${weekNum ? `<div class="calendar-week-label">${weekNum}</div>` : ''}
                    ${dayClasses.length > 0 ? `
                        <div>
                            ${dayClasses.map(c => `<span class="calendar-class-dot" style="background: ${getLevelColor(c.level)};" title="${LEVELS[c.level]} - ${c.time}"></span>`).join('')}
                        </div>
                        <div class="calendar-class-info">${dayClasses.length} class${dayClasses.length > 1 ? 'es' : ''}</div>
                    ` : ''}
                </div>`;
            }
            
            const remainingCells = 42 - (startDayOfWeek + daysInMonth);
            for (let day = 1; day <= remainingCells; day++) {
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }
            
            grid.innerHTML = html;
        }
        
        // Load all classes for teacher schedule view
        let allClassesForTeacher = [];
        async function loadAllClassesForTeacher() {
            try {
                const snap = await db.collection('scheduler_classes').get();
                allClassesForTeacher = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            } catch (e) { console.error(e); }
        }

        // Load Data
        async function loadSchedulerSettings() {
            try {
                const doc = await db.collection('scheduler_settings').doc('main').get();
                if (doc.exists) schedulerSettings = { ...schedulerSettings, ...doc.data() };
                updateWeekTrackers();
                if (currentUser?.role === 'admin') {
                    document.getElementById('settingMinStudents').value = schedulerSettings.minStudents;
                    document.getElementById('settingMaxStudents').value = schedulerSettings.maxStudents;
                    document.getElementById('settingCurrentWeek').value = schedulerSettings.currentWeek;
                    if (schedulerSettings.startDate) {
                        document.getElementById('settingStartDate').value = schedulerSettings.startDate;
                    }
                    renderCourseCalendar();
                }
            } catch (e) { console.error(e); }
        }

        function updateWeekTrackers() {
            const html = Array.from({ length: 6 }, (_, i) => {
                const w = i + 1;
                const dateStr = getWeekDateString(w);
                return `<button class="week-btn ${w === schedulerSettings.currentWeek ? 'current' : ''} ${w < schedulerSettings.currentWeek ? 'completed' : ''}" onclick="setCurrentWeek(${w})" title="${dateStr}">Week ${w}${dateStr ? `<br><span style="font-size: 6px;">${dateStr}</span>` : ''}</button>`;
            }).join('');
            ['dashboardWeekTracker', 'classesWeekTracker', 'teacherWeekTracker'].forEach(id => { const el = document.getElementById(id); if (el) el.innerHTML = html; });
        }
        
        function getWeekDateString(weekNum) {
            if (!schedulerSettings.startDate) return '';
            const start = new Date(schedulerSettings.startDate + 'T00:00:00');
            const weekStart = new Date(start);
            weekStart.setDate(start.getDate() + (weekNum - 1) * 7);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            
            const formatDate = (d) => `${d.getMonth() + 1}/${d.getDate()}`;
            return `${formatDate(weekStart)}-${formatDate(weekEnd)}`;
        }
        
        function getWeekDates(weekNum) {
            if (!schedulerSettings.startDate) return null;
            const start = new Date(schedulerSettings.startDate + 'T00:00:00');
            const weekStart = new Date(start);
            weekStart.setDate(start.getDate() + (weekNum - 1) * 7);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            return { start: weekStart, end: weekEnd };
        }
        
        function getCourseEndDate() {
            if (!schedulerSettings.startDate) return null;
            const start = new Date(schedulerSettings.startDate + 'T00:00:00');
            const end = new Date(start);
            end.setDate(start.getDate() + (6 * 7) - 1); // 6 weeks
            return end;
        }
        
        function renderCourseCalendar() {
            const container = document.getElementById('courseCalendarGrid');
            if (!container) return;
            
            if (!schedulerSettings.startDate) {
                container.innerHTML = '<p style="color: #888; font-size: 8px; grid-column: 1/-1;">Set a start date above to see the course calendar.</p>';
                return;
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const startDate = new Date(schedulerSettings.startDate + 'T00:00:00');
            const endDate = getCourseEndDate();
            
            // Summary section
            const formatFullDate = (d) => d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
            
            let html = `
                <div class="course-dates-summary" style="grid-column: 1/-1;">
                    <div class="course-date-item">
                        <div class="course-date-label">üìÖ COURSE START</div>
                        <div class="course-date-value">${formatFullDate(startDate)}</div>
                    </div>
                    <div class="course-date-item">
                        <div class="course-date-label">üèÅ COURSE END</div>
                        <div class="course-date-value end">${formatFullDate(endDate)}</div>
                    </div>
                </div>
            `;
            
            // Week cards
            for (let w = 1; w <= 6; w++) {
                const weekDates = getWeekDates(w);
                const isPast = weekDates.end < today;
                const isCurrent = w === schedulerSettings.currentWeek;
                const isFuture = weekDates.start > today;
                
                let status = 'Upcoming';
                if (isPast) status = '‚úì Completed';
                else if (isCurrent) status = '‚ñ∂ CURRENT WEEK';
                
                const formatShortDate = (d) => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                
                html += `
                    <div class="week-date-card ${isCurrent ? 'current' : ''} ${isPast ? 'past' : ''} ${isFuture ? 'future' : ''}">
                        <div class="week-date-number">Week ${w}</div>
                        <div class="week-date-range">${formatShortDate(weekDates.start)} - ${formatShortDate(weekDates.end)}</div>
                        <div class="week-date-status">${status}</div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        async function setCurrentWeek(w) {
            schedulerSettings.currentWeek = w;
            await db.collection('scheduler_settings').doc('main').set(schedulerSettings, { merge: true });
            updateWeekTrackers();
            if (currentUser?.role === 'admin') {
                renderCourseCalendar();
                renderAdminSchedule();
            }
            if (currentUser?.role === 'teacher') {
                loadTeacherClasses();
                renderTeacherSchedule();
            }
        }

        async function loadAllStudents() {
            console.log('Loading all students...');
            try {
                // Simple query without orderBy to avoid index requirements
                const snap = await db.collection('scheduler_students').get();
                console.log('Students snapshot:', snap.size, 'documents');
                allStudents = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                // Sort locally by createdAt if available
                allStudents.sort((a, b) => {
                    const aTime = a.createdAt?.toDate?.() || new Date(0);
                    const bTime = b.createdAt?.toDate?.() || new Date(0);
                    return bTime - aTime;
                });
                
                console.log('Loaded students:', allStudents.length);
                renderStudentsTable(); 
                updateDashboardStats();
            } catch (e) { 
                console.error('Error loading students:', e); 
                document.getElementById('studentsTableBody').innerHTML = `<tr><td colspan="8" style="color: #ff3366;">Error loading: ${e.message}</td></tr>`;
            }
        }

        function renderStudentsTable() {
            const tbody = document.getElementById('studentsTableBody');
            // Only show students that are NOT assigned, proposed, or completed
            const unassignedStudents = allStudents.filter(s => s.status !== 'assigned' && s.status !== 'completed' && s.status !== 'proposed');
            
            if (unassignedStudents.length === 0) { 
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #888;">No unassigned students. All students are in classes, proposals, or completed.</td></tr>'; 
                return; 
            }
            tbody.innerHTML = unassignedStudents.map(s => `
                <tr>
                    <td>${s.name}</td>
                    <td style="font-size: 7px;">${s.email}</td>
                    <td>${s.city}, ${s.state}</td>
                    <td style="font-size: 7px;">${s.timezone || 'N/A'}</td>
                    <td>
                        ${s.videoUrl ? `<button class="btn btn-sm btn-info" onclick="playStudentVideo('${s.videoUrl}', '${s.name}')" title="Watch pronunciation video">üé¨ Watch</button>` : '<span style="color: #888; font-size: 7px;">No video</span>'}
                    </td>
                    <td>${s.level ? `<span class="level-badge level-${s.level}">${LEVELS[s.level]}</span>` : '<span style="color: #888;">Not set</span>'}</td>
                    <td><span class="status-badge status-${s.status}">${s.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="openLevelModal('${s.id}', '${s.name}', '${s.level || ''}')">üìù</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteStudent('${s.id}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function playStudentVideo(videoUrl, studentName) {
            // Open modal with video player
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'videoPlayerModal';
            modal.innerHTML = `
                <div class="modal" style="max-width: 700px;">
                    <button class="modal-close" onclick="closeVideoPlayer()">‚úï</button>
                    <h3 class="modal-title">üé¨ ${studentName}'s Pronunciation Recording</h3>
                    <div style="text-align: center; padding: 15px;">
                        <video src="${videoUrl}" controls autoplay style="width: 100%; max-width: 640px; border-radius: 8px; background: #000;"></video>
                    </div>
                    <div style="background: rgba(255,255,0,0.1); border: 2px solid #ffff00; border-radius: 8px; padding: 10px; margin-top: 10px;">
                        <p style="font-size: 8px; color: #ffff00; margin-bottom: 5px;">üìñ Expected to read:</p>
                        <p style="font-size: 9px; color: #888;">"Ìô©ÌòºÏù¥ Ïßà Î¨¥Î†µ, ÎÇ°ÏùÄ ÏïÑÌååÌä∏ Îã®ÏßÄ ÎÜÄÏù¥ÌÑ∞ Î≤§ÏπòÏóêÎäî Ïñ∏Ï†úÎÇò Í∞ôÏùÄ ÌíçÍ≤ΩÏù¥ ÌéºÏ≥êÏ°åÎã§..."</p>
                        <p style="font-size: 9px; color: #ff9900; margin-top: 10px;">If they said <strong style="color: #00ffff;">"I do not know how to read Korean"</strong> ‚Üí Absolute Beginner level</p>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeVideoPlayer() {
            const modal = document.getElementById('videoPlayerModal');
            if (modal) modal.remove();
        }

        function updateDashboardStats() {
            document.getElementById('statTotalStudents').textContent = allStudents.length;
            document.getElementById('statAssignedStudents').textContent = allStudents.filter(s => s.status === 'assigned').length;
            document.getElementById('statPendingStudents').textContent = allStudents.filter(s => !s.level && s.status !== 'assigned' && s.status !== 'completed').length;
            document.getElementById('statLimboStudents').textContent = allStudents.filter(s => s.status === 'limbo').length;
            document.getElementById('statTotalClasses').textContent = allClasses.filter(c => c.status !== 'completed').length;
        }

        async function loadAllTeachers() {
            try {
                const snap = await db.collection('scheduler_teachers').get();
                allTeachers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderTeachersList();
            } catch (e) { console.error(e); }
        }

        function renderTeachersList() {
            const container = document.getElementById('teachersListContainer');
            if (allTeachers.length === 0) { container.innerHTML = '<p style="color: #888; font-size: 8px;">No teachers yet.</p>'; return; }
            container.innerHTML = allTeachers.map(t => {
                const tc = allClasses.filter(c => c.teacherId === t.id);
                return `<div class="teacher-card"><div class="teacher-name">üë®‚Äçüè´ ${t.name}</div><div class="teacher-classes">üìß ${t.email}<br>üìÖ ${(t.availableDays || []).join(', ')}<br>üìö ${tc.length} classes</div><button class="btn btn-sm btn-danger" onclick="deleteTeacher('${t.id}')" style="margin-top: 10px;">üóëÔ∏è</button></div>`;
            }).join('');
        }

        async function loadAllClasses() {
            try {
                const snap = await db.collection('scheduler_classes').get();
                allClasses = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderClasses(); renderLimboStudents(); updateDashboardStats();
            } catch (e) { console.error(e); }
        }

        function renderClasses() {
            const container = document.getElementById('classesContainer');
            // Only show active classes, not completed
            const activeClasses = allClasses.filter(c => c.status !== 'completed');
            if (activeClasses.length === 0) { container.innerHTML = '<p style="color: #888; font-size: 8px;">No active classes yet.</p>'; return; }
            container.innerHTML = activeClasses.map(c => {
                const teacher = allTeachers.find(t => t.id === c.teacherId);
                const available = getAvailableTeachers(c.day, c.time, c.id);
                const startDateStr = c.startDate ? new Date(c.startDate + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
                return `
                    <div class="class-card" ondragover="event.preventDefault()" ondrop="handleDrop(event, '${c.id}')">
                        <div class="class-header">
                            <div>
                                <div class="class-day">${c.day}</div>
                                <div class="class-time">${c.time} EST</div>
                                ${startDateStr ? `<div style="font-size: 7px; color: #ffff00; margin-top: 3px;">üìÖ Starts ${startDateStr}</div>` : ''}
                            </div>
                            <span class="level-badge level-${c.level}">${LEVELS[c.level]}</span>
                        </div>
                        <div class="student-list">${(c.students || []).map(s => `<div class="student-chip"><span class="rank-dot rank-${s.rank}"></span>${s.name}</div>`).join('')}</div>
                        <div style="margin-top: 10px; font-size: 7px; color: #888;">${(c.students || []).length} students</div>
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #333;">
                            ${teacher ? `<div style="color: #39ff14; font-size: 8px;">üë®‚Äçüè´ ${teacher.name}</div><button class="btn btn-sm btn-warning" onclick="unassignTeacher('${c.id}')" style="margin-top: 5px;">Remove</button>` : `<div style="font-size: 7px; color: #888; margin-bottom: 5px;">Teachers:</div><div style="display: flex; gap: 5px; flex-wrap: wrap;">${available.length > 0 ? available.map(t => `<button class="assign-btn" onclick="assignTeacherToClass('${t.id}', '${c.id}')">${t.name}</button>`).join('') : '<span style="color: #ff3366; font-size: 7px;">None</span>'}</div>`}
                        </div>
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #333; display: flex; gap: 5px;">
                            <button class="btn btn-sm btn-success" onclick="markCourseComplete('${c.id}')" style="flex: 1;">üéì Complete</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteClass('${c.id}')" title="Delete Class">üóëÔ∏è</button>
                        </div>
                        <div class="drop-zone">Drop student here</div>
                    </div>
                `;
            }).join('');
        }

        function renderLimboStudents() {
            const container = document.getElementById('limboContainer');
            const limbo = allStudents.filter(s => s.status === 'limbo');
            if (limbo.length === 0) { container.innerHTML = '<p style="color: #888; font-size: 8px;">No students in limbo.</p>'; return; }
            container.innerHTML = limbo.map(s => {
                const avail = s.availabilities || {};
                return `
                <div class="limbo-student" draggable="true" ondragstart="draggedStudentId='${s.id}'; document.querySelectorAll('.drop-zone').forEach(z=>z.classList.add('active'));" ondragend="draggedStudentId=null; document.querySelectorAll('.drop-zone').forEach(z=>z.classList.remove('active'));">
                    <div style="color: #00ffff; margin-bottom: 5px;">${s.name}</div>
                    <span class="level-badge level-${s.level}">${LEVELS[s.level]}</span>
                    <div class="limbo-availability">
                        ${avail[1] ? `<span class="avail-tag pref-1">1st: ${avail[1]}</span>` : ''}
                        ${avail[2] ? `<span class="avail-tag pref-2">2nd: ${avail[2]}</span>` : ''}
                        ${avail[3] ? `<span class="avail-tag pref-3">3rd: ${avail[3]}</span>` : ''}
                    </div>
                </div>
            `}).join('');
        }

        function getAvailableTeachers(day, time, excludeId) {
            return allTeachers.filter(t => {
                if (!(t.availableDays || []).includes(day)) return false;
                return !allClasses.find(c => c.id !== excludeId && c.teacherId === t.id && c.day === day && c.time === time);
            });
        }

        // Level Assignment
        function openLevelModal(id, name, level) {
            document.getElementById('modalStudentId').value = id;
            document.getElementById('modalStudentName').textContent = name;
            document.getElementById('levelSelect').value = level || '';
            document.getElementById('levelModal').classList.add('active');
        }

        function closeLevelModal() { document.getElementById('levelModal').classList.remove('active'); }

        async function assignStudentLevel() {
            const id = document.getElementById('modalStudentId').value;
            const level = document.getElementById('levelSelect').value;
            if (!level) { showMessage('levelModalMessage', 'Select a level', 'error'); return; }
            try {
                await db.collection('scheduler_students').doc(id).update({ level });
                const idx = allStudents.findIndex(s => s.id === id);
                if (idx !== -1) allStudents[idx].level = level;
                closeLevelModal(); renderStudentsTable(); updateDashboardStats();
            } catch (e) { showMessage('levelModalMessage', 'Error: ' + e.message, 'error'); }
        }

        async function deleteStudent(id) {
            if (!confirm('Delete this student?')) return;
            await db.collection('scheduler_students').doc(id).delete();
            allStudents = allStudents.filter(s => s.id !== id);
            renderStudentsTable(); updateDashboardStats();
        }

        // Teacher Management
        async function addNewTeacher() {
            const name = document.getElementById('newTeacherName').value.trim();
            const email = document.getElementById('newTeacherEmail').value.trim();
            const password = document.getElementById('newTeacherPassword').value;
            if (!name || !email || !password) { showMessage('addTeacherMessage', 'Fill all fields', 'error'); return; }

            if (password.length < 6) { showMessage('addTeacherMessage', 'Password must be at least 6 characters', 'error'); return; }

            const days = [];
            if (document.getElementById('teacherDaySat').checked) days.push('Saturday');
            if (document.getElementById('teacherDaySun').checked) days.push('Sunday');
            if (document.getElementById('teacherDayThu').checked) days.push('Thursday');

            try {
                console.log('Creating teacher account for:', email);
                
                // Use secondary auth to create account without logging out admin
                const userCredential = await secondaryAuth.createUserWithEmailAndPassword(email, password);
                console.log('Teacher auth account created:', userCredential.user.uid);
                
                // Sign out of secondary auth immediately
                await secondaryAuth.signOut();
                
                // Add to scheduler_teachers collection
                const ref = await db.collection('scheduler_teachers').add({ 
                    name, 
                    email, 
                    uid: userCredential.user.uid, 
                    availableDays: days, 
                    createdAt: firebase.firestore.FieldValue.serverTimestamp() 
                });
                
                // Also add to users collection with teacher role
                await db.collection('users').doc(userCredential.user.uid).set({
                    email: email,
                    name: name,
                    role: 'teacher',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                allTeachers.push({ id: ref.id, name, email, uid: userCredential.user.uid, availableDays: days });
                ['newTeacherName', 'newTeacherEmail', 'newTeacherPassword'].forEach(id => document.getElementById(id).value = '');
                renderTeachersList();
                showMessage('addTeacherMessage', 'Teacher added successfully!', 'success');
            } catch (e) { 
                console.error('Error creating teacher:', e);
                showMessage('addTeacherMessage', 'Error: ' + e.message, 'error'); 
            }
        }

        async function deleteTeacher(id) {
            if (!confirm('Delete this teacher?')) return;
            await db.collection('scheduler_teachers').doc(id).delete();
            for (const c of allClasses.filter(c => c.teacherId === id)) {
                await db.collection('scheduler_classes').doc(c.id).update({ teacherId: null });
                c.teacherId = null;
            }
            allTeachers = allTeachers.filter(t => t.id !== id);
            renderTeachersList(); renderClasses();
        }

        async function assignTeacherToClass(teacherId, classId) {
            await db.collection('scheduler_classes').doc(classId).update({ teacherId });
            const idx = allClasses.findIndex(c => c.id === classId);
            if (idx !== -1) allClasses[idx].teacherId = teacherId;
            renderClasses(); renderTeachersList();
        }

        async function unassignTeacher(classId) {
            await db.collection('scheduler_classes').doc(classId).update({ teacherId: null });
            const idx = allClasses.findIndex(c => c.id === classId);
            if (idx !== -1) allClasses[idx].teacherId = null;
            renderClasses(); renderTeachersList();
        }

        // Auto-Generate Classes
        let previewedClasses = [];
        let previewedLimboStudents = [];
        
        function autoGenerateClasses() {
            const eligible = allStudents.filter(s => s.level && s.status !== 'assigned' && s.status !== 'completed' && s.status !== 'proposed');
            if (eligible.length === 0) { alert('No eligible students with levels assigned. (Students must not be already assigned to a class)'); return; }
            
            // Generate class previews
            generateClassPreviews(eligible);
            
            document.getElementById('startDateModal').classList.add('active');
        }
        
        function generateClassPreviews(eligible) {
            previewedClasses = [];
            previewedLimboStudents = [];
            const assigned = new Set();
            
            for (const level of LEVEL_PRIORITY) {
                const levelStudents = eligible.filter(s => s.level === level && !assigned.has(s.id));
                const slotGroups = {};

                levelStudents.forEach(student => {
                    for (let rank = 1; rank <= 3; rank++) {
                        const slot = student.availabilities?.[rank];
                        if (slot) {
                            if (!slotGroups[slot]) slotGroups[slot] = { students: [], ranks: {} };
                            if (!slotGroups[slot].ranks[student.id]) {
                                slotGroups[slot].students.push(student);
                                slotGroups[slot].ranks[student.id] = rank;
                            }
                        }
                    }
                });

                for (const [slot, group] of Object.entries(slotGroups)) {
                    const unassignedInGroup = group.students.filter(s => !assigned.has(s.id));
                    if (unassignedInGroup.length >= schedulerSettings.minStudents) {
                        const classStudents = unassignedInGroup.slice(0, schedulerSettings.maxStudents);
                        const [day, time] = slot.split('-');

                        previewedClasses.push({
                            id: `preview-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                            day,
                            time,
                            level,
                            students: classStudents.map(s => ({
                                id: s.id,
                                name: s.name,
                                email: s.email,
                                discord: s.discord || '',
                                rank: group.ranks[s.id],
                                timezone: s.timezone
                            })),
                            startDate: null
                        });

                        classStudents.forEach(s => assigned.add(s.id));
                    }
                }
            }
            
            // Find limbo students
            eligible.forEach(s => {
                if (!assigned.has(s.id)) {
                    previewedLimboStudents.push(s);
                }
            });
            
            renderClassPreviews();
        }
        
        function renderClassPreviews() {
            const container = document.getElementById('classPreviewContainer');
            const limboContainer = document.getElementById('limboPreviewContainer');
            const limboList = document.getElementById('limboStudentsList');
            const generateBtn = document.getElementById('generateProposalsBtn');
            
            // Generate Saturday options for quick select
            const saturdays = getUpcomingSaturdays(5);
            
            if (previewedClasses.length === 0) {
                container.innerHTML = '<p style="color: #ff3366; font-size: 9px;">‚ùå No classes can be formed with the current students. Not enough students share the same availability.</p>';
                generateBtn.disabled = true;
                return;
            }
            
            container.innerHTML = previewedClasses.map((cls, idx) => `
                <div class="class-preview-card ${cls.startDate ? 'has-date' : ''}" id="preview-card-${idx}">
                    <div class="class-preview-header">
                        <div class="class-preview-info">
                            <strong>${cls.day} @ ${cls.time}</strong>
                            <span class="level-badge level-${cls.level}" style="margin-left: 10px;">${LEVELS[cls.level]}</span>
                        </div>
                        <span style="font-size: 8px; color: ${cls.startDate ? '#39ff14' : '#ffff00'};">
                            ${cls.startDate ? '‚úì Date Set' : '‚ö†Ô∏è Select Date'}
                        </span>
                    </div>
                    
                    <div class="class-preview-students">
                        ${cls.students.map(s => `
                            <span class="class-preview-student" title="Preference: ${s.rank}">
                                ${s.name} <span style="color: #888;">(#${s.rank})</span>
                            </span>
                        `).join('')}
                    </div>
                    
                    <div class="class-preview-date ${cls.startDate ? 'selected' : ''}">
                        <label>üìÖ Start Date:</label>
                        <input type="date" value="${cls.startDate || ''}" onchange="setPreviewClassDate(${idx}, this.value)">
                    </div>
                    
                    <div class="saturday-quick-btns">
                        ${saturdays.map(sat => {
                            const dateStr = sat.toISOString().split('T')[0];
                            const label = sat.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                            const isSelected = cls.startDate === dateStr;
                            return `<button type="button" class="saturday-quick-btn ${isSelected ? 'selected' : ''}" onclick="setPreviewClassDate(${idx}, '${dateStr}')">${label}</button>`;
                        }).join('')}
                    </div>
                </div>
            `).join('');
            
            // Show limbo students if any
            if (previewedLimboStudents.length > 0) {
                limboContainer.style.display = 'block';
                limboList.innerHTML = previewedLimboStudents.map(s => `
                    <span style="display: inline-block; padding: 5px 10px; margin: 3px; background: rgba(255,51,102,0.2); border-radius: 15px; font-size: 7px; color: #ff3366;">
                        ${s.name} (${LEVELS[s.level]})
                    </span>
                `).join('');
            } else {
                limboContainer.style.display = 'none';
            }
            
            updateGenerateButtonState();
        }
        
        function getUpcomingSaturdays(count) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const daysUntilSat = (6 - today.getDay() + 7) % 7 || 7;
            const nextSat = new Date(today);
            nextSat.setDate(today.getDate() + daysUntilSat);
            
            const saturdays = [];
            for (let i = 0; i < count; i++) {
                const sat = new Date(nextSat);
                sat.setDate(nextSat.getDate() + (i * 7));
                saturdays.push(sat);
            }
            return saturdays;
        }
        
        function getUpcomingSaturdaysHTML(proposalId, selectedDate) {
            const saturdays = getUpcomingSaturdays(5);
            return saturdays.map(sat => {
                const dateStr = sat.toISOString().split('T')[0];
                const label = sat.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const isSelected = selectedDate === dateStr;
                return `<button type="button" class="saturday-quick-btn ${isSelected ? 'selected' : ''}" onclick="updateProposalDate('${proposalId}', '${dateStr}')">${label}</button>`;
            }).join('');
        }
        
        function setPreviewClassDate(idx, date) {
            if (previewedClasses[idx]) {
                previewedClasses[idx].startDate = date;
                renderClassPreviews();
            }
        }
        
        function updateGenerateButtonState() {
            const generateBtn = document.getElementById('generateProposalsBtn');
            const allHaveDates = previewedClasses.every(cls => cls.startDate);
            generateBtn.disabled = !allHaveDates || previewedClasses.length === 0;
            
            if (!allHaveDates && previewedClasses.length > 0) {
                const missing = previewedClasses.filter(c => !c.startDate).length;
                generateBtn.textContent = `‚ö†Ô∏è ${missing} class(es) need dates`;
            } else {
                generateBtn.textContent = `‚úì Generate ${previewedClasses.length} Proposals`;
            }
        }
        
        function closeStartDateModal() {
            document.getElementById('startDateModal').classList.remove('active');
            // Note: Don't clear previewedClasses here - confirmAutoGenerate needs it
            // It will be cleared after processing or on cancel
        }
        
        function cancelStartDateModal() {
            document.getElementById('startDateModal').classList.remove('active');
            previewedClasses = [];
            previewedLimboStudents = [];
        }
        
        async function confirmAutoGenerate() {
            // Validate all classes have dates
            const classesWithoutDates = previewedClasses.filter(c => !c.startDate);
            if (classesWithoutDates.length > 0) {
                alert(`Please select a start date for all ${classesWithoutDates.length} classes.`);
                return;
            }
            
            if (previewedClasses.length === 0) {
                alert('No classes to generate.');
                return;
            }
            
            if (!confirm(`Generate ${previewedClasses.length} class proposals?`)) return;
            
            // Close modal but DON'T clear data yet
            document.getElementById('startDateModal').classList.remove('active');

            try {
                const newProposals = [];

                for (const cls of previewedClasses) {
                    const proposalData = {
                        day: cls.day,
                        time: cls.time,
                        level: cls.level,
                        students: cls.students.map(s => ({ 
                            id: s.id, 
                            name: s.name, 
                            email: s.email,
                            discord: s.discord || '',
                            rank: s.rank, 
                            timezone: s.timezone,
                            response: 'pending'
                        })),
                        teacherId: null,
                        proposedStartDate: cls.startDate,
                        status: 'draft',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    const ref = await db.collection('scheduler_proposals').add(proposalData);
                    newProposals.push({ id: ref.id, ...proposalData });

                    // Update student statuses
                    for (const s of cls.students) {
                        await db.collection('scheduler_students').doc(s.id).update({ status: 'proposed', proposalId: ref.id });
                        const idx = allStudents.findIndex(st => st.id === s.id);
                        if (idx !== -1) { allStudents[idx].status = 'proposed'; allStudents[idx].proposalId = ref.id; }
                    }
                }

                // Mark limbo students
                for (const s of previewedLimboStudents) {
                    await db.collection('scheduler_students').doc(s.id).update({ status: 'limbo' });
                    const idx = allStudents.findIndex(st => st.id === s.id);
                    if (idx !== -1) allStudents[idx].status = 'limbo';
                }

                allProposals = [...allProposals, ...newProposals];
                previewedClasses = [];
                previewedLimboStudents = [];
                
                renderStudentsTable(); renderLimboStudents(); updateDashboardStats(); renderProposals();
                
                // Switch to Proposals tab
                showAdminTab('proposals');
                
                alert(`Created ${newProposals.length} class proposals with individual start dates!`);
            } catch (e) { alert('Error: ' + e.message); console.error(e); }
        }

        // Drag & Drop
        async function handleDrop(event, classId) {
            event.preventDefault();
            if (!draggedStudentId) return;

            const student = allStudents.find(s => s.id === draggedStudentId);
            const targetClass = allClasses.find(c => c.id === classId);
            if (!student || !targetClass) return;

            const warnings = [];
            if ((targetClass.students || []).length >= schedulerSettings.maxStudents) warnings.push(`Class is full (${schedulerSettings.maxStudents} max)`);
            if (student.level !== targetClass.level) warnings.push(`Level mismatch: ${LEVELS[student.level]} vs ${LEVELS[targetClass.level]}`);

            if (warnings.length > 0) {
                pendingDropAction = { studentId: draggedStudentId, classId };
                document.getElementById('warningMessage').innerHTML = warnings.join('<br>');
                document.getElementById('warningModal').classList.add('active');
            } else {
                await executeDropAction(draggedStudentId, classId);
            }
        }

        async function executeDropAction(studentId, classId) {
            const student = allStudents.find(s => s.id === studentId);
            const targetClass = allClasses.find(c => c.id === classId);

            let rank = 3;
            const classSlot = `${targetClass.day}-${targetClass.time}`;
            Object.entries(student.availabilities || {}).forEach(([r, slot]) => { if (slot === classSlot) rank = parseInt(r); });

            targetClass.students = targetClass.students || [];
            targetClass.students.push({ id: student.id, name: student.name, rank, timezone: student.timezone });

            await db.collection('scheduler_classes').doc(classId).update({ students: targetClass.students });
            await db.collection('scheduler_students').doc(studentId).update({ status: 'assigned', classId });

            const idx = allStudents.findIndex(s => s.id === studentId);
            if (idx !== -1) { allStudents[idx].status = 'assigned'; allStudents[idx].classId = classId; }

            renderClasses(); renderLimboStudents(); renderStudentsTable(); updateDashboardStats();
        }

        function closeWarningModal() { document.getElementById('warningModal').classList.remove('active'); pendingDropAction = null; }
        async function confirmWarningAction() { if (pendingDropAction) await executeDropAction(pendingDropAction.studentId, pendingDropAction.classId); closeWarningModal(); }

        // Settings
        async function saveSettings() {
            schedulerSettings.minStudents = parseInt(document.getElementById('settingMinStudents').value) || 5;
            schedulerSettings.maxStudents = parseInt(document.getElementById('settingMaxStudents').value) || 10;
            schedulerSettings.currentWeek = parseInt(document.getElementById('settingCurrentWeek').value) || 1;
            schedulerSettings.startDate = document.getElementById('settingStartDate').value || null;
            await db.collection('scheduler_settings').doc('main').set(schedulerSettings, { merge: true });
            updateWeekTrackers();
            renderCourseCalendar();
            showMessage('settingsMessage', 'Settings saved!', 'success');
        }

        // Materials (simplified)
        async function loadMaterialsForLevel() {
            const level = document.getElementById('materialLevelSelect').value;
            try {
                const snap = await db.collection('scheduler_materials').where('level', '==', level).orderBy('order').get();
                const materials = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderMaterials(materials);
            } catch (e) {
                document.getElementById('materialsContainer').innerHTML = '<p style="color: #888; font-size: 8px;">No materials yet.</p>';
            }
        }

        function renderMaterials(materials) {
            const container = document.getElementById('materialsContainer');
            if (materials.length === 0) { container.innerHTML = '<p style="color: #888; font-size: 8px;">No materials yet.</p>'; return; }
            container.innerHTML = materials.map(m => `
                <div class="material-block">
                    <div class="material-header"><span class="material-type">${m.type}</span>
                        <div><button class="btn btn-sm btn-info" onclick="editMaterial('${m.id}')">‚úèÔ∏è</button><button class="btn btn-sm btn-danger" onclick="deleteMaterial('${m.id}')">üóëÔ∏è</button></div>
                    </div>
                    <div class="material-content">${renderMaterialContent(m)}</div>
                </div>
            `).join('');
        }

        function renderMaterialContent(m) {
            if (m.type === 'text') return `<div>${m.content}</div>`;
            if (m.type === 'link') return `<a href="${m.url}" target="_blank">${m.title || m.url}</a>`;
            if (m.type === 'image') return `<img src="${m.url}" alt="">`;
            if (m.type === 'file') return `<a href="${m.url}" download>üìÅ ${m.filename || 'Download'}</a>`;
            return '';
        }

        function addMaterialBlock(type) {
            document.getElementById('editingMaterialId').value = '';
            document.getElementById('editingMaterialType').value = type;
            document.getElementById('materialModalTitle').textContent = `Add ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            const form = document.getElementById('materialFormContainer');

            if (type === 'text') form.innerHTML = '<div class="form-group"><label>Content</label><textarea id="materialContent" rows="5" placeholder="Enter text..."></textarea></div>';
            else if (type === 'link') form.innerHTML = '<div class="form-group"><label>URL</label><input type="url" id="materialUrl" placeholder="https://..."></div><div class="form-group"><label>Title</label><input type="text" id="materialTitle" placeholder="Link title"></div>';
            else if (type === 'image') form.innerHTML = '<div class="form-group"><label>Image URL</label><input type="url" id="materialUrl" placeholder="https://..."></div><div class="form-group"><label>Caption</label><input type="text" id="materialCaption" placeholder="Caption"></div>';
            else if (type === 'file') form.innerHTML = '<div class="form-group"><label>File URL</label><input type="url" id="materialUrl" placeholder="https://..."></div><div class="form-group"><label>Filename</label><input type="text" id="materialFilename" placeholder="document.pdf"></div>';

            document.getElementById('materialModal').classList.add('active');
        }

        function closeMaterialModal() { document.getElementById('materialModal').classList.remove('active'); }

        async function saveMaterial() {
            const type = document.getElementById('editingMaterialType').value;
            const level = document.getElementById('materialLevelSelect').value;
            const id = document.getElementById('editingMaterialId').value;

            const data = { type, level, order: Date.now() };
            if (type === 'text') data.content = document.getElementById('materialContent').value;
            else if (type === 'link') { data.url = document.getElementById('materialUrl').value; data.title = document.getElementById('materialTitle').value; }
            else if (type === 'image') { data.url = document.getElementById('materialUrl').value; data.caption = document.getElementById('materialCaption')?.value; }
            else if (type === 'file') { data.url = document.getElementById('materialUrl').value; data.filename = document.getElementById('materialFilename').value; }

            try {
                if (id) await db.collection('scheduler_materials').doc(id).update(data);
                else await db.collection('scheduler_materials').add(data);
                closeMaterialModal();
                loadMaterialsForLevel();
            } catch (e) { showMessage('materialModalMessage', 'Error: ' + e.message, 'error'); }
        }

        async function editMaterial(id) {
            const doc = await db.collection('scheduler_materials').doc(id).get();
            if (!doc.exists) return;
            const m = doc.data();
            document.getElementById('editingMaterialId').value = id;
            addMaterialBlock(m.type);
            setTimeout(() => {
                if (m.type === 'text') document.getElementById('materialContent').value = m.content || '';
                else if (m.type === 'link') { document.getElementById('materialUrl').value = m.url || ''; document.getElementById('materialTitle').value = m.title || ''; }
                else if (m.type === 'image') { document.getElementById('materialUrl').value = m.url || ''; if (document.getElementById('materialCaption')) document.getElementById('materialCaption').value = m.caption || ''; }
                else if (m.type === 'file') { document.getElementById('materialUrl').value = m.url || ''; document.getElementById('materialFilename').value = m.filename || ''; }
            }, 100);
        }

        async function deleteMaterial(id) {
            if (!confirm('Delete this material?')) return;
            await db.collection('scheduler_materials').doc(id).delete();
            loadMaterialsForLevel();
        }

        // Teacher Materials
        async function loadTeacherMaterials() {
            const level = document.getElementById('teacherMaterialLevel').value;
            try {
                const snap = await db.collection('scheduler_materials').where('level', '==', level).orderBy('order').get();
                const materials = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                const container = document.getElementById('teacherMaterialsDisplay');
                if (materials.length === 0) { container.innerHTML = '<p style="color: #888; font-size: 8px;">No materials.</p>'; return; }
                container.innerHTML = materials.map(m => `<div class="material-block"><div class="material-header"><span class="material-type">${m.type}</span></div><div class="material-content">${renderMaterialContent(m)}</div></div>`).join('');
            } catch (e) { document.getElementById('teacherMaterialsDisplay').innerHTML = '<p style="color: #888; font-size: 8px;">No materials.</p>'; }
        }

        // Teacher Classes
        async function loadTeacherClasses() {
            if (!currentUser) return;
            try {
                const snap = await db.collection('scheduler_classes').where('teacherId', '==', currentUser.odId).get();
                const classes = snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(c => c.status !== 'completed');
                const container = document.getElementById('teacherClassesContainer');

                if (classes.length === 0) { container.innerHTML = '<p style="color: #888; font-size: 8px;">No classes assigned.</p>'; return; }

                // Clear attendance cache for current week and reload from Firebase
                const currentWeek = schedulerSettings.currentWeek;
                
                // Clear cache entries for current week
                Object.keys(attendanceCache).forEach(key => {
                    if (key.endsWith(`_${currentWeek}`)) {
                        delete attendanceCache[key];
                    }
                });
                
                // Load fresh attendance data for current week from Firebase
                // Using simpler query to avoid composite index requirement
                for (const cls of classes) {
                    try {
                        const attendanceSnap = await db.collection('scheduler_attendance')
                            .where('classId', '==', cls.id)
                            .get();
                        
                        attendanceSnap.docs.forEach(doc => {
                            const data = doc.data();
                            // Only cache data for current week
                            if (data.week === currentWeek) {
                                const key = `${data.classId}_${data.studentId}_${data.week}`;
                                attendanceCache[key] = data.status;
                            }
                        });
                    } catch (err) {
                        console.error('Error loading attendance for class:', cls.id, err);
                    }
                }

                container.innerHTML = classes.map(c => `
                    <div class="class-card">
                        <div class="class-header">
                            <div><div class="class-day">${c.day}</div><div class="class-time">${c.time} EST</div></div>
                            <span class="level-badge level-${c.level}">${LEVELS[c.level]}</span>
                        </div>
                        <h4 style="color: #ffff00; font-size: 9px; margin: 10px 0;">Attendance - Week ${schedulerSettings.currentWeek}</h4>
                        <div style="display: grid; gap: 10px;">
                            ${(c.students || []).map(s => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 5px;">
                                    <span style="cursor: pointer; text-decoration: underline; color: #00ffff;" onclick="openStudentDetailsModal('${s.id}')">${s.name}</span>
                                    <div style="display: flex; gap: 5px;">
                                        <button class="attendance-btn present ${getAttendanceStatus(c.id, s.id, schedulerSettings.currentWeek) === 'present' ? 'active' : ''}" onclick="markAttendance('${c.id}', '${s.id}', 'present')">P</button>
                                        <button class="attendance-btn late ${getAttendanceStatus(c.id, s.id, schedulerSettings.currentWeek) === 'late' ? 'active' : ''}" onclick="markAttendance('${c.id}', '${s.id}', 'late')">L</button>
                                        <button class="attendance-btn absent ${getAttendanceStatus(c.id, s.id, schedulerSettings.currentWeek) === 'absent' ? 'active' : ''}" onclick="handleAbsentClick('${c.id}', '${s.id}', '${s.name}')">A</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');

                // Populate attendance dropdown
                const select = document.getElementById('attendanceClassSelect');
                select.innerHTML = '<option value="">-- Select --</option>' + classes.map(c => `<option value="${c.id}">${c.day} ${c.time} - ${LEVELS[c.level]}</option>`).join('');
            } catch (e) { console.error(e); }
        }

        let attendanceCache = {};

        function getAttendanceStatus(classId, studentId, week) {
            const key = `${classId}_${studentId}_${week}`;
            return attendanceCache[key] || '';
        }
        
        // Handle absent button click - show modal
        function handleAbsentClick(classId, studentId, studentName) {
            openAbsenceModal(classId, studentId, studentName);
        }

        async function markAttendance(classId, studentId, status) {
            const week = schedulerSettings.currentWeek;
            const key = `${classId}_${studentId}_${week}`;
            attendanceCache[key] = status;

            try {
                console.log('Saving attendance:', { classId, studentId, week, status, key });
                await db.collection('scheduler_attendance').doc(key).set({ 
                    classId, 
                    studentId, 
                    week, 
                    status, 
                    timestamp: firebase.firestore.FieldValue.serverTimestamp() 
                }, { merge: true });
                console.log('Attendance saved successfully');
                loadTeacherClasses();
                
                // Check if all students marked in Week 6 (for reminder)
                if (week === 6 && currentUser?.role === 'teacher') {
                    checkClassAttendanceComplete(classId);
                }
            } catch (e) { 
                console.error('Error saving attendance:', e); 
                alert('Error saving attendance: ' + e.message);
            }
        }

        async function loadAttendanceHistory() {
            const classId = document.getElementById('attendanceClassSelect').value;
            const tbody = document.getElementById('attendanceHistoryBody');
            if (!classId) { tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #888;">Select a class</td></tr>'; return; }

            try {
                const classDoc = await db.collection('scheduler_classes').doc(classId).get();
                if (!classDoc.exists) return;
                const classData = classDoc.data();
                const students = classData.students || [];

                const attendanceSnap = await db.collection('scheduler_attendance').where('classId', '==', classId).get();
                const attendanceMap = {};
                attendanceSnap.docs.forEach(d => { const data = d.data(); attendanceMap[`${data.studentId}_${data.week}`] = data.status; });

                tbody.innerHTML = students.map(s => `
                    <tr>
                        <td>${s.name}</td>
                        ${[1,2,3,4,5,6].map(w => {
                            const status = attendanceMap[`${s.id}_${w}`] || '-';
                            const cls = status === 'present' ? 'history-present' : status === 'late' ? 'history-late' : status === 'absent' ? 'history-absent' : '';
                            return `<td class="${cls}" style="text-align: center;">${status === 'present' ? 'P' : status === 'late' ? 'L' : status === 'absent' ? 'A' : '-'}</td>`;
                        }).join('')}
                    </tr>
                `).join('');
            } catch (e) { console.error(e); }
        }

        // ==================== SCHEDULE RENDERING ====================
        
        function renderAdminSchedule() {
            const grid = document.getElementById('adminScheduleGrid');
            const totalSlots = TIME_SLOTS.length * DAYS.length;
            
            // Filter to only active classes (not completed)
            const activeClassList = allClasses.filter(c => c.status !== 'completed');
            
            // Build a map of classes by day and time
            const classMap = {};
            DAYS.forEach(day => {
                classMap[day] = {};
                TIME_SLOTS.forEach(time => {
                    classMap[day][time] = [];
                });
            });
            
            // Populate the map with active classes only
            activeClassList.forEach(cls => {
                if (classMap[cls.day] && classMap[cls.day][cls.time]) {
                    classMap[cls.day][cls.time].push(cls);
                }
            });
            
            // Calculate stats (only for active classes)
            let activeClasses = 0;
            let needsTeacher = 0;
            let fullClasses = 0;
            let emptySlots = 0;
            let totalAvailableSpots = 0;
            
            activeClassList.forEach(cls => {
                const studentCount = (cls.students || []).length;
                const spotsLeft = schedulerSettings.maxStudents - studentCount;
                
                if (cls.teacherId) {
                    activeClasses++;
                } else {
                    needsTeacher++;
                }
                
                if (studentCount >= schedulerSettings.maxStudents) {
                    fullClasses++;
                } else {
                    totalAvailableSpots += spotsLeft;
                }
            });
            
            // Count empty slots
            DAYS.forEach(day => {
                TIME_SLOTS.forEach(time => {
                    if (classMap[day][time].length === 0) {
                        emptySlots++;
                    }
                });
            });
            
            // Update summary stats
            document.getElementById('schedTotalSlots').textContent = totalSlots;
            document.getElementById('schedActiveClasses').textContent = activeClasses;
            document.getElementById('schedNeedsTeacher').textContent = needsTeacher;
            document.getElementById('schedFullClasses').textContent = fullClasses;
            document.getElementById('schedEmptySlots').textContent = emptySlots;
            document.getElementById('schedAvailableSpots').textContent = totalAvailableSpots;
            
            // Get current week dates for schedule header
            const weekDates = getWeekDates(schedulerSettings.currentWeek);
            let satDate = '', sunDate = '';
            if (weekDates) {
                const start = weekDates.start;
                const satOffset = (6 - start.getDay() + 7) % 7;
                const sat = new Date(start);
                sat.setDate(start.getDate() + satOffset);
                const sun = new Date(sat);
                sun.setDate(sat.getDate() + 1);
                satDate = sat.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                sunDate = sun.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
            
            // Build the grid HTML
            let html = '';
            
            // Header row with dates
            html += '<div class="schedule-header">TIME (EST)</div>';
            DAYS.forEach(day => {
                const dateStr = day === 'Saturday' ? satDate : sunDate;
                html += `<div class="schedule-header">${day.toUpperCase()}${dateStr ? `<br><span style="font-size: 7px; color: #ffff00;">${dateStr}</span>` : ''}</div>`;
            });
            
            // Time rows
            TIME_SLOTS.forEach(time => {
                html += `<div class="schedule-time">${time}</div>`;
                
                DAYS.forEach(day => {
                    const classes = classMap[day][time];
                    let cellClass = 'schedule-cell';
                    
                    if (classes.length === 0) {
                        cellClass += ' empty';
                        html += `<div class="${cellClass}"><div style="color: #666; font-size: 7px; text-align: center;">No class</div></div>`;
                    } else {
                        html += `<div class="${cellClass} has-class">`;
                        
                        classes.forEach(cls => {
                            const teacher = allTeachers.find(t => t.id === cls.teacherId);
                            const studentCount = (cls.students || []).length;
                            const isFull = studentCount >= schedulerSettings.maxStudents;
                            const needsTeacherFlag = !cls.teacherId;
                            
                            let blockClass = 'schedule-class-block clickable';
                            if (isFull) blockClass += ' full';
                            else if (needsTeacherFlag) blockClass += ' no-teacher';
                            
                            html += `
                                <div class="${blockClass}" onclick="openClassDetails('${cls.id}')">
                                    <div class="schedule-class-level">${LEVELS[cls.level]}</div>
                                    <div class="schedule-class-students">üë• ${studentCount}/${schedulerSettings.maxStudents}</div>
                                    <div class="schedule-class-info">${isFull ? 'üî¥ FULL' : `üü¢ ${schedulerSettings.maxStudents - studentCount} spots`}</div>
                                    ${teacher 
                                        ? `<div class="schedule-class-teacher">üë®‚Äçüè´ ${teacher.name}</div>` 
                                        : `<div style="color: #ffff00; font-size: 7px;">‚ö†Ô∏è No teacher</div>`
                                    }
                                </div>
                            `;
                        });
                        
                        html += '</div>';
                    }
                });
            });
            
            grid.innerHTML = html;
        }
        
        function renderTeacherSchedule() {
            const grid = document.getElementById('teacherScheduleGrid');
            const classes = allClassesForTeacher || [];
            
            // Build a map of classes by day and time
            const classMap = {};
            DAYS.forEach(day => {
                classMap[day] = {};
                TIME_SLOTS.forEach(time => {
                    classMap[day][time] = null;
                });
            });
            
            // Find teacher's active classes (not completed)
            const myClasses = classes.filter(c => c.teacherId === currentUser.odId && c.status !== 'completed');
            
            myClasses.forEach(cls => {
                if (classMap[cls.day]) {
                    classMap[cls.day][cls.time] = cls;
                }
            });
            
            // Calculate stats
            let totalStudents = 0;
            let fullClasses = 0;
            let availableSpots = 0;
            
            myClasses.forEach(cls => {
                const studentCount = (cls.students || []).length;
                totalStudents += studentCount;
                
                if (studentCount >= schedulerSettings.maxStudents) {
                    fullClasses++;
                } else {
                    availableSpots += (schedulerSettings.maxStudents - studentCount);
                }
            });
            
            // Update summary stats
            document.getElementById('teacherTotalClasses').textContent = myClasses.length;
            document.getElementById('teacherTotalStudents').textContent = totalStudents;
            document.getElementById('teacherFullClasses').textContent = fullClasses;
            document.getElementById('teacherAvailableSpots').textContent = availableSpots;
            
            // Get current week dates for schedule header
            const weekDates = getWeekDates(schedulerSettings.currentWeek);
            let satDate = '', sunDate = '';
            if (weekDates) {
                const start = weekDates.start;
                const satOffset = (6 - start.getDay() + 7) % 7;
                const sat = new Date(start);
                sat.setDate(start.getDate() + satOffset);
                const sun = new Date(sat);
                sun.setDate(sat.getDate() + 1);
                satDate = sat.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                sunDate = sun.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }
            
            // Build the grid HTML
            let html = '';
            
            // Header row with dates
            html += '<div class="schedule-header">TIME (EST)</div>';
            DAYS.forEach(day => {
                const dateStr = day === 'Saturday' ? satDate : sunDate;
                html += `<div class="schedule-header">${day.toUpperCase()}${dateStr ? `<br><span style="font-size: 7px; color: #ffff00;">${dateStr}</span>` : ''}</div>`;
            });
            
            // Time rows
            TIME_SLOTS.forEach(time => {
                html += `<div class="schedule-time">${time}</div>`;
                
                DAYS.forEach(day => {
                    const cls = classMap[day][time];
                    let cellClass = 'schedule-cell';
                    
                    if (!cls) {
                        cellClass += ' empty';
                        html += `<div class="${cellClass}"><div style="color: #666; font-size: 7px; text-align: center;">-</div></div>`;
                    } else {
                        const studentCount = (cls.students || []).length;
                        const isFull = studentCount >= schedulerSettings.maxStudents;
                        
                        cellClass += isFull ? ' full' : ' has-class';
                        
                        html += `
                            <div class="${cellClass}">
                                <div class="schedule-class-block clickable ${isFull ? 'full' : ''}" onclick="openClassDetails('${cls.id}')">
                                    <div class="schedule-class-level">${LEVELS[cls.level]}</div>
                                    <div class="schedule-class-students">üë• ${studentCount}/${schedulerSettings.maxStudents}</div>
                                    <div class="schedule-class-info">${isFull ? 'üî¥ FULL' : `üü¢ ${schedulerSettings.maxStudents - studentCount} spots left`}</div>
                                </div>
                            </div>
                        `;
                    }
                });
            });
            
            grid.innerHTML = html;
        }

        // ==================== CLASS DETAILS MODAL ====================
        
        async function openClassDetails(classId) {
            const cls = allClasses.find(c => c.id === classId) || allClassesForTeacher.find(c => c.id === classId);
            if (!cls) return;
            
            const teacher = allTeachers.find(t => t.id === cls.teacherId);
            
            // Load attendance data for this class
            let attendanceMap = {};
            let contactedMap = {};
            try {
                const attendanceSnap = await db.collection('scheduler_attendance').where('classId', '==', classId).get();
                attendanceSnap.docs.forEach(d => {
                    const data = d.data();
                    attendanceMap[`${data.studentId}_${data.week}`] = { status: data.status, reason: data.reason || null };
                });
                
                // Load contacted status
                const contactedSnap = await db.collection('scheduler_contacted').where('classId', '==', classId).get();
                contactedSnap.docs.forEach(d => {
                    const data = d.data();
                    contactedMap[data.studentId] = data.contacted;
                });
            } catch (e) { console.error(e); }
            
            // Get full student data
            const studentIds = (cls.students || []).map(s => s.id);
            const fullStudentData = {};
            for (const sid of studentIds) {
                const studentDoc = allStudents.find(s => s.id === sid);
                if (studentDoc) {
                    fullStudentData[sid] = studentDoc;
                }
            }
            
            // Header
            document.getElementById('classDetailsHeader').innerHTML = `
                <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                    <div>
                        <div style="color: #ffff00; font-size: 10px;">${cls.day} @ ${cls.time} EST</div>
                        <span class="level-badge level-${cls.level}">${LEVELS[cls.level]}</span>
                    </div>
                    <div style="text-align: right;">
                        ${teacher ? `<div style="color: #39ff14; font-size: 9px;">üë®‚Äçüè´ ${teacher.name}</div>` : '<div style="color: #ff3366; font-size: 9px;">‚ö†Ô∏è No teacher assigned</div>'}
                        <div style="color: #888; font-size: 8px;">üë• ${(cls.students || []).length} students</div>
                    </div>
                </div>
            `;
            
            // Students list
            let studentsHtml = '';
            for (const student of (cls.students || [])) {
                const fullData = fullStudentData[student.id] || {};
                const phone = fullData.phone || '';
                
                // Check if student has any absences
                let hasAbsence = false;
                let absenceWeeks = [];
                for (let w = 1; w <= 6; w++) {
                    const att = attendanceMap[`${student.id}_${w}`];
                    if (att && att.status === 'absent') {
                        hasAbsence = true;
                        absenceWeeks.push(w);
                    }
                }
                
                const isContacted = contactedMap[student.id] || false;
                
                studentsHtml += `
                    <div class="student-detail-row ${hasAbsence ? 'absent-student' : ''}">
                        <div class="student-detail-header">
                            <div class="student-detail-name">${student.name}</div>
                            <div class="rank-dot rank-${student.rank}" style="width: 12px; height: 12px;" title="Preference #${student.rank}"></div>
                        </div>
                        <div class="student-detail-info">üìß ${fullData.email || 'N/A'} | üåç ${fullData.timezone || 'N/A'}</div>
                        
                        <div class="student-detail-attendance">
                            ${[1,2,3,4,5,6].map(w => {
                                const att = attendanceMap[`${student.id}_${w}`];
                                const status = att?.status || '';
                                const reason = att?.reason || '';
                                let cls = 'attendance-week';
                                let text = `W${w}: -`;
                                if (status === 'present') { cls += ' present'; text = `W${w}: P`; }
                                else if (status === 'late') { cls += ' late'; text = `W${w}: L`; }
                                else if (status === 'absent') { cls += ' absent'; text = `W${w}: A`; }
                                return `<span class="${cls}" title="${reason ? 'Reason: ' + reason : 'No reason'}">${text}</span>`;
                            }).join('')}
                        </div>
                        
                        ${hasAbsence ? `
                            <div class="student-detail-phone ${hasAbsence ? 'visible' : ''}">
                                üìû ${phone ? `<a href="tel:${phone}">${phone}</a>` : 'No phone number'}
                            </div>
                            ${absenceWeeks.map(w => {
                                const att = attendanceMap[`${student.id}_${w}`];
                                return att?.reason ? `<div class="absence-reason-display">Week ${w} reason: ${att.reason}</div>` : `<div class="absence-reason-display" style="color: #ff3366;">Week ${w}: No reason given</div>`;
                            }).join('')}
                            <div class="contacted-row ${hasAbsence ? 'visible' : ''}">
                                <label class="contacted-checkbox">
                                    <input type="checkbox" ${isContacted ? 'checked' : ''} onchange="markStudentContacted('${classId}', '${student.id}', this.checked)">
                                    <span>‚úÖ Student has been contacted</span>
                                </label>
                            </div>
                        ` : ''}
                        
                        ${currentUser?.role === 'admin' ? `
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #333;">
                                <button class="btn btn-sm btn-warning" onclick="closeClassDetailsModal(); openMoveStudentModal('${student.id}', '${student.name}', '${classId}')">üîÑ Move Student</button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            document.getElementById('classStudentsList').innerHTML = studentsHtml || '<p style="color: #888; font-size: 8px;">No students in this class.</p>';
            document.getElementById('classDetailsModal').classList.add('active');
        }
        
        function closeClassDetailsModal() {
            document.getElementById('classDetailsModal').classList.remove('active');
        }
        
        async function markStudentContacted(classId, studentId, contacted) {
            try {
                await db.collection('scheduler_contacted').doc(`${classId}_${studentId}`).set({
                    classId,
                    studentId,
                    contacted,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            } catch (e) { console.error(e); }
        }

        // ==================== ABSENCE REASON MODAL ====================
        
        function openAbsenceModal(classId, studentId, studentName) {
            document.getElementById('absenceClassId').value = classId;
            document.getElementById('absenceStudentId').value = studentId;
            document.getElementById('absenceStudentName').textContent = studentName;
            document.getElementById('absenceReasonForm').style.display = 'none';
            document.getElementById('absenceSubmitBtn').style.display = 'none';
            document.getElementById('absenceReasonText').value = '';
            document.getElementById('absenceModal').classList.add('active');
        }
        
        function closeAbsenceModal() {
            document.getElementById('absenceModal').classList.remove('active');
        }
        
        function showAbsenceReasonForm() {
            document.getElementById('absenceReasonForm').style.display = 'block';
            document.getElementById('absenceSubmitBtn').style.display = 'block';
        }
        
        async function markAbsentNoReason() {
            const classId = document.getElementById('absenceClassId').value;
            const studentId = document.getElementById('absenceStudentId').value;
            const week = schedulerSettings.currentWeek;
            const key = `${classId}_${studentId}_${week}`;
            
            try {
                await db.collection('scheduler_attendance').doc(key).set({
                    classId,
                    studentId,
                    week,
                    status: 'absent',
                    reason: null,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                attendanceCache[key] = 'absent';
                closeAbsenceModal();
                loadTeacherClasses();
            } catch (e) { console.error(e); }
        }
        
        async function submitAbsenceWithReason() {
            const classId = document.getElementById('absenceClassId').value;
            const studentId = document.getElementById('absenceStudentId').value;
            const reason = document.getElementById('absenceReasonText').value.trim();
            const week = schedulerSettings.currentWeek;
            const key = `${classId}_${studentId}_${week}`;
            
            if (!reason) {
                alert('Please enter the reason for absence.');
                return;
            }
            
            try {
                await db.collection('scheduler_attendance').doc(key).set({
                    classId,
                    studentId,
                    week,
                    status: 'absent',
                    reason: reason,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                attendanceCache[key] = 'absent';
                closeAbsenceModal();
                loadTeacherClasses();
            } catch (e) { console.error(e); }
        }

        // ==================== ABSENCES LIST ====================
        
        let allAbsencesData = [];
        
        async function loadAbsencesList() {
            const container = document.getElementById('absencesListContainer');
            container.innerHTML = '<p style="color: #888; font-size: 8px;">Loading absences...</p>';
            
            const weekFilter = document.getElementById('absenceWeekFilter').value;
            
            try {
                // Get all attendance records marked as absent
                let query = db.collection('scheduler_attendance').where('status', '==', 'absent');
                
                if (weekFilter !== 'all') {
                    query = query.where('week', '==', parseInt(weekFilter));
                }
                
                const attendanceSnap = await query.get();
                
                if (attendanceSnap.empty) {
                    container.innerHTML = '<p style="color: #888; font-size: 8px;">No absences found.</p>';
                    updateAbsenceStats(0, 0, 0);
                    return;
                }
                
                // Get contacted statuses
                const contactedSnap = await db.collection('scheduler_contacted').get();
                const contactedMap = {};
                contactedSnap.docs.forEach(d => {
                    const data = d.data();
                    contactedMap[data.studentId] = data.contacted;
                });
                
                // Build the absences data
                allAbsencesData = [];
                
                for (const doc of attendanceSnap.docs) {
                    const data = doc.data();
                    
                    // Get student info
                    const student = allStudents.find(s => s.id === data.studentId);
                    
                    // Get class info
                    const cls = allClasses.find(c => c.id === data.classId);
                    
                    if (student && cls) {
                        allAbsencesData.push({
                            id: doc.id,
                            studentId: data.studentId,
                            classId: data.classId,
                            week: data.week,
                            reason: data.reason || null,
                            studentName: student.name,
                            studentEmail: student.email,
                            studentPhone: student.phone || '',
                            classDay: cls.day,
                            classTime: cls.time,
                            classLevel: cls.level,
                            contacted: contactedMap[data.studentId] || false,
                            timestamp: data.timestamp
                        });
                    }
                }
                
                // Sort by week (descending), then by student name
                allAbsencesData.sort((a, b) => {
                    if (b.week !== a.week) return b.week - a.week;
                    return a.studentName.localeCompare(b.studentName);
                });
                
                renderAbsencesList();
                
            } catch (e) { 
                console.error(e);
                container.innerHTML = `<p style="color: #ff3366; font-size: 8px;">Error: ${e.message}</p>`;
            }
        }
        
        function renderAbsencesList() {
            const container = document.getElementById('absencesListContainer');
            const contactFilter = document.getElementById('absenceContactFilter').value;
            
            let filteredData = allAbsencesData;
            
            if (contactFilter === 'contacted') {
                filteredData = allAbsencesData.filter(a => a.contacted);
            } else if (contactFilter === 'not-contacted') {
                filteredData = allAbsencesData.filter(a => !a.contacted);
            }
            
            // Update stats
            const totalAbsences = allAbsencesData.length;
            const contactedCount = allAbsencesData.filter(a => a.contacted).length;
            const notContactedCount = allAbsencesData.filter(a => !a.contacted).length;
            updateAbsenceStats(totalAbsences, contactedCount, notContactedCount);
            
            if (filteredData.length === 0) {
                container.innerHTML = '<p style="color: #888; font-size: 8px;">No absences match the current filter.</p>';
                return;
            }
            
            container.innerHTML = filteredData.map(a => `
                <div class="absence-item ${a.contacted ? 'contacted' : 'not-contacted'}">
                    <div class="absence-item-info">
                        <div class="absence-item-name">${a.studentName}</div>
                        <div class="absence-item-details">üìß ${a.studentEmail}</div>
                        <div class="absence-item-class">üìö ${a.classDay} @ ${a.classTime} EST - ${LEVELS[a.classLevel]}</div>
                        ${a.reason ? `<div class="absence-item-reason">üí¨ "${a.reason}"</div>` : '<div class="absence-item-reason" style="color: #ff3366;">‚ö†Ô∏è No reason given</div>'}
                        ${a.studentPhone ? `<div class="absence-item-phone">üìû <a href="tel:${a.studentPhone}">${a.studentPhone}</a></div>` : '<div class="absence-item-phone" style="color: #888;">üìû No phone</div>'}
                    </div>
                    <div class="absence-item-status">
                        <div class="absence-week-badge">Week ${a.week}</div>
                        <div class="absence-status-badge ${a.contacted ? 'contacted' : 'not-contacted'}">
                            ${a.contacted ? '‚úÖ CONTACTED' : '‚ùå NOT CONTACTED'}
                        </div>
                        <label class="contacted-checkbox" style="margin-top: 5px;">
                            <input type="checkbox" ${a.contacted ? 'checked' : ''} onchange="updateAbsenceContacted('${a.classId}', '${a.studentId}', this.checked)">
                            <span style="font-size: 7px;">Mark contacted</span>
                        </label>
                    </div>
                </div>
            `).join('');
        }
        
        function filterAbsencesList() {
            renderAbsencesList();
        }
        
        function updateAbsenceStats(total, contacted, notContacted) {
            document.getElementById('absenceTotalCount').textContent = total;
            document.getElementById('absenceContactedCount').textContent = contacted;
            document.getElementById('absenceNotContactedCount').textContent = notContacted;
        }
        
        async function updateAbsenceContacted(classId, studentId, contacted) {
            try {
                await db.collection('scheduler_contacted').doc(`${classId}_${studentId}`).set({
                    classId,
                    studentId,
                    contacted,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                // Update local data
                allAbsencesData.forEach(a => {
                    if (a.studentId === studentId) {
                        a.contacted = contacted;
                    }
                });
                
                renderAbsencesList();
            } catch (e) { console.error(e); }
        }

        // ==================== MONTHLY CALENDAR ====================
        
        let calendarMonth = new Date().getMonth();
        let calendarYear = new Date().getFullYear();
        
        function changeCalendarMonth(delta) {
            calendarMonth += delta;
            if (calendarMonth > 11) { calendarMonth = 0; calendarYear++; }
            if (calendarMonth < 0) { calendarMonth = 11; calendarYear--; }
            renderMonthlyCalendar();
        }
        
        function renderMonthlyCalendar() {
            const grid = document.getElementById('monthlyCalendarGrid');
            const label = document.getElementById('calendarMonthLabel');
            if (!grid || !label) return;
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            label.textContent = `${monthNames[calendarMonth]} ${calendarYear}`;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Course dates
            let courseStart = null, courseEnd = null;
            if (schedulerSettings.startDate) {
                courseStart = new Date(schedulerSettings.startDate + 'T00:00:00');
                courseEnd = getCourseEndDate();
            }
            
            // Get first day of month and number of days
            const firstDay = new Date(calendarYear, calendarMonth, 1);
            const lastDay = new Date(calendarYear, calendarMonth + 1, 0);
            const startDayOfWeek = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            
            // Build class schedule map for quick lookup
            const classDays = {};
            allClasses.filter(c => c.status !== 'completed').forEach(cls => {
                // For each week of the course, calculate the actual date
                for (let week = 1; week <= 6; week++) {
                    const weekDates = getWeekDates(week);
                    if (!weekDates) continue;
                    
                    const dayOffset = cls.day === 'Saturday' ? 6 : 0;
                    const classDate = new Date(weekDates.start);
                    classDate.setDate(weekDates.start.getDate() + ((dayOffset - weekDates.start.getDay() + 7) % 7));
                    
                    const dateKey = `${classDate.getFullYear()}-${classDate.getMonth()}-${classDate.getDate()}`;
                    if (!classDays[dateKey]) classDays[dateKey] = [];
                    classDays[dateKey].push({ ...cls, week });
                }
            });
            
            // Store in global map for click handling
            calendarClassMap = { ...calendarClassMap, ...classDays };
            
            let html = '';
            
            // Day headers
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                html += `<div class="calendar-header">${day}</div>`;
            });
            
            // Previous month days
            const prevMonth = new Date(calendarYear, calendarMonth, 0);
            for (let i = startDayOfWeek - 1; i >= 0; i--) {
                const day = prevMonth.getDate() - i;
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }
            
            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(calendarYear, calendarMonth, day);
                const dateKey = `${calendarYear}-${calendarMonth}-${day}`;
                const dayClasses = classDays[dateKey] || [];
                
                let classes = ['calendar-day'];
                if (currentDate.getTime() === today.getTime()) classes.push('today');
                if (courseStart && currentDate.getTime() === courseStart.getTime()) classes.push('course-start');
                if (courseEnd && currentDate.getTime() === courseEnd.getTime()) classes.push('course-end');
                if (dayClasses.length > 0) classes.push('has-class');
                
                // Find which week this falls in
                let weekNum = '';
                if (courseStart && currentDate >= courseStart && currentDate <= courseEnd) {
                    const diffDays = Math.floor((currentDate - courseStart) / (1000 * 60 * 60 * 24));
                    weekNum = `W${Math.floor(diffDays / 7) + 1}`;
                }
                
                // Make clickable if has classes
                const clickHandler = dayClasses.length > 0 ? `onclick="openCalendarDayClasses('${dateKey}')"` : '';
                
                html += `<div class="${classes.join(' ')}" ${clickHandler}>
                    <div class="calendar-day-number">${day}</div>
                    ${weekNum ? `<div class="calendar-week-label">${weekNum}</div>` : ''}
                    ${dayClasses.length > 0 ? `
                        <div>
                            ${dayClasses.map(c => `<span class="calendar-class-dot" style="background: ${getLevelColor(c.level)};" title="${LEVELS[c.level]} - ${c.time}" onclick="event.stopPropagation(); openClassDetails('${c.id}')"></span>`).join('')}
                        </div>
                        <div class="calendar-class-info">${dayClasses.length} class${dayClasses.length > 1 ? 'es' : ''}</div>
                    ` : ''}
                </div>`;
            }
            
            // Next month days
            const remainingCells = 42 - (startDayOfWeek + daysInMonth);
            for (let day = 1; day <= remainingCells; day++) {
                html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
            }
            
            grid.innerHTML = html;
        }
        
        function getLevelColor(level) {
            const colors = { absolute: '#ff3366', novice: '#ff9900', beginner: '#ffff00', advanced: '#39ff14' };
            return colors[level] || '#888';
        }
        
        // Store calendar class data for click handling
        let calendarClassMap = {};
        
        function openCalendarDayClasses(dateKey) {
            // If only one class on this day, open its details directly
            const dayClasses = calendarClassMap[dateKey] || [];
            if (dayClasses.length === 1) {
                openClassDetails(dayClasses[0].id);
            } else if (dayClasses.length > 1) {
                // Show modal with clickable class options
                const container = document.getElementById('calendarClassPickerList');
                container.innerHTML = dayClasses.map(c => {
                    const teacher = allTeachers.find(t => t.id === c.teacherId);
                    return `
                        <div class="calendar-class-option" onclick="closeCalendarClassPicker(); openClassDetails('${c.id}');" style="padding: 12px; background: rgba(0,255,255,0.1); border: 2px solid #00ffff; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="color: #00ffff; font-size: 10px; margin-bottom: 5px;">${c.time}</div>
                                    <span class="level-badge level-${c.level}">${LEVELS[c.level]}</span>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 8px; color: #888;">Week ${c.week || '-'}</div>
                                    ${teacher ? `<div style="font-size: 7px; color: #39ff14;">üë®‚Äçüè´ ${teacher.name}</div>` : ''}
                                    <div style="font-size: 7px; color: #ffff00;">${(c.students || []).length} students</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                document.getElementById('calendarClassPickerModal').classList.add('active');
            }
        }
        
        function closeCalendarClassPicker() {
            document.getElementById('calendarClassPickerModal').classList.remove('active');
        }

        // ==================== COMPLETED STUDENTS ====================
        
        async function loadCompletedStudents() {
            const container = document.getElementById('completedStudentsContainer');
            container.innerHTML = '<p style="color: #888; font-size: 8px;">Loading completed students...</p>';
            
            try {
                const completedStudents = allStudents.filter(s => s.status === 'completed');
                
                if (completedStudents.length === 0) {
                    container.innerHTML = '<p style="color: #888; font-size: 8px;">No completed students yet.</p>';
                    updateCompletedStats(0, 0, 0, 0);
                    return;
                }
                
                // Get community status for each student
                const communitySnap = await db.collection('scheduler_community').get();
                const communityMap = {};
                communitySnap.docs.forEach(d => {
                    communityMap[d.id] = d.data().status;
                });
                
                const total = completedStudents.length;
                const joined = completedStudents.filter(s => communityMap[s.id] === 'joined').length;
                const notInterested = completedStudents.filter(s => communityMap[s.id] === 'not-interested').length;
                const pending = total - joined - notInterested;
                
                updateCompletedStats(total, joined, notInterested, pending);
                
                const isAdmin = currentUser?.role === 'admin';
                
                container.innerHTML = completedStudents.map(s => {
                    const status = communityMap[s.id] || 'pending';
                    const cls = allClasses.find(c => c.id === s.classId);
                    
                    return `
                        <div class="completed-item ${status}">
                            <div class="completed-item-info">
                                <div class="completed-item-name">${s.name}</div>
                                <div class="completed-item-details">üìß ${s.email} | üìû ${s.phone || 'No phone'}</div>
                                ${cls ? `<div class="completed-item-class">üìö ${cls.day} @ ${cls.time} - ${LEVELS[cls.level]}</div>` : ''}
                            </div>
                            <div class="completed-item-actions">
                                ${status === 'pending' ? `
                                    <button class="community-btn join" onclick="setCommunityStatus('${s.id}', 'joined')">‚úì Joined</button>
                                    <button class="community-btn not-interested" onclick="setCommunityStatus('${s.id}', 'not-interested')">‚úó Not Interested</button>
                                ` : `
                                    <div class="community-status ${status}">${status === 'joined' ? '‚úÖ JOINED COMMUNITY' : '‚ùå NOT INTERESTED'}</div>
                                    <button class="btn btn-sm btn-secondary" onclick="setCommunityStatus('${s.id}', 'pending')">Reset</button>
                                `}
                                ${isAdmin ? `<button class="btn btn-sm btn-danger" onclick="deleteCompletedStudent('${s.id}')" style="margin-left: 5px;">üóëÔ∏è</button>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (e) { 
                console.error(e);
                container.innerHTML = `<p style="color: #ff3366; font-size: 8px;">Error: ${e.message}</p>`;
            }
        }
        
        function updateCompletedStats(total, joined, notInterested, pending) {
            document.getElementById('completedTotalCount').textContent = total;
            document.getElementById('completedJoinedCount').textContent = joined;
            document.getElementById('completedNotInterestedCount').textContent = notInterested;
            document.getElementById('completedPendingCount').textContent = pending;
        }
        
        async function setCommunityStatus(studentId, status) {
            try {
                await db.collection('scheduler_community').doc(studentId).set({
                    studentId,
                    status,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                loadCompletedStudents();
            } catch (e) { console.error(e); }
        }
        
        async function deleteCompletedStudent(studentId) {
            if (!confirm('Are you sure you want to delete this student? This action cannot be undone.')) return;
            
            try {
                // Delete from scheduler_students
                await db.collection('scheduler_students').doc(studentId).delete();
                
                // Delete from scheduler_community
                await db.collection('scheduler_community').doc(studentId).delete();
                
                // Remove from local array
                const idx = allStudents.findIndex(s => s.id === studentId);
                if (idx !== -1) allStudents.splice(idx, 1);
                
                loadCompletedStudents();
                updateDashboardStats();
                alert('Student deleted successfully.');
            } catch (e) { 
                console.error(e);
                alert('Error deleting student: ' + e.message);
            }
        }
        
        // ==================== MOVE STUDENT ====================
        
        let selectedMoveClassId = null;
        
        function openMoveStudentModal(studentId, studentName, fromClassId) {
            document.getElementById('moveStudentId').value = studentId;
            document.getElementById('moveFromClassId').value = fromClassId;
            document.getElementById('moveStudentName').textContent = studentName;
            document.getElementById('returnToPoolCheckbox').checked = false;
            selectedMoveClassId = null;
            
            renderMoveClassOptions(studentId, fromClassId);
            document.getElementById('moveToClassSection').style.display = 'block';
            document.getElementById('moveStudentModal').classList.add('active');
        }
        
        function closeMoveStudentModal() {
            document.getElementById('moveStudentModal').classList.remove('active');
        }
        
        function toggleMoveOptions() {
            const returnToPool = document.getElementById('returnToPoolCheckbox').checked;
            document.getElementById('moveToClassSection').style.display = returnToPool ? 'none' : 'block';
        }
        
        function renderMoveClassOptions(studentId, fromClassId) {
            const container = document.getElementById('moveClassOptions');
            const student = allStudents.find(s => s.id === studentId);
            
            // Show all active classes except the current one
            const availableClasses = allClasses.filter(c => c.id !== fromClassId && c.status !== 'completed');
            
            if (availableClasses.length === 0) {
                container.innerHTML = '<p style="color: #888; font-size: 8px;">No other classes available.</p>';
                return;
            }
            
            container.innerHTML = availableClasses.map(c => {
                const teacher = allTeachers.find(t => t.id === c.teacherId);
                const studentCount = (c.students || []).length;
                const isFull = studentCount >= schedulerSettings.maxStudents;
                const levelMatch = student && student.level === c.level;
                
                return `
                    <div class="move-student-class ${selectedMoveClassId === c.id ? 'selected' : ''}" onclick="selectMoveClass('${c.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="color: #00ffff; font-size: 9px;">${c.day} @ ${c.time}</div>
                                <span class="level-badge level-${c.level}">${LEVELS[c.level]}</span>
                                ${!levelMatch ? '<span style="color: #ff9900; font-size: 7px;"> ‚ö†Ô∏è Level mismatch</span>' : ''}
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 8px; color: ${isFull ? '#ff3366' : '#39ff14'};">
                                    üë• ${studentCount}/${schedulerSettings.maxStudents} ${isFull ? '(FULL)' : ''}
                                </div>
                                <div style="font-size: 7px; color: #888;">${teacher ? teacher.name : 'No teacher'}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function selectMoveClass(classId) {
            selectedMoveClassId = classId;
            document.querySelectorAll('.move-student-class').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
        }
        
        async function confirmMoveStudent() {
            const studentId = document.getElementById('moveStudentId').value;
            const fromClassId = document.getElementById('moveFromClassId').value;
            const returnToPool = document.getElementById('returnToPoolCheckbox').checked;
            
            if (returnToPool) {
                // Return student to pool for reassignment
                await returnStudentToPool(studentId, fromClassId);
            } else if (selectedMoveClassId) {
                // Move to selected class
                await moveStudentToClass(studentId, fromClassId, selectedMoveClassId);
            } else {
                alert('Please select a destination class or check "Return to pool".');
                return;
            }
            
            closeMoveStudentModal();
        }
        
        async function returnStudentToPool(studentId, fromClassId) {
            try {
                // Remove from current class
                const fromClass = allClasses.find(c => c.id === fromClassId);
                if (fromClass) {
                    const updatedStudents = (fromClass.students || []).filter(s => s.id !== studentId);
                    await db.collection('scheduler_classes').doc(fromClassId).update({ students: updatedStudents });
                    fromClass.students = updatedStudents;
                }
                
                // Update student status back to pending/limbo
                await db.collection('scheduler_students').doc(studentId).update({ 
                    status: 'pending', 
                    classId: null 
                });
                
                const idx = allStudents.findIndex(s => s.id === studentId);
                if (idx !== -1) {
                    allStudents[idx].status = 'pending';
                    allStudents[idx].classId = null;
                }
                
                renderStudentsTable();
                renderClasses();
                updateDashboardStats();
                alert('Student returned to pool for reassignment.');
            } catch (e) { 
                console.error(e);
                alert('Error: ' + e.message);
            }
        }
        
        async function moveStudentToClass(studentId, fromClassId, toClassId) {
            try {
                const student = allStudents.find(s => s.id === studentId);
                
                // Remove from current class
                const fromClass = allClasses.find(c => c.id === fromClassId);
                if (fromClass) {
                    const updatedStudents = (fromClass.students || []).filter(s => s.id !== studentId);
                    await db.collection('scheduler_classes').doc(fromClassId).update({ students: updatedStudents });
                    fromClass.students = updatedStudents;
                }
                
                // Add to new class
                const toClass = allClasses.find(c => c.id === toClassId);
                if (toClass && student) {
                    const slot = `${toClass.day}-${toClass.time}`;
                    let rank = 3; // Default to 3rd preference
                    if (student.availabilities) {
                        for (let r = 1; r <= 3; r++) {
                            if (student.availabilities[r] === slot) { rank = r; break; }
                        }
                    }
                    
                    const newStudent = { id: student.id, name: student.name, rank, timezone: student.timezone };
                    const updatedStudents = [...(toClass.students || []), newStudent];
                    await db.collection('scheduler_classes').doc(toClassId).update({ students: updatedStudents });
                    toClass.students = updatedStudents;
                    
                    // Update student record
                    await db.collection('scheduler_students').doc(studentId).update({ classId: toClassId });
                    student.classId = toClassId;
                }
                
                renderClasses();
                updateDashboardStats();
                alert('Student moved successfully!');
            } catch (e) {
                console.error(e);
                alert('Error: ' + e.message);
            }
        }
        
        // ==================== MARK COURSE COMPLETE ====================
        
        async function markCourseComplete(classId) {
            if (!confirm('Mark this class as completed? This will move all students to the Completed section and free up the time slot.')) return;
            
            try {
                const cls = allClasses.find(c => c.id === classId);
                if (!cls) return;
                
                // Update class status
                await db.collection('scheduler_classes').doc(classId).update({ status: 'completed' });
                cls.status = 'completed';
                
                // Update all students in this class to completed
                for (const student of (cls.students || [])) {
                    await db.collection('scheduler_students').doc(student.id).update({ status: 'completed' });
                    const idx = allStudents.findIndex(s => s.id === student.id);
                    if (idx !== -1) allStudents[idx].status = 'completed';
                }
                
                renderClasses();
                renderStudentsTable();
                updateDashboardStats();
                alert('Class marked as completed! Students moved to Completed section.');
            } catch (e) {
                console.error(e);
                alert('Error: ' + e.message);
            }
        }
        
        async function deleteClass(classId) {
            const cls = allClasses.find(c => c.id === classId);
            if (!cls) return;
            
            const studentCount = (cls.students || []).length;
            let confirmMsg = `Are you sure you want to DELETE this class?\n\n${cls.day} @ ${cls.time} - ${LEVELS[cls.level]}`;
            
            if (studentCount > 0) {
                confirmMsg += `\n\n‚ö†Ô∏è This class has ${studentCount} student(s). They will be returned to the student pool for reassignment.`;
            }
            
            confirmMsg += '\n\nThis action cannot be undone.';
            
            if (!confirm(confirmMsg)) return;
            
            try {
                // Return students to pool
                for (const student of (cls.students || [])) {
                    await db.collection('scheduler_students').doc(student.id).update({ 
                        status: 'pending', 
                        classId: null 
                    });
                    const idx = allStudents.findIndex(s => s.id === student.id);
                    if (idx !== -1) {
                        allStudents[idx].status = 'pending';
                        allStudents[idx].classId = null;
                    }
                }
                
                // Delete the class
                await db.collection('scheduler_classes').doc(classId).delete();
                
                // Remove from local array
                const classIdx = allClasses.findIndex(c => c.id === classId);
                if (classIdx !== -1) allClasses.splice(classIdx, 1);
                
                // Delete associated attendance records
                const attendanceSnap = await db.collection('scheduler_attendance').where('classId', '==', classId).get();
                for (const doc of attendanceSnap.docs) {
                    await doc.ref.delete();
                }
                
                renderClasses();
                renderStudentsTable();
                renderAdminSchedule();
                updateDashboardStats();
                alert('Class deleted successfully.' + (studentCount > 0 ? ` ${studentCount} student(s) returned to pool.` : ''));
            } catch (e) {
                console.error(e);
                alert('Error deleting class: ' + e.message);
            }
        }
        
        // ==================== COMMUNITY REMINDER (Week 6) ====================
        
        let communityReminderShown = false;
        
        function checkWeek6Reminder() {
            if (schedulerSettings.currentWeek === 6 && !communityReminderShown && currentUser?.role === 'teacher') {
                communityReminderShown = true;
                document.getElementById('communityReminderModal').classList.add('active');
            }
        }
        
        function closeCommunityReminderModal() {
            document.getElementById('communityReminderModal').classList.remove('active');
        }

        // ==================== ADMIN ATTENDANCE ====================
        
        async function loadAdminAttendance() {
            const container = document.getElementById('adminAttendanceContainer');
            container.innerHTML = '<p style="color: #888; font-size: 8px;">Loading attendance...</p>';
            
            // Populate class filter dropdown
            const classFilter = document.getElementById('adminAttendanceClassFilter');
            const activeClasses = allClasses.filter(c => c.status !== 'completed');
            classFilter.innerHTML = '<option value="all">All Classes</option>' + 
                activeClasses.map(c => `<option value="${c.id}">${c.day} ${c.time} - ${LEVELS[c.level]}</option>`).join('');
            
            const selectedClass = classFilter.value;
            
            try {
                // Get all attendance records
                const attendanceSnap = await db.collection('scheduler_attendance').get();
                const attendanceMap = {};
                attendanceSnap.docs.forEach(d => {
                    const data = d.data();
                    if (!attendanceMap[data.classId]) attendanceMap[data.classId] = {};
                    if (!attendanceMap[data.classId][data.studentId]) attendanceMap[data.classId][data.studentId] = {};
                    attendanceMap[data.classId][data.studentId][data.week] = data.status;
                });
                
                // Filter classes
                let classesToShow = activeClasses;
                if (selectedClass !== 'all') {
                    classesToShow = activeClasses.filter(c => c.id === selectedClass);
                }
                
                // Count stats
                let presentCount = 0, lateCount = 0, absentCount = 0, notMarkedCount = 0;
                
                let html = '';
                
                for (const cls of classesToShow) {
                    const teacher = allTeachers.find(t => t.id === cls.teacherId);
                    
                    html += `
                        <div class="card" style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <h4 style="color: #00ffff; margin: 0;">${cls.day} @ ${cls.time}</h4>
                                    <span class="level-badge level-${cls.level}">${LEVELS[cls.level]}</span>
                                    ${teacher ? `<span style="color: #39ff14; font-size: 8px; margin-left: 10px;">üë®‚Äçüè´ ${teacher.name}</span>` : ''}
                                </div>
                                <button class="btn btn-sm btn-info" onclick="openClassDetails('${cls.id}')">View Details</button>
                            </div>
                            
                            <table class="data-table" style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>W1</th>
                                        <th>W2</th>
                                        <th>W3</th>
                                        <th>W4</th>
                                        <th>W5</th>
                                        <th>W6</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    for (const student of (cls.students || [])) {
                        html += `<tr><td><span style="color: #00ffff; cursor: pointer; text-decoration: underline;" onclick="openStudentDetailsModal('${student.id}')">${student.name}</span></td>`;
                        
                        for (let w = 1; w <= 6; w++) {
                            const status = attendanceMap[cls.id]?.[student.id]?.[w];
                            let badge = '-';
                            let color = '#888';
                            
                            if (status === 'present') { badge = '‚úì'; color = '#39ff14'; presentCount++; }
                            else if (status === 'late') { badge = 'L'; color = '#ffff00'; lateCount++; }
                            else if (status === 'absent') { badge = 'A'; color = '#ff3366'; absentCount++; }
                            else { notMarkedCount++; }
                            
                            html += `<td style="text-align: center; color: ${color}; font-weight: bold;">${badge}</td>`;
                        }
                        
                        html += '</tr>';
                    }
                    
                    html += '</tbody></table></div>';
                }
                
                if (classesToShow.length === 0) {
                    html = '<p style="color: #888; font-size: 8px;">No active classes found.</p>';
                }
                
                // Update stats
                document.getElementById('adminAttendancePresent').textContent = presentCount;
                document.getElementById('adminAttendanceLate').textContent = lateCount;
                document.getElementById('adminAttendanceAbsent').textContent = absentCount;
                document.getElementById('adminAttendanceNotMarked').textContent = notMarkedCount;
                
                container.innerHTML = html;
                
            } catch (e) {
                console.error(e);
                container.innerHTML = `<p style="color: #ff3366; font-size: 8px;">Error: ${e.message}</p>`;
            }
        }
        
        // ==================== STUDENT DETAILS MODAL ====================
        
        function openStudentDetailsModal(studentId) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student) {
                alert('Student not found');
                return;
            }
            
            const cls = allClasses.find(c => c.id === student.classId);
            
            const content = document.getElementById('studentDetailsContent');
            content.innerHTML = `
                <div style="display: grid; gap: 12px;">
                    <div style="background: rgba(0,255,255,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #00ffff;">
                        <h4 style="color: #00ffff; margin: 0 0 10px 0; font-size: 12px;">${student.name}</h4>
                        <p style="font-size: 9px; color: #888; margin: 0;">Student ID: ${student.id}</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px;">
                            <p style="font-size: 7px; color: #888; margin: 0 0 5px 0;">üìß EMAIL</p>
                            <p style="font-size: 9px; color: #fff; margin: 0; word-break: break-all;">${student.email || 'Not provided'}</p>
                        </div>
                        <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px;">
                            <p style="font-size: 7px; color: #888; margin: 0 0 5px 0;">üìû PHONE</p>
                            <p style="font-size: 9px; color: #fff; margin: 0;">${student.phone || 'Not provided'}</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px;">
                            <p style="font-size: 7px; color: #888; margin: 0 0 5px 0;">üìö LEVEL</p>
                            <p style="font-size: 9px; margin: 0;"><span class="level-badge level-${student.level || 'none'}">${student.level ? LEVELS[student.level] : 'Not assigned'}</span></p>
                        </div>
                        <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px;">
                            <p style="font-size: 7px; color: #888; margin: 0 0 5px 0;">üìã STATUS</p>
                            <p style="font-size: 9px; color: ${student.status === 'assigned' ? '#39ff14' : student.status === 'completed' ? '#ff00ff' : '#ffff00'}; margin: 0;">${(student.status || 'pending').toUpperCase()}</p>
                        </div>
                    </div>
                    
                    ${cls ? `
                        <div style="background: rgba(57,255,20,0.1); padding: 12px; border-radius: 8px; border-left: 4px solid #39ff14;">
                            <p style="font-size: 7px; color: #888; margin: 0 0 5px 0;">üéì CURRENT CLASS</p>
                            <p style="font-size: 9px; color: #39ff14; margin: 0;">${cls.day} @ ${cls.time} - ${LEVELS[cls.level]}</p>
                        </div>
                    ` : ''}
                    
                    ${student.availabilities && student.availabilities.length > 0 ? `
                        <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px;">
                            <p style="font-size: 7px; color: #888; margin: 0 0 8px 0;">üìÖ AVAILABILITY</p>
                            <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                                ${student.availabilities.map(a => `<span style="background: rgba(0,255,255,0.2); color: #00ffff; padding: 3px 8px; border-radius: 4px; font-size: 7px;">${a}</span>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${student.registeredAt ? `
                        <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px;">
                            <p style="font-size: 7px; color: #888; margin: 0 0 5px 0;">üìÜ REGISTERED</p>
                            <p style="font-size: 8px; color: #fff; margin: 0;">${new Date(student.registeredAt.seconds ? student.registeredAt.seconds * 1000 : student.registeredAt).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' })}</p>
                        </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('studentDetailsModal').classList.add('active');
        }
        
        function closeStudentDetailsModal() {
            document.getElementById('studentDetailsModal').classList.remove('active');
        }
        
        // ==================== CLASS COMPLETE REMINDER (Week 6 after all marked) ====================
        
        let classCompleteReminderShownFor = new Set(); // Track which classes we've shown reminder for
        
        async function checkClassAttendanceComplete(classId) {
            // Only check if it's week 6
            if (schedulerSettings.currentWeek !== 6) return;
            
            // Don't show again for same class in this session
            if (classCompleteReminderShownFor.has(classId)) return;
            
            const cls = allClasses.find(c => c.id === classId);
            if (!cls || !cls.students || cls.students.length === 0) return;
            
            try {
                // Get all attendance records for this class in week 6
                const attendanceSnap = await db.collection('scheduler_attendance')
                    .where('classId', '==', classId)
                    .where('week', '==', 6)
                    .get();
                
                const markedStudents = new Set(attendanceSnap.docs.map(d => d.data().studentId));
                const allMarked = cls.students.every(s => markedStudents.has(s.id));
                
                if (allMarked) {
                    classCompleteReminderShownFor.add(classId);
                    document.getElementById('classCompleteReminderModal').classList.add('active');
                }
            } catch (e) {
                console.error('Error checking class attendance complete:', e);
            }
        }
        
        function closeClassCompleteReminderModal() {
            document.getElementById('classCompleteReminderModal').classList.remove('active');
        }

        // ==================== DATABASE CLEANUP ====================
        
        let cleanupIssues = {
            orphanAssigned: [],      // Students marked 'assigned' but class doesn't exist
            orphanProposed: [],      // Students marked 'proposed' but proposal doesn't exist
            invalidClassRefs: [],    // Students with classId that doesn't exist
            invalidProposalRefs: []  // Students with proposalId that doesn't exist
        };
        
        async function scanForIssues() {
            const preview = document.getElementById('cleanupPreview');
            const issuesList = document.getElementById('cleanupIssuesList');
            const cleanBtn = document.getElementById('cleanOrphansBtn');
            
            issuesList.innerHTML = '<p style="font-size: 8px; color: #888;">Scanning...</p>';
            preview.style.display = 'block';
            
            // Reset issues
            cleanupIssues = {
                orphanAssigned: [],
                orphanProposed: [],
                invalidClassRefs: [],
                invalidProposalRefs: []
            };
            
            try {
                // Load fresh data from Firebase
                const [studentsSnap, classesSnap, proposalsSnap] = await Promise.all([
                    db.collection('scheduler_students').get(),
                    db.collection('scheduler_classes').get(),
                    db.collection('scheduler_proposals').get()
                ]);
                
                const students = studentsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                const classIds = new Set(classesSnap.docs.map(d => d.id));
                const proposalIds = new Set(proposalsSnap.docs.map(d => d.id));
                
                // Check each student
                for (const student of students) {
                    // Check for assigned status with non-existent class
                    if (student.status === 'assigned') {
                        if (!student.classId || !classIds.has(student.classId)) {
                            cleanupIssues.orphanAssigned.push(student);
                        }
                    }
                    
                    // Check for proposed status with non-existent proposal
                    if (student.status === 'proposed') {
                        if (!student.proposalId || !proposalIds.has(student.proposalId)) {
                            cleanupIssues.orphanProposed.push(student);
                        }
                    }
                    
                    // Check for classId reference to non-existent class
                    if (student.classId && !classIds.has(student.classId)) {
                        cleanupIssues.invalidClassRefs.push(student);
                    }
                    
                    // Check for proposalId reference to non-existent proposal
                    if (student.proposalId && !proposalIds.has(student.proposalId)) {
                        cleanupIssues.invalidProposalRefs.push(student);
                    }
                }
                
                // Build issues report
                const totalIssues = cleanupIssues.orphanAssigned.length + 
                                   cleanupIssues.orphanProposed.length;
                
                if (totalIssues === 0) {
                    issuesList.innerHTML = '<p style="font-size: 9px; color: #39ff14;">‚úÖ No issues found! Database is clean.</p>';
                    cleanBtn.disabled = true;
                } else {
                    let html = '';
                    
                    if (cleanupIssues.orphanAssigned.length > 0) {
                        html += `
                            <div style="margin-bottom: 10px;">
                                <p style="font-size: 8px; color: #ff3366;">‚ö†Ô∏è ${cleanupIssues.orphanAssigned.length} students marked "assigned" but class doesn't exist:</p>
                                <div style="margin-left: 10px;">
                                    ${cleanupIssues.orphanAssigned.map(s => `
                                        <span style="display: inline-block; padding: 3px 8px; margin: 2px; background: rgba(255,51,102,0.2); border-radius: 10px; font-size: 7px; color: #ff3366;">
                                            ${s.name} (classId: ${s.classId || 'null'})
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                    
                    if (cleanupIssues.orphanProposed.length > 0) {
                        html += `
                            <div style="margin-bottom: 10px;">
                                <p style="font-size: 8px; color: #ffff00;">‚ö†Ô∏è ${cleanupIssues.orphanProposed.length} students marked "proposed" but proposal doesn't exist:</p>
                                <div style="margin-left: 10px;">
                                    ${cleanupIssues.orphanProposed.map(s => `
                                        <span style="display: inline-block; padding: 3px 8px; margin: 2px; background: rgba(255,255,0,0.2); border-radius: 10px; font-size: 7px; color: #ffff00;">
                                            ${s.name} (proposalId: ${s.proposalId || 'null'})
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                    
                    html += `<p style="font-size: 8px; color: #00ffff; margin-top: 10px;">Click "Clean Orphan Records" to fix these ${totalIssues} issue(s).</p>`;
                    
                    issuesList.innerHTML = html;
                    cleanBtn.disabled = false;
                }
                
            } catch (e) {
                console.error('Error scanning for issues:', e);
                issuesList.innerHTML = `<p style="font-size: 8px; color: #ff3366;">‚ùå Error: ${e.message}</p>`;
                cleanBtn.disabled = true;
            }
        }
        
        async function cleanOrphanRecords() {
            const totalIssues = cleanupIssues.orphanAssigned.length + cleanupIssues.orphanProposed.length;
            
            if (totalIssues === 0) {
                alert('No issues to clean.');
                return;
            }
            
            if (!confirm(`This will reset ${totalIssues} orphan student record(s) to "pending" status. Continue?`)) return;
            
            try {
                let fixed = 0;
                
                // Fix orphan assigned students
                for (const student of cleanupIssues.orphanAssigned) {
                    await db.collection('scheduler_students').doc(student.id).update({
                        status: 'pending',
                        classId: null
                    });
                    fixed++;
                }
                
                // Fix orphan proposed students
                for (const student of cleanupIssues.orphanProposed) {
                    await db.collection('scheduler_students').doc(student.id).update({
                        status: 'pending',
                        proposalId: null
                    });
                    fixed++;
                }
                
                showMessage('cleanupMessage', `‚úÖ Fixed ${fixed} orphan record(s). Students reset to "pending" status.`, 'success');
                
                // Reload data
                await loadAllStudents();
                await loadAllClasses();
                await loadProposals();
                
                // Clear preview
                document.getElementById('cleanupPreview').style.display = 'none';
                document.getElementById('cleanOrphansBtn').disabled = true;
                
                // Reset issues
                cleanupIssues = {
                    orphanAssigned: [],
                    orphanProposed: [],
                    invalidClassRefs: [],
                    invalidProposalRefs: []
                };
                
            } catch (e) {
                console.error('Error cleaning orphan records:', e);
                showMessage('cleanupMessage', `‚ùå Error: ${e.message}`, 'error');
            }
        }
        
        async function resetAllData() {
            if (!confirm('‚ö†Ô∏è WARNING: This will DELETE ALL students, classes, proposals, and attendance records. This cannot be undone!\n\nAre you absolutely sure?')) return;
            if (!confirm('‚ö†Ô∏è FINAL WARNING: All data will be permanently deleted. Type "DELETE" in the next prompt to confirm.')) return;
            
            const confirmation = prompt('Type "DELETE" to confirm:');
            if (confirmation !== 'DELETE') {
                alert('Reset cancelled.');
                return;
            }
            
            try {
                showMessage('cleanupMessage', 'üîÑ Deleting all data...', 'info');
                
                // Delete all students
                const studentsSnap = await db.collection('scheduler_students').get();
                for (const doc of studentsSnap.docs) {
                    await doc.ref.delete();
                }
                
                // Delete all classes
                const classesSnap = await db.collection('scheduler_classes').get();
                for (const doc of classesSnap.docs) {
                    await doc.ref.delete();
                }
                
                // Delete all proposals
                const proposalsSnap = await db.collection('scheduler_proposals').get();
                for (const doc of proposalsSnap.docs) {
                    await doc.ref.delete();
                }
                
                // Delete all attendance records
                const attendanceSnap = await db.collection('scheduler_attendance').get();
                for (const doc of attendanceSnap.docs) {
                    await doc.ref.delete();
                }
                
                // Reset local arrays
                allStudents = [];
                allClasses = [];
                allProposals = [];
                
                // Refresh UI
                renderStudentsTable();
                renderClasses();
                renderProposals();
                renderAvailableStudentsForProposals();
                updateDashboardStats();
                
                showMessage('cleanupMessage', '‚úÖ All data has been deleted.', 'success');
                document.getElementById('cleanupPreview').style.display = 'none';
                
            } catch (e) {
                console.error('Error resetting data:', e);
                showMessage('cleanupMessage', `‚ùå Error: ${e.message}`, 'error');
            }
        }

        // ==================== PROPOSALS ====================
        
        async function loadProposals() {
            try {
                const snap = await db.collection('scheduler_proposals').orderBy('createdAt', 'desc').get();
                allProposals = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderProposals();
            } catch (e) {
                console.error('Error loading proposals:', e);
            }
        }
        
        function renderProposals() {
            const container = document.getElementById('proposalsContainer');
            if (!container) return;
            
            if (allProposals.length === 0) {
                container.innerHTML = '<p style="color: #888; font-size: 8px;">No proposals yet. Use "Auto-Generate Classes" to create proposals.</p>';
                return;
            }
            
            container.innerHTML = allProposals.map(p => {
                const teacher = allTeachers.find(t => t.id === p.teacherId);
                const statusLabel = {
                    'draft': 'Draft - Select Date',
                    'sent': 'Awaiting Responses',
                    'all_agreed': 'All Students Agreed! ‚úì',
                    'has_rejections': 'Has Rejections'
                }[p.status] || p.status;
                
                const agreedCount = (p.students || []).filter(s => s.response === 'agreed').length;
                const rejectedCount = (p.students || []).filter(s => s.response === 'rejected').length;
                const pendingCount = (p.students || []).filter(s => s.response === 'pending').length;
                
                return `
                    <div class="proposal-card status-${p.status}" id="proposal-${p.id}">
                        <div class="proposal-header">
                            <div class="proposal-info">
                                <div class="proposal-day">${p.day} @ ${p.time}</div>
                                <div class="proposal-time">
                                    <span class="level-badge level-${p.level}">${LEVELS[p.level]}</span>
                                    ${teacher ? `<span style="margin-left: 10px;">üë®‚Äçüè´ ${teacher.name}</span>` : '<span style="margin-left: 10px; color: #888;">No teacher assigned</span>'}
                                </div>
                            </div>
                            <span class="proposal-status ${p.status}">${statusLabel}</span>
                        </div>
                        
                        <div class="proposal-students" 
                            ondragover="handleProposalDragOver(event)" 
                            ondragleave="handleProposalDragLeave(event)" 
                            ondrop="handleProposalDrop(event, '${p.id}')"
                            data-proposal-id="${p.id}">
                            <div style="font-size: 7px; color: #888; margin-bottom: 8px;">
                                Students: ${(p.students || []).length} 
                                ${p.status !== 'draft' ? `(‚úì ${agreedCount} | ‚úó ${rejectedCount} | ‚è≥ ${pendingCount})` : ''}
                            </div>
                            ${(p.students || []).map(s => `
                                <div class="proposal-student">
                                    <span class="proposal-student-name">${s.name}</span>
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <span class="proposal-student-response ${s.response}">${s.response === 'agreed' ? '‚úì Agreed' : s.response === 'rejected' ? '‚úó Rejected' : '‚è≥ Pending'}</span>
                                        <button class="btn btn-sm btn-danger" onclick="removeStudentFromProposal('${p.id}', '${s.id}')" title="Remove from proposal" style="padding: 2px 5px; font-size: 6px;">‚úï</button>
                                    </div>
                                </div>
                            `).join('')}
                            ${(p.students || []).length === 0 ? '<p style="color: #666; font-size: 7px; text-align: center;">Drop students here</p>' : ''}
                        </div>
                        
                        <div class="proposal-date-picker" style="${p.proposedStartDate ? 'background: rgba(57,255,20,0.1); border-color: #39ff14;' : ''}">
                            <label style="font-size: 8px; color: ${p.proposedStartDate ? '#39ff14' : '#ffff00'};">
                                üìÖ ${p.proposedStartDate ? 'Proposed Start Date:' : 'Select Proposed Start Date:'}
                            </label>
                            <input type="date" 
                                id="proposalDate-${p.id}" 
                                value="${p.proposedStartDate || ''}"
                                style="margin-left: 10px; font-family: 'Press Start 2P', cursive; font-size: 8px; padding: 5px; background: #1a1a2e; color: ${p.proposedStartDate ? '#39ff14' : '#00ffff'}; border: 1px solid ${p.proposedStartDate ? '#39ff14' : '#00ffff'}; border-radius: 4px;" 
                                onchange="updateProposalDate('${p.id}', this.value)">
                            <div class="saturday-quick-btns" style="margin-top: 8px;">
                                ${getUpcomingSaturdaysHTML(p.id, p.proposedStartDate)}
                            </div>
                        </div>
                        
                        <div class="proposal-actions">
                            ${p.proposedStartDate ? `
                                <button class="btn btn-sm btn-success" onclick="initiateProposal('${p.id}')" style="background: linear-gradient(135deg, #39ff14, #00ff88);">üöÄ Initiate Class</button>
                            ` : ''}
                            ${p.status === 'draft' && p.proposedStartDate ? `
                                <button class="btn btn-sm btn-info" onclick="sendProposalToStudents('${p.id}')">üìß Send to Students</button>
                            ` : ''}
                            <button class="btn btn-sm btn-warning" onclick="reclassProposal('${p.id}')">üîÑ ReClass</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteProposal('${p.id}')">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderAvailableStudentsForProposals() {
            const container = document.getElementById('availableStudentsForProposals');
            if (!container) return;
            
            // Get students who are not assigned, not in proposals, and have a level
            const available = allStudents.filter(s => 
                s.level && 
                s.status !== 'assigned' && 
                s.status !== 'proposed' && 
                s.status !== 'completed'
            );
            
            if (available.length === 0) {
                container.innerHTML = '<p style="color: #888; font-size: 8px;">No available students.</p>';
                return;
            }
            
            container.innerHTML = available.map(s => {
                // Check if student is a good fit for any proposal
                const isGoodFit = allProposals.some(p => {
                    if (p.level !== s.level) return false;
                    const slot = `${p.day}-${p.time}`;
                    return Object.values(s.availabilities || {}).includes(slot);
                });
                
                const availSlots = Object.entries(s.availabilities || {})
                    .map(([rank, slot]) => `${rank}: ${slot}`)
                    .join(', ');
                
                return `
                    <div class="available-student ${isGoodFit ? 'rainbow-fit' : ''}" 
                        draggable="true" 
                        ondragstart="handleAvailableStudentDragStart(event, '${s.id}')"
                        ondragend="handleAvailableStudentDragEnd(event)"
                        data-student-id="${s.id}">
                        <div class="available-student-name">${s.name} ${isGoodFit ? 'üåà' : ''}</div>
                        <div class="available-student-info">
                            <span class="level-badge level-${s.level}" style="font-size: 6px; padding: 2px 4px;">${LEVELS[s.level]}</span>
                            <span style="margin-left: 5px;">${s.status || 'pending'}</span>
                        </div>
                        <div class="available-student-info" style="margin-top: 3px; font-size: 6px; color: #666;">
                            ${availSlots || 'No availability set'}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Drag and drop for proposals
        function handleAvailableStudentDragStart(event, studentId) {
            draggedProposalStudentId = studentId;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
        }
        
        function handleAvailableStudentDragEnd(event) {
            event.target.classList.remove('dragging');
            draggedProposalStudentId = null;
        }
        
        function handleProposalDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }
        
        function handleProposalDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }
        
        async function handleProposalDrop(event, proposalId) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            if (!draggedProposalStudentId) return;
            
            const student = allStudents.find(s => s.id === draggedProposalStudentId);
            const proposal = allProposals.find(p => p.id === proposalId);
            
            if (!student || !proposal) return;
            
            // Check level match
            if (student.level !== proposal.level) {
                if (!confirm(`Level mismatch: Student is ${LEVELS[student.level]}, class is ${LEVELS[proposal.level]}. Add anyway?`)) {
                    return;
                }
            }
            
            // Check if already in this proposal
            if ((proposal.students || []).some(s => s.id === student.id)) {
                alert('Student is already in this proposal.');
                return;
            }
            
            // Check availability match
            const slot = `${proposal.day}-${proposal.time}`;
            const availRank = Object.entries(student.availabilities || {}).find(([r, s]) => s === slot)?.[0] || 3;
            
            try {
                // Add student to proposal
                const newStudent = {
                    id: student.id,
                    name: student.name,
                    email: student.email,
                    discord: student.discord || '',
                    rank: parseInt(availRank),
                    timezone: student.timezone,
                    response: proposal.status === 'draft' ? 'pending' : 'pending'
                };
                
                proposal.students = proposal.students || [];
                proposal.students.push(newStudent);
                
                await db.collection('scheduler_proposals').doc(proposalId).update({
                    students: proposal.students
                });
                
                // Update student status
                await db.collection('scheduler_students').doc(student.id).update({
                    status: 'proposed',
                    proposalId: proposalId
                });
                
                const idx = allStudents.findIndex(s => s.id === student.id);
                if (idx !== -1) {
                    allStudents[idx].status = 'proposed';
                    allStudents[idx].proposalId = proposalId;
                }
                
                renderProposals();
                renderAvailableStudentsForProposals();
            } catch (e) {
                console.error('Error adding student to proposal:', e);
                alert('Error: ' + e.message);
            }
        }
        
        async function removeStudentFromProposal(proposalId, studentId) {
            if (!confirm('Remove this student from the proposal? They will be returned to the available students list.')) return;
            
            try {
                const proposal = allProposals.find(p => p.id === proposalId);
                if (!proposal) return;
                
                proposal.students = (proposal.students || []).filter(s => s.id !== studentId);
                
                await db.collection('scheduler_proposals').doc(proposalId).update({
                    students: proposal.students
                });
                
                // Update student status back to pending/limbo
                await db.collection('scheduler_students').doc(studentId).update({
                    status: 'pending',
                    proposalId: null
                });
                
                const idx = allStudents.findIndex(s => s.id === studentId);
                if (idx !== -1) {
                    allStudents[idx].status = 'pending';
                    allStudents[idx].proposalId = null;
                }
                
                // Recalculate proposal status
                await updateProposalStatus(proposalId);
                
                renderProposals();
                renderAvailableStudentsForProposals();
            } catch (e) {
                console.error('Error removing student:', e);
                alert('Error: ' + e.message);
            }
        }
        
        async function updateProposalDate(proposalId, date) {
            try {
                await db.collection('scheduler_proposals').doc(proposalId).update({
                    proposedStartDate: date
                });
                
                const proposal = allProposals.find(p => p.id === proposalId);
                if (proposal) proposal.proposedStartDate = date;
                
                renderProposals();
            } catch (e) {
                console.error('Error updating proposal date:', e);
            }
        }
        
        async function sendProposalToStudents(proposalId) {
            const proposal = allProposals.find(p => p.id === proposalId);
            if (!proposal || !proposal.proposedStartDate) {
                alert('Please select a proposed start date first.');
                return;
            }
            
            if ((proposal.students || []).length === 0) {
                alert('No students in this proposal.');
                return;
            }
            
            // Show Discord names modal
            showDiscordNamesModal(proposal);
        }
        
        function showDiscordNamesModal(proposal) {
            const students = proposal.students || [];
            const discordNames = students.map(s => s.discord || `${s.name} (no Discord)`).join('\n');
            const startDate = new Date(proposal.proposedStartDate).toLocaleDateString('en-US', { 
                weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' 
            });
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'discordNamesModal';
            modal.innerHTML = `
                <div class="modal" style="max-width: 500px;">
                    <button class="modal-close" onclick="closeDiscordNamesModal()">‚úï</button>
                    <h3 class="modal-title">üìã Discord Names to Contact</h3>
                    <p style="font-size: 8px; color: #888; margin-bottom: 15px;">
                        Class: <span style="color: #00ffff;">${proposal.day} @ ${proposal.time}</span> | 
                        Level: <span class="level-badge level-${proposal.level}">${LEVELS[proposal.level]}</span> |
                        Start: <span style="color: #39ff14;">${startDate}</span>
                    </p>
                    
                    <div style="background: rgba(0,0,0,0.3); border: 2px solid #333; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <textarea id="discordNamesList" readonly style="width: 100%; height: 150px; background: transparent; border: none; color: #fff; font-family: 'Press Start 2P', cursive; font-size: 8px; resize: none; outline: none;">${discordNames}</textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button class="btn btn-success" onclick="copyDiscordNames()">üìã Copy All Names</button>
                        <button class="btn btn-info" onclick="confirmSendProposal('${proposal.id}')">üìß Mark as Sent</button>
                        <button class="btn btn-secondary" onclick="closeDiscordNamesModal()">Close</button>
                    </div>
                    
                    <p id="copyConfirmation" style="font-size: 8px; color: #39ff14; text-align: center; margin-top: 10px; display: none;">‚úì Copied to clipboard!</p>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function copyDiscordNames() {
            const textarea = document.getElementById('discordNamesList');
            textarea.select();
            document.execCommand('copy');
            
            // Also try modern clipboard API
            navigator.clipboard.writeText(textarea.value).catch(() => {});
            
            const confirmation = document.getElementById('copyConfirmation');
            confirmation.style.display = 'block';
            setTimeout(() => confirmation.style.display = 'none', 2000);
        }
        
        function closeDiscordNamesModal() {
            const modal = document.getElementById('discordNamesModal');
            if (modal) modal.remove();
        }
        
        async function confirmSendProposal(proposalId) {
            const proposal = allProposals.find(p => p.id === proposalId);
            if (!proposal) return;
            
            try {
                await db.collection('scheduler_proposals').doc(proposalId).update({
                    status: 'sent'
                });
                
                proposal.status = 'sent';
                closeDiscordNamesModal();
                renderProposals();
                
                alert(`Proposal marked as sent to ${proposal.students.length} students!`);
            } catch (e) {
                console.error('Error sending proposal:', e);
                alert('Error: ' + e.message);
            }
        }
        
        async function updateProposalStatus(proposalId) {
            const proposal = allProposals.find(p => p.id === proposalId);
            if (!proposal || proposal.status === 'draft') return;
            
            const students = proposal.students || [];
            const allAgreed = students.length > 0 && students.every(s => s.response === 'agreed');
            const hasRejections = students.some(s => s.response === 'rejected');
            
            let newStatus = 'sent';
            if (allAgreed) newStatus = 'all_agreed';
            else if (hasRejections) newStatus = 'has_rejections';
            
            if (newStatus !== proposal.status) {
                await db.collection('scheduler_proposals').doc(proposalId).update({ status: newStatus });
                proposal.status = newStatus;
            }
        }
        
        // Simulate student response (for testing - in production this would be done by students)
        async function simulateStudentResponse(proposalId, studentId, response) {
            try {
                const proposal = allProposals.find(p => p.id === proposalId);
                if (!proposal) return;
                
                const student = proposal.students.find(s => s.id === studentId);
                if (student) student.response = response;
                
                await db.collection('scheduler_proposals').doc(proposalId).update({
                    students: proposal.students
                });
                
                await updateProposalStatus(proposalId);
                renderProposals();
            } catch (e) {
                console.error('Error updating response:', e);
            }
        }
        
        async function proceedWithClass(proposalId) {
            const proposal = allProposals.find(p => p.id === proposalId);
            if (!proposal) return;
            
            const agreedStudents = (proposal.students || []).filter(s => s.response === 'agreed' || proposal.status === 'draft');
            
            if (agreedStudents.length < schedulerSettings.minStudents) {
                if (!confirm(`Only ${agreedStudents.length} students agreed (minimum is ${schedulerSettings.minStudents}). Proceed anyway?`)) return;
            }
            
            if (!proposal.proposedStartDate) {
                alert('Please set a start date before proceeding.');
                return;
            }
            
            try {
                // Create actual class from proposal
                const classData = {
                    day: proposal.day,
                    time: proposal.time,
                    level: proposal.level,
                    students: agreedStudents.map(s => ({
                        id: s.id,
                        name: s.name,
                        rank: s.rank,
                        timezone: s.timezone
                    })),
                    teacherId: proposal.teacherId,
                    startDate: proposal.proposedStartDate,
                    status: 'active',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const classRef = await db.collection('scheduler_classes').add(classData);
                
                // Update students to assigned status
                for (const s of agreedStudents) {
                    await db.collection('scheduler_students').doc(s.id).update({
                        status: 'assigned',
                        classId: classRef.id,
                        proposalId: null
                    });
                    
                    const idx = allStudents.findIndex(st => st.id === s.id);
                    if (idx !== -1) {
                        allStudents[idx].status = 'assigned';
                        allStudents[idx].classId = classRef.id;
                        allStudents[idx].proposalId = null;
                    }
                }
                
                // Handle rejected students - return to pending
                const rejectedStudents = (proposal.students || []).filter(s => s.response === 'rejected');
                for (const s of rejectedStudents) {
                    await db.collection('scheduler_students').doc(s.id).update({
                        status: 'pending',
                        proposalId: null
                    });
                    
                    const idx = allStudents.findIndex(st => st.id === s.id);
                    if (idx !== -1) {
                        allStudents[idx].status = 'pending';
                        allStudents[idx].proposalId = null;
                    }
                }
                
                // Delete proposal
                await db.collection('scheduler_proposals').doc(proposalId).delete();
                allProposals = allProposals.filter(p => p.id !== proposalId);
                
                // Add to classes list
                allClasses.push({ id: classRef.id, ...classData });
                
                // Update settings with start date
                schedulerSettings.startDate = proposal.proposedStartDate;
                await db.collection('scheduler_settings').doc('main').set(schedulerSettings, { merge: true });
                
                renderProposals();
                renderAvailableStudentsForProposals();
                renderClasses();
                updateDashboardStats();
                
                alert(`Class created successfully with ${agreedStudents.length} students!`);
            } catch (e) {
                console.error('Error creating class:', e);
                alert('Error: ' + e.message);
            }
        }
        
        async function initiateProposal(proposalId) {
            const proposal = allProposals.find(p => p.id === proposalId);
            if (!proposal) return;
            
            if (!proposal.proposedStartDate) {
                alert('Please set a start date before initiating this class.');
                return;
            }
            
            const students = proposal.students || [];
            if (students.length === 0) {
                alert('No students in this proposal.');
                return;
            }
            
            const startDateFormatted = new Date(proposal.proposedStartDate).toLocaleDateString('en-US', {
                weekday: 'short', month: 'short', day: 'numeric', year: 'numeric'
            });
            
            if (!confirm(`Initiate class?\n\nüìÖ ${proposal.day} @ ${proposal.time}\nüìö ${LEVELS[proposal.level]}\nüë• ${students.length} students\nüóìÔ∏è Starting: ${startDateFormatted}\n\nThis will create the class and add it to the schedule.`)) return;
            
            try {
                // Create actual class from proposal
                const classData = {
                    day: proposal.day,
                    time: proposal.time,
                    level: proposal.level,
                    students: students.map(s => ({
                        id: s.id,
                        name: s.name,
                        rank: s.rank,
                        timezone: s.timezone
                    })),
                    teacherId: proposal.teacherId,
                    startDate: proposal.proposedStartDate,
                    status: 'active',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const classRef = await db.collection('scheduler_classes').add(classData);
                
                // Update students to assigned status
                for (const s of students) {
                    await db.collection('scheduler_students').doc(s.id).update({
                        status: 'assigned',
                        classId: classRef.id,
                        proposalId: null
                    });
                    
                    const idx = allStudents.findIndex(st => st.id === s.id);
                    if (idx !== -1) {
                        allStudents[idx].status = 'assigned';
                        allStudents[idx].classId = classRef.id;
                        allStudents[idx].proposalId = null;
                    }
                }
                
                // Delete proposal
                await db.collection('scheduler_proposals').doc(proposalId).delete();
                allProposals = allProposals.filter(p => p.id !== proposalId);
                
                // Add to classes list
                allClasses.push({ id: classRef.id, ...classData });
                
                // Update settings with start date if not already set
                if (!schedulerSettings.startDate || proposal.proposedStartDate < schedulerSettings.startDate) {
                    schedulerSettings.startDate = proposal.proposedStartDate;
                    await db.collection('scheduler_settings').doc('main').set(schedulerSettings, { merge: true });
                }
                
                renderProposals();
                renderAvailableStudentsForProposals();
                renderClasses();
                renderCourseCalendar();
                updateDashboardStats();
                
                alert(`‚úÖ Class initiated successfully!\n\n${proposal.day} @ ${proposal.time} with ${students.length} students has been added to the schedule.`);
                
            } catch (e) {
                console.error('Error initiating proposal:', e);
                alert('Error: ' + e.message);
            }
        }
        
        async function reclassProposal(proposalId) {
            if (!confirm('This will disband the group and return all students to the available list. Continue?')) return;
            
            try {
                const proposal = allProposals.find(p => p.id === proposalId);
                if (!proposal) return;
                
                // Return all students to pending
                for (const s of (proposal.students || [])) {
                    await db.collection('scheduler_students').doc(s.id).update({
                        status: 'pending',
                        proposalId: null
                    });
                    
                    const idx = allStudents.findIndex(st => st.id === s.id);
                    if (idx !== -1) {
                        allStudents[idx].status = 'pending';
                        allStudents[idx].proposalId = null;
                    }
                }
                
                // Delete proposal
                await db.collection('scheduler_proposals').doc(proposalId).delete();
                allProposals = allProposals.filter(p => p.id !== proposalId);
                
                renderProposals();
                renderAvailableStudentsForProposals();
                renderStudentsTable();
                updateDashboardStats();
            } catch (e) {
                console.error('Error reclassing proposal:', e);
                alert('Error: ' + e.message);
            }
        }
        
        async function deleteProposal(proposalId) {
            if (!confirm('Delete this proposal? Students will be returned to the available list.')) return;
            await reclassProposal(proposalId);
        }

        // ==================== SUGGESTIONS ====================
        
        let selectedPriority = '';
        
        function selectPriority(priority) {
            selectedPriority = priority;
            document.getElementById('suggestionPriority').value = priority;
            
            // Update button styles
            ['priorityHigh', 'priorityMid', 'priorityLow'].forEach(id => {
                document.getElementById(id).classList.remove('selected');
            });
            
            const btnId = priority === 'high' ? 'priorityHigh' : priority === 'mid' ? 'priorityMid' : 'priorityLow';
            document.getElementById(btnId).classList.add('selected');
        }
        
        async function submitSuggestion() {
            const title = document.getElementById('suggestionTitle').value.trim();
            const description = document.getElementById('suggestionDescription').value.trim();
            const priority = document.getElementById('suggestionPriority').value;
            
            if (!title) { showMessage('suggestionFormMessage', 'Please enter a title', 'error'); return; }
            if (!description) { showMessage('suggestionFormMessage', 'Please enter a description', 'error'); return; }
            if (!priority) { showMessage('suggestionFormMessage', 'Please select a priority level', 'error'); return; }
            
            // Get teacher ID (stored as odId for teachers)
            const teacherId = currentUser.odId || currentUser.id || currentUser.uid;
            
            try {
                await db.collection('scheduler_suggestions').add({
                    title,
                    description,
                    priority,
                    status: 'pending',
                    teacherId: teacherId,
                    teacherName: currentUser.name,
                    adminResponse: null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    respondedAt: null
                });
                
                showMessage('suggestionFormMessage', 'Suggestion submitted successfully!', 'success');
                
                // Reset form
                document.getElementById('suggestionTitle').value = '';
                document.getElementById('suggestionDescription').value = '';
                document.getElementById('suggestionPriority').value = '';
                selectedPriority = '';
                ['priorityHigh', 'priorityMid', 'priorityLow'].forEach(id => {
                    document.getElementById(id).classList.remove('selected');
                });
                
                // Reload suggestions list
                loadTeacherSuggestions();
            } catch (e) {
                showMessage('suggestionFormMessage', 'Error: ' + e.message, 'error');
            }
        }
        
        async function loadTeacherSuggestions() {
            const container = document.getElementById('teacherSuggestionsContainer');
            if (!container || !currentUser) return;
            
            // Get teacher ID (stored as odId for teachers)
            const teacherId = currentUser.odId || currentUser.id || currentUser.uid;
            
            try {
                const snap = await db.collection('scheduler_suggestions')
                    .where('teacherId', '==', teacherId)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                if (snap.empty) {
                    container.innerHTML = '<p style="color: #888; font-size: 8px;">No suggestions submitted yet.</p>';
                    return;
                }
                
                container.innerHTML = snap.docs.map(doc => {
                    const s = doc.data();
                    const date = s.createdAt ? new Date(s.createdAt.toDate()).toLocaleDateString() : 'N/A';
                    const priorityLabel = s.priority === 'high' ? 'üî¥ High' : s.priority === 'mid' ? 'üü° Mid' : 'üü¢ Low';
                    const statusLabel = s.status === 'pending' ? 'Pending Review' : s.status === 'approved' ? 'Approved ‚úì' : 'Declined';
                    
                    return `
                        <div class="suggestion-card priority-${s.priority}">
                            <div class="suggestion-header">
                                <div class="suggestion-title">${s.title}</div>
                                <span class="suggestion-priority ${s.priority}">${priorityLabel}</span>
                            </div>
                            <div class="suggestion-body">${s.description}</div>
                            <div class="suggestion-meta">
                                <span>Submitted: ${date}</span>
                                <span class="suggestion-status ${s.status}">${statusLabel}</span>
                            </div>
                            ${s.adminResponse ? `
                                <div style="margin-top: 10px; padding: 10px; background: rgba(0,255,255,0.1); border-radius: 5px;">
                                    <p style="font-size: 7px; color: #00ffff; margin-bottom: 5px;">üì¨ Admin Response:</p>
                                    <p style="font-size: 8px; color: #ccc;">${s.adminResponse}</p>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error('Error loading teacher suggestions:', e);
                container.innerHTML = '<p style="color: #ff3366; font-size: 8px;">Error loading suggestions.</p>';
            }
        }
        
        async function loadAdminSuggestions() {
            const container = document.getElementById('adminSuggestionsContainer');
            if (!container) return;
            
            try {
                const snap = await db.collection('scheduler_suggestions')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                if (snap.empty) {
                    container.innerHTML = '<p style="color: #888; font-size: 8px;">No suggestions yet.</p>';
                    return;
                }
                
                container.innerHTML = snap.docs.map(doc => {
                    const s = doc.data();
                    const date = s.createdAt ? new Date(s.createdAt.toDate()).toLocaleDateString() : 'N/A';
                    const priorityLabel = s.priority === 'high' ? 'üî¥ High' : s.priority === 'mid' ? 'üü° Mid' : 'üü¢ Low';
                    const statusLabel = s.status === 'pending' ? 'Pending Review' : s.status === 'approved' ? 'Approved ‚úì' : 'Declined';
                    
                    return `
                        <div class="suggestion-card priority-${s.priority}">
                            <div class="suggestion-header">
                                <div class="suggestion-title">${s.title}</div>
                                <span class="suggestion-priority ${s.priority}">${priorityLabel}</span>
                            </div>
                            <div class="suggestion-body">${s.description}</div>
                            <div class="suggestion-meta">
                                <span>üë®‚Äçüè´ ${s.teacherName} ‚Ä¢ ${date}</span>
                                <span class="suggestion-status ${s.status}">${statusLabel}</span>
                            </div>
                            ${s.status === 'pending' ? `
                                <div class="suggestion-actions">
                                    <button class="btn btn-sm btn-success" onclick="respondToSuggestion('${doc.id}', 'approved')">‚úì Approve</button>
                                    <button class="btn btn-sm btn-danger" onclick="respondToSuggestion('${doc.id}', 'declined')">‚úó Decline</button>
                                </div>
                            ` : `
                                ${s.adminResponse ? `
                                    <div style="margin-top: 10px; padding: 10px; background: rgba(0,255,255,0.1); border-radius: 5px;">
                                        <p style="font-size: 7px; color: #00ffff; margin-bottom: 5px;">üì¨ Your Response:</p>
                                        <p style="font-size: 8px; color: #ccc;">${s.adminResponse}</p>
                                    </div>
                                ` : ''}
                            `}
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error('Error loading admin suggestions:', e);
                container.innerHTML = '<p style="color: #ff3366; font-size: 8px;">Error loading suggestions.</p>';
            }
        }
        
        async function respondToSuggestion(suggestionId, status) {
            let adminResponse = '';
            
            if (status === 'approved') {
                adminResponse = prompt('Add a message (optional):', 'Approved! We will work on this.');
                if (adminResponse === null) return; // Cancelled
                if (!adminResponse) adminResponse = 'Approved! We will work on this.';
            } else {
                adminResponse = prompt('Reason for declining:', 'After careful consideration, it would take too many resources for this.');
                if (adminResponse === null) return; // Cancelled
                if (!adminResponse) adminResponse = 'After careful consideration, it would take too many resources for this.';
            }
            
            try {
                await db.collection('scheduler_suggestions').doc(suggestionId).update({
                    status,
                    adminResponse,
                    respondedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                loadAdminSuggestions();
            } catch (e) {
                console.error('Error responding to suggestion:', e);
                alert('Error: ' + e.message);
            }
        }

        // ==================== VIDEO RECORDING ====================
        
        let mediaRecorder = null;
        let recordedChunks = [];
        let recordingStream = null;
        let recordingTimer = null;
        let recordingSeconds = 0;
        let isRecording = false;
        
        function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }
        
        async function startRecording() {
            if (isRecording) return;
            
            try {
                // Request camera and microphone access with 720p
                recordingStream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    },
                    audio: true
                });
                
                // Show preview
                const preview = document.getElementById('videoPreview');
                const playback = document.getElementById('videoPlayback');
                preview.srcObject = recordingStream;
                preview.style.display = 'block';
                playback.style.display = 'none';
                
                // Setup recorder
                recordedChunks = [];
                mediaRecorder = new MediaRecorder(recordingStream, { mimeType: 'video/webm' });
                
                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) recordedChunks.push(e.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    await uploadRecording(blob);
                };
                
                mediaRecorder.start();
                isRecording = true;
                
                // Update UI
                const btn = document.getElementById('recordBtn');
                btn.className = 'record-btn recording';
                btn.textContent = '‚èπÔ∏è STOP RECORDING';
                document.getElementById('recordingSection').classList.add('recording');
                document.getElementById('recordingStatus').textContent = 'Recording in progress... Click button to stop.';
                
                // Start timer with 1-minute limit
                recordingSeconds = 0;
                document.getElementById('recordingTimer').style.display = 'block';
                updateRecordingTimer();
                recordingTimer = setInterval(() => {
                    recordingSeconds++;
                    updateRecordingTimer();
                    
                    // Auto-stop at 1 minute
                    if (recordingSeconds >= 60) {
                        stopRecording();
                    }
                }, 1000);
                
            } catch (err) {
                console.error('Error starting recording:', err);
                alert('Could not access camera/microphone. Please allow access and try again.');
            }
        }
        
        function stopRecording() {
            if (!isRecording || !mediaRecorder) return;
            
            isRecording = false;
            mediaRecorder.stop();
            
            // Stop all tracks
            if (recordingStream) {
                recordingStream.getTracks().forEach(track => track.stop());
            }
            
            // Stop timer
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }
            
            // Update UI
            const btn = document.getElementById('recordBtn');
            btn.className = 'record-btn start';
            btn.textContent = 'üé§ RE-RECORD';
            document.getElementById('recordingSection').classList.remove('recording');
            document.getElementById('videoPreview').style.display = 'none';
            document.getElementById('recordingStatus').textContent = 'Processing video...';
        }
        
        function updateRecordingTimer() {
            const mins = Math.floor(recordingSeconds / 60).toString().padStart(2, '0');
            const secs = (recordingSeconds % 60).toString().padStart(2, '0');
            document.getElementById('recordingTimer').textContent = `${mins}:${secs} / 01:00`;
        }
        
        async function uploadRecording(blob) {
            try {
                document.getElementById('recordingStatus').textContent = 'Uploading video...';
                
                // Generate unique filename
                const filename = `recordings/${Date.now()}_${Math.random().toString(36).substr(2, 9)}.webm`;
                const storageRef = firebase.storage().ref().child(filename);
                
                // Upload to Firebase Storage
                const snapshot = await storageRef.put(blob);
                const downloadUrl = await snapshot.ref.getDownloadURL();
                
                // Store URL in hidden field
                document.getElementById('studentVideoUrl').value = downloadUrl;
                
                // Show playback
                const playback = document.getElementById('videoPlayback');
                playback.src = downloadUrl;
                playback.style.display = 'block';
                
                document.getElementById('recordingStatus').innerHTML = '<span style="color: #39ff14;">‚úÖ Video uploaded successfully!</span>';
                document.getElementById('recordingTimer').style.display = 'none';
                
            } catch (err) {
                console.error('Error uploading recording:', err);
                document.getElementById('recordingStatus').innerHTML = '<span style="color: #ff3366;">‚ùå Upload failed. Please try again.</span>';
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => { 
            renderAvailabilityGrid();
            
            // Add event listener for split timezone select
            const splitTimezoneSelect = document.getElementById('splitTimezoneSelect');
            if (splitTimezoneSelect) {
                splitTimezoneSelect.addEventListener('change', renderAvailabilityGrid);
            }
            
            // Add event listener for manual timezone select
            const studentTimezone = document.getElementById('studentTimezone');
            if (studentTimezone) {
                studentTimezone.addEventListener('change', renderAvailabilityGrid);
            }
        });
    </script>
</body>
</html>
